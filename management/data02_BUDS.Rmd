---
title: "Data prep script 2: Importing ERP data"
author: "Brent Rappaport"
date: "`r format(Sys.time(),  '%Y-%m-%d')`"
output:
  pdf_document: default
  html_document:
    df_print: paged
subtitle: Template Rmd
editor_options:
  chunk_output_type: console
toc: yes
---

# About
This script imports ERP data from Chatroom task (Social Processing task) and calculates split-half reliability from PREDICT project collaboration between Northwestern (PI: Shankman) and Columbia (PI: Auerbach).

# Get Setup
## Clear everything & set width
```{r}
knitr::opts_chunk$set(set.seed(312), echo=FALSE, results='hide', message=FALSE, warning=FALSE, error=FALSE)
    options(width=80) #Set width
    rm(list=ls())     #Remove everything from environment
    cat("\014")       #Clear Console
```

## Load Libraries
```{r}
  library(knitr)      #allows rmarkdown files
  library(haven)      #helps import stata
  library(questionr)  #allows lookfor function
  library(broom)      #nice statistical output
  library(here)       #nice file paths
  library(expss)      #labeling variables/values
  library(psych)      #used for statistical analyses
  library(ggplot2)    #creates plots
  library(MASS)
  library(papaja)     #generate APA documents
  library(Hmisc)
  library(misty)      #ordinal Cronbach's alpha
  library(lavaan)     #SEM
  library(papaja)
  library(pscl)       # for zero inflated models
  library(lme4)
  library(lmerTest)
  library(bbmle)
  library(marginaleffects)
  library(confintr)
  library(bestNormalize) # for normalizing data
  library(tidyverse)  #plotting/cleaning, etc.
  library(workflowr)  #helps with workflow

select <- dplyr::select
here <- here::here
```

## Get the Working Directory
```{r}
here::i_am("./management/data03_BUDS.Rmd")
# Set import directory
erp_data_dir <- here::here("data/eeg_processing/")
```

## Subjects
```{r}
subjects <- c(1000,
1001,
1002,
1004,
1006,
1008,
1009,
1010,
1012,
1014,
1017,
1021,
1022,
1023,
1024,
1025,
1026,
1027,
1029,
1030,
1031,
1033,
1035,
1036,
1037,
1039,
1040,
1041,
1043,
1044,
1046,
1047,
1048,
1049,
1050,
1052,
1053,
1054,
1055,
1057,
1058,
1059,
1060,
1061,
1063,
1064,
1065,
1066,
1067,
1068,
1069,
1070,
1071,
1072,
1073,
1074,
1075,
1077,
1078,
1079,
1080,
1081,
1082,
1084,
1085,
1086,
1087,
1088,
1089,
1090,
1091,
1094,
1095,
1096,
1097,
1098,
1099,
1100,
1101,
1102,
1103,
1104,
1105,
1106,
1107,
1108,
1109,
1110,
1111,
1112,
1113,
1114,
1115,
1116,
1117,
1118,
1119,
1120,
1121,
1122,
1123,
1124,
1125,
1126,
9001,
9003,
9004,
9005,
9006,
9007,
9008,
9010,
9013,
9014,
9015,
9017,
9018,
9019,
9020,
9021,
9022,
9024,
9026,
9027,
9028,
9030,
9031,
9033,
9034,
9035,
9037,
9038,
9039,
9040,
9042,
9043,
9044,
9045,
9046,
9048,
9049,
9050,
9051,
9052,
9053,
9055,
9056,
9057,
9059,
9060,
9061,
9062,
9063,
9067,
9068,
9069,
9070,
9072,
9075,
9076,
9077,
9078,
9079,
9080,
9081,
9082,
9083,
9084,
9085,
9087,
9088,
9089,
9091,
9092,
9093,
9094,
9096,
9097,
9098,
9099,
9100
)

segments <- read.csv(paste0(erp_data_dir, "SegmentCount/summary_erp_bin_RewP.csv"))

subjects_150275 <- segments %>%
  dplyr::filter(Acc_Acc < 13 | Acc_Rej < 11) %>%
  select(subject)
subjects_150275 <- setdiff(subjects, subjects_150275$subject)

subjects_275425 <- segments %>%
  dplyr::filter(Acc_Acc < 15 | Acc_Rej < 13) %>%
  select(subject)
subjects_275425 <- setdiff(subjects, subjects_275425$subject)

# unique(c(subjects_150275$subject,subjects_275425$subject))
# segments[segments$subject==1025,]
```


# Load raw ERP data
```{r, eval=FALSE}
channels_oldmontage <- c("Fp1", "Fz", "F3", "F7", "FT9", "FC5", "FC1", 
              "C3", "TP9", "CP5", "CP1", 
              "Pz", "P3", "P7", "CPz", "Oz", "POz", "P4", "P8", "TP10", 
              "CP6", "CP2", "Cz", "C4", "AFz", 
              "FT10", "FC6", "FC2", "F4", "F8", "Fp2", "FCz")
channels <- c("Fp1", "Fz", "F3", "F7", "FT9", "PO7", "FC1", 
              "C3", "TP9", "CP5", "CP1", 
              "Pz", "P3", "P7", "CPz", "Oz", "POz", "P4", "P8", "TP10", 
              "CP6", "CP2", "Cz", "C4", "AFz", 
              "FT10", "PO8", "FC2", "F4", "F8", "Fp2", "FCz")
time_windows <- c("50150", "150275", "275425")

for ( t in time_windows) {
  eval(parse(text=paste0('df_',t,' <- as.data.frame(NA)')))
  for (s in subjects) {
    tryCatch({
    ifelse(s < 1009 | (s > 9000 & s < 9006),
         eval(parse(text=paste0(
     'df_',s,'_',t,' <- as.data.frame(read.csv(here::here(paste0(erp_data_dir,"Results/subj_erp_Feedback/',s,'_component_',t,'.csv")), header=FALSE))
     colnames(df_',s,'_',t,') <- c("Acc_Acc","Acc_Rej","Rej_Acc","Rej_Rej","Acc_All","Rej_All")
     df_',s,'_',t,'$ID <- rep(',s,', 32)
     df_',s,'_',t,'$Channel <- channels_oldmontage
     df_',t,' <- bind_rows(df_',t,',df_',s,'_',t,')
     print(paste0("Done with subject ", s))'
     )))
     ,
   eval(parse(text=paste0(
     'df_',s,'_',t,' <- as.data.frame(read.csv(here::here(paste0(erp_data_dir,"Results/subj_erp_Feedback/',s,'_component_',t,'.csv")), header=FALSE))
     colnames(df_',s,'_',t,') <- c("Acc_Acc","Acc_Rej","Rej_Acc","Rej_Rej","Acc_All","Rej_All")
     df_',s,'_',t,'$ID <- rep(',s,', 32)
     df_',s,'_',t,'$Channel <- channels
     df_',t,' <- bind_rows(df_',t,',df_',s,'_',t,')
     print(paste0("Done with subject ", s))'
     )))
    )
    }, error=function(e){cat("ERROR : For subject ",s, "; ", conditionMessage(e), "\n")})
  }
}

# Load Even and Odd trials
for (t in time_windows) {
  eval(parse(text=paste0('df_even_',t,' <- as.data.frame(NA)')))
  eval(parse(text=paste0('df_odd_',t,' <- as.data.frame(NA)')))
  print(paste0("***********Loading data from time window ",t," now***********"))
  for (s in subjects) {
    tryCatch({
   eval(parse(text=paste0('
     print(paste0("Load subject ",s,"_even data now"))
     df_even_',s,'_',t,' <- as.data.frame(
     read.delim(here::here(paste0(erp_data_dir,"Results/subj_erp_Feedback/split_half/even/',s,'_component_',t,'.txt")), 
                header=TRUE))
     df_even_',s,'_',t,'$ID <- rep(',s,', 1)
     df_even_',t,' <- bind_rows(df_even_',t,',df_even_',s,'_',t,')'
     )))
   eval(parse(text=paste0('
   print(paste0("Load subject ",s,"_odd data now"))
     df_odd_',s,'_',t,' <- as.data.frame(read.delim(here::here(paste0(erp_data_dir,"Results/subj_erp_Feedback/split_half/odd/',s,'_component_',t,'.txt")), header=TRUE))
     df_odd_',s,'_',t,'$ID <- rep(',s,', 1)
     df_odd_',t,' <- bind_rows(df_odd_',t,',df_odd_',s,'_',t,')'
     )))
    }, error=function(e){cat("ERROR : For subject ",s, "; ", conditionMessage(e), "\n")})
  }
}

df_150275 <- filter(df_150275, ID %in% subjects_150275)
df_even_150275 <- filter(df_even_150275, ID %in% subjects_150275)
df_odd_150275 <- filter(df_odd_150275, ID %in% subjects_150275)

df_275425 <- filter(df_275425, ID %in% subjects_275425)
df_even_275425 <- filter(df_even_275425, ID %in% subjects_275425)
df_odd_275425 <- filter(df_odd_275425, ID %in% subjects_275425)

# load(file=here::here("./data/ERP_data.RData"))
save(df_50150, df_150275, df_275425,
     df_even_50150, df_even_150275, df_even_275425,
     df_odd_50150, df_odd_150275, df_odd_275425,
     file=here::here("./data/ERP_data.RData"))
```

# Load ERP data
```{r}
load(here::here("./data/ERP_data.RData"))
```

# Split-half
## Even
```{r}
df_even_50150_fz <- df_even_50150 %>%
  dplyr::select(ID, contains("_Fz"))
colnames(df_even_50150_fz) <- c("ID","Acc_Acc","Acc_Rej","Rej_Acc","Rej_Rej","Acc_All","Rej_All")
df_even_50150_fz <- df_even_50150_fz[,1:7] %>%
  # full_join(BUDS_cleaning05, by="ID") %>%
  filter(!is.na(Acc_All)) %>%
  mutate(A_all = stdres(lm(Acc_All ~ Rej_All, .)),
         AA_AR = stdres(lm(Acc_Acc ~ Acc_Rej, .)),
         AR_AA = stdres(lm(Acc_Rej ~ Acc_Acc, .)))

df_even_150275_cz <- df_even_150275 %>%
  dplyr::select(ID, contains("_Cz"))
colnames(df_even_150275_cz) <- c("ID","Acc_Acc","Acc_Rej","Rej_Acc","Rej_Rej","Acc_All","Rej_All")
df_even_150275_cz <- df_even_150275_cz[,1:7] %>%
  # full_join(BUDS_cleaning05, by="ID") %>%
  filter(!is.na(Acc_All)) %>%
  mutate(A_all = stdres(lm(Acc_All ~ Rej_All, .)),
         AA_AR = stdres(lm(Acc_Acc ~ Acc_Rej, .)),
         AR_AA = stdres(lm(Acc_Rej ~ Acc_Acc, .)))

df_even_275425_pz <- df_even_275425 %>%
  dplyr::select(ID, contains("_Pz"))
colnames(df_even_275425_pz) <- c("ID","Acc_Acc","Acc_Rej","Rej_Acc","Rej_Rej","Acc_All","Rej_All")
df_even_275425_pz <- df_even_275425_pz[,1:7] %>%
  # full_join(BUDS_cleaning05, by="ID") %>%
  filter(!is.na(Acc_All)) %>%
  mutate(A_all = stdres(lm(Acc_All ~ Rej_All, .)),
         AA_AR = stdres(lm(Acc_Acc ~ Acc_Rej, .)),
         AR_AA = stdres(lm(Acc_Rej ~ Acc_Acc, .)))
```

## Odd
```{r}
df_odd_50150_fz <- df_odd_50150 %>%
  dplyr::select(ID, contains("_Fz"))
colnames(df_odd_50150_fz) <- c("ID","Acc_Acc","Acc_Rej","Rej_Acc","Rej_Rej","Acc_All","Rej_All")
df_odd_50150_fz <- df_odd_50150_fz[,1:7] %>%
  # full_join(BUDS_cleaning05, by="ID") %>%
  filter(!is.na(Acc_All)) %>%
  mutate(A_all = stdres(lm(Acc_All ~ Rej_All, .)),
         AA_AR = stdres(lm(Acc_Acc ~ Acc_Rej, .)),
         AR_AA = stdres(lm(Acc_Rej ~ Acc_Acc, .)))

df_odd_150275_cz <- df_odd_150275 %>%
  dplyr::select(ID, contains("_Cz"))
colnames(df_odd_150275_cz) <- c("ID","Acc_Acc","Acc_Rej","Rej_Acc","Rej_Rej","Acc_All","Rej_All")
df_odd_150275_cz <- df_odd_150275_cz[,1:7] %>%
  # full_join(BUDS_cleaning05, by="ID") %>%
  filter(!is.na(Acc_All)) %>%
  mutate(A_all = stdres(lm(Acc_All ~ Rej_All, .)),
         AA_AR = stdres(lm(Acc_Acc ~ Acc_Rej, .)),
         AR_AA = stdres(lm(Acc_Rej ~ Acc_Acc, .)))

df_odd_275425_pz <- df_odd_275425 %>%
  dplyr::select(ID, contains("_Pz"))
colnames(df_odd_275425_pz) <- c("ID","Acc_Acc","Acc_Rej","Rej_Acc","Rej_Rej","Acc_All","Rej_All")
df_odd_275425_pz <- df_odd_275425_pz[,1:7] %>%
  # full_join(BUDS_cleaning05, by="ID") %>%
  filter(!is.na(Acc_All)) %>%
  mutate(A_all = stdres(lm(Acc_All ~ Rej_All, .)),
         AA_AR = stdres(lm(Acc_Acc ~ Acc_Rej, .)),
         AR_AA = stdres(lm(Acc_Rej ~ Acc_Acc, .)))
```

## Compute
```{r}
compute_split_half <- function(time_window, component) {
  for (contrast in c("Acc_Acc","Acc_Rej","Rej_Acc","Rej_Rej","Acc_All","Rej_All","A_all","AA_AR","AR_AA")){
    eval(parse(text=paste0('
    r_half_',time_window,'',contrast,' <- cor(df_even_',time_window,'_',component,'$',contrast,', df_odd_',time_window,'_',component,'$',contrast,', method="spearman", use="pairwise")
    r_half_',time_window,'ci_',contrast,' <- ci_cor(df_even_',time_window,'_',component,'$',contrast,', df_odd_',time_window,'_',component,'$',contrast,', method="spearman", type = "bootstrap", R=1000)
    r_sb_',time_window,'_cilower_',contrast,' <<- (2*r_half_',time_window,'ci_',contrast,'$interval[1])/(1+r_half_',time_window,'ci_',contrast,'$interval[1])
    r_sb_',time_window,'_ciupper_',contrast,' <<- (2*r_half_',time_window,'ci_',contrast,'$interval[2])/(1+r_half_',time_window,'ci_',contrast,'$interval[2])
    r_sb_',time_window,'_',contrast,' <<- (2*r_half_',time_window,'',contrast,')/(1+r_half_',time_window,'',contrast,')
    ')))
}
}

compute_split_half("50150","fz")
compute_split_half("150275","cz")
compute_split_half("275425","pz")

spearman_brown <- data.frame(Time_windows=c("Fz 50-150ms","Cz 150-275ms","Pz 275-425ms"))
spearman_brown$Acc_Acc <- c(r_sb_50150_Acc_Acc,r_sb_150275_Acc_Acc,r_sb_275425_Acc_Acc)
spearman_brown$Acc_Rej <- c(r_sb_50150_Acc_Rej,r_sb_150275_Acc_Rej,r_sb_275425_Acc_Rej)
spearman_brown$Rej_Acc <- c(r_sb_50150_Rej_Acc,r_sb_150275_Rej_Acc,r_sb_275425_Rej_Acc)
spearman_brown$Rej_Rej <- c(r_sb_50150_Rej_Rej,r_sb_150275_Rej_Rej,r_sb_275425_Rej_Rej)
spearman_brown$AA_AR <- c(r_sb_50150_AA_AR,r_sb_150275_AA_AR,r_sb_275425_AA_AR)
spearman_brown$AR_AA <- c(r_sb_50150_AR_AA,r_sb_150275_AR_AA,r_sb_275425_AR_AA)
spearman_brown[,2:ncol(spearman_brown)] <- round(spearman_brown[,2:ncol(spearman_brown)],2)
```

# Save files
```{r}
save(df_150275,
     df_50150,
     df_275425,
     file=here::here("./data/BUDS_data02_ERP.RData"))

save(df_even_50150_fz, df_even_150275_cz, df_even_275425_pz, file=here::here("./data/BUDS_split_half_even.RData"))
save(df_odd_50150_fz, df_odd_150275_cz, df_odd_275425_pz, file=here::here("./data/BUDS_split_half_odd.RData"))

write.csv(spearman_brown, here::here("tables/spearman_brown.csv"))
```
