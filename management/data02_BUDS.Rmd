---
title: "Data prep script 2: Filtering and scoring self-report data"
author: "Brent Rappaport"
date: "`r format(Sys.time(),  '%Y-%m-%d')`"
output:
  pdf_document: default
  html_document:
    df_print: paged
subtitle: Template Rmd
editor_options:
  chunk_output_type: console
toc: yes
---

# About
This script filter and scores the self-report data from BUDS study: Bullying, Unsupportive family/peers, Discrimination, and Social feedback study using data from PREDICT project collaboration between Northwestern (PI: Shankman) and Columbia (PI: Auerbach).

# 1. Get Setup
## 1.1. Clear everything & set width
```{r}
knitr::opts_chunk$set(echo=TRUE, results='hide', message=FALSE, set.seed(312))
    options(width=80) #Set width
    rm(list=ls())     #Remove everything from environment
    cat("\014")       #Clear Console
```

## 1.2. Load Libraries
```{r echo=TRUE, results='hide', message=FALSE}
  library(knitr)      #allows rmarkdown files
  library(haven)      #helps import stata
  library(questionr)  #allows lookfor function
  library(tidyverse)  #plotting/cleaning, etc.
  library(broom)      #nice statistical output
  library(here)       #nice file paths
  library(expss)      #labeling variables/values
  library(psych)      #used for statistical analyses
  library(ggplot2)    #creates plots
  library(Hmisc)
  library(misty)      #ordinal Cronbach's alpha
  library(lavaan)     #SEM
  library(workflowr)  #helps with workflow
```

## Get the Working Directory
```{r}
  here::i_am("./management/data02_BUDS.Rmd")
```

## Load Data
Remember to immediately rename and remove. Avoid overwriting old data.
```{r}
load(here("./data/BUDS_cleaning02.RData"))
```

# Filter and score data
```{r}
# Only include variables of interest
BUDS_cleaning03 <- BUDS_cleaning02
```

## Score ADDI
```{r}
# ADDI
## Make variable list
addi_vars <- c("addi_1b_i","addi_2b_i","addi_3b_i","addi_4b_i","addi_5b_i","addi_6b_i","addi_7b_i","addi_8b_i","addi_9b_i","addi_10b_i",
                                "addi_11b_i","addi_12b_i","addi_13b_i","addi_14b_i","addi_15b_i")
BUDS_cleaning03_cleaned <- BUDS_cleaning03
for (var in addi_vars) {
 eval(parse(text=paste0('
  BUDS_cleaning03_cleaned$',var,'_correct <- dplyr::recode_factor(BUDS_cleaning03$',var,', "Not at all"=1, "Slightly"=2, "Moderately"=3,"Considerably"=4,"Extremely"=5, `1`=1, `2`=2, `3`=3, `4`=4,`5`=5)')))
}

addi_vars_correct <- paste0(addi_vars,"_correct")

BUDS_cleaning03_cleaned[,addi_vars_correct] <- sapply(BUDS_cleaning03_cleaned[,addi_vars_correct], as.numeric) # make variables of numeric class

# Sort by least to most endorsed item
# sort(apply(BUDS_cleaning03_cleaned[,addi_vars_correct], 2, function(x) sum(x>0, na.rm=T)))

## score
BUDS_cleaning03_cleaned$addi_total <- rowSums(BUDS_cleaning03_cleaned[,addi_vars_correct], na.rm=TRUE)
BUDS_cleaning03_cleaned$addi_total_no6 <- rowSums(BUDS_cleaning03_cleaned[,addi_vars_correct[addi_vars_correct != "addi_6b_i_correct"]], na.rm=TRUE)
BUDS_cleaning03_cleaned$addi_total_c <- scale(BUDS_cleaning03_cleaned$addi_total, scale=FALSE, center=TRUE)
BUDS_cleaning03_cleaned$addi_total_z <- scale(BUDS_cleaning03_cleaned$addi_total, scale=TRUE, center=TRUE)
BUDS_cleaning03_cleaned$addi_01 <- ifelse(BUDS_cleaning03_cleaned$addi_total>0, 1, 0)
BUDS_cleaning03_cleaned$addi_educ <- rowSums(BUDS_cleaning03_cleaned[,addi_vars_correct[c(1,2,3,6)]], na.rm=TRUE)
BUDS_cleaning03_cleaned$addi_instit <- rowSums(BUDS_cleaning03_cleaned[,addi_vars_correct[c(7,9,10,13,14)]], na.rm=TRUE)
BUDS_cleaning03_cleaned$addi_peer <- rowSums(BUDS_cleaning03_cleaned[,addi_vars_correct[c(4,5,8,11,15)]], na.rm=TRUE)
```
### Alphas
```{r}
# psych::alpha(BUDS_cleaning03_cleaned[,c(addi_vars)])$total$std.alpha
# psych::alpha(BUDS_cleaning03_cleaned[,c(addi_vars[c(1,2,3,6)])])$total$std.alpha
# psych::alpha(BUDS_cleaning03_cleaned[,c(addi_vars[c(7,9,10,13,14)])])$total$std.alpha
# psych::alpha(BUDS_cleaning03_cleaned[,c(addi_vars[c(4,5,8,11,15)])])$total$std.alpha
```

## Score BCS-A
```{r}
# Score BCS
bcs_vars <- c("bcs_offline_1_i","bcs_offline_2_i","bcs_offline_3_i","bcs_offline_4_i","bcs_offline_5_i","bcs_offline_6_i","bcs_offline_7_i","bcs_offline_8_i",
              "bcs_online_1_i","bcs_online_2_i","bcs_online_3_i","bcs_online_4_i","bcs_online_5_i")

for (var in bcs_vars) {
 eval(parse(text=paste0('
  BUDS_cleaning03_cleaned$',var,'_correct <- dplyr::recode_factor(BUDS_cleaning03$',var,', "This did not happen to me"=0, "Once or twice"=1, "Every few weeks"=2,"About once a week"=3,"Several times a week or more"=4, `0`=0, `1`=1, `2`=2, `3`=3, `4`=4)')))
}
BUDS_cleaning03_cleaned <- as.data.frame(BUDS_cleaning03_cleaned)
BUDS_cleaning03_cleaned[,paste0(bcs_vars,"_correct")] <- sapply(BUDS_cleaning03_cleaned[,paste0(bcs_vars,"_correct")], FUN=function(x) as.integer(as.character(x))) # make variables of numeric class

# Score using ordinal measurement scale where ratings of "about once a week" and "several times a week or more" are treated equally.
BUDS_cleaning03_cleaned[,paste0(bcs_vars,"_correct")] <- sapply(BUDS_cleaning03_cleaned[,paste0(bcs_vars,"_correct")], function(x) ifelse(x>=2, 2, x))
bcs_vars <- paste0(bcs_vars,"_correct")
# Score using ordinal measurement scale
## This means that 0 = not involved, 1 = sub-threshold, 2 = victimized/perpetrated. Based on the scoring that if any of the items endorsed at a 2, then their subscale is a 2 ("about once a week" or "several times a week or more"); if any items endorsed as a 1 ("once or twice"), then subscale is a 1; participants could only score a 0 if all items endorsed at a 0 ("this did not happen to me").
BUDS_cleaning04 <- BUDS_cleaning03_cleaned %>% 
    mutate(bcs_physical_vic = ifelse(if_any(bcs_vars[1:4], ~.x %in% 2),2,if_any(bcs_vars[1:4], ~.x %in% 1,1,0)),
           bcs_physical_vic_01 = ifelse(bcs_physical_vic > 0, 1, 0),
           bcs_verbal_vic = ifelse(if_any(bcs_vars[5:6], ~.x %in% 2),2,if_any(bcs_vars[5:6], ~.x %in% 1,1,0)),
           bcs_rel_vic = ifelse(if_any(bcs_vars[7:8], ~.x %in% 2),2,if_any(bcs_vars[7:8], ~.x %in% 1,1,0)),
           bcs_cyber_vic = ifelse(if_any(bcs_vars[9:13], ~.x %in% 2),2,if_any(bcs_vars[9:13], ~.x %in% 1,1,0)),
           bcs_total_vic = ifelse(if_any(bcs_vars[1:13], ~.x %in% 2),2,if_any(bcs_vars[1:13], ~.x %in% 1,1,0)),
           
           bcs_physical_vic_revised = ifelse(if_any(bcs_vars[c(1,4)], ~.x %in% 2),2,if_any(bcs_vars[c(1,4)], ~.x %in% 1,1,0)),
           bcs_rel_vic_revised = ifelse(if_any(bcs_vars[c(2,3,7,8)], ~.x %in% 2),2,if_any(bcs_vars[c(2,3,7,8)], ~.x %in% 1,1,0)))
```
### Alphas
```{r}
item.alpha(BUDS_cleaning04[,c(bcs_vars[1:4])], std=TRUE)
item.alpha(BUDS_cleaning04[,c(bcs_vars[5:6])], std=TRUE)
item.alpha(BUDS_cleaning04[,c(bcs_vars[7:8])], std=TRUE)
item.alpha(BUDS_cleaning04[,c(bcs_vars[9:13])], std=TRUE)
item.alpha(BUDS_cleaning04[,c(bcs_vars[1:13])], std=TRUE)

original <- '
physical =~ bcs_offline_1_i_correct + bcs_offline_2_i_correct + bcs_offline_3_i_correct + bcs_offline_4_i_correct
verbal =~ bcs_offline_5_i_correct + bcs_offline_6_i_correct
relational =~ bcs_offline_7_i_correct + bcs_offline_8_i_correct
'

new <- '
physical =~ bcs_offline_1_i_correct + bcs_offline_4_i_correct
verbal =~ bcs_offline_5_i_correct + bcs_offline_6_i_correct
relational =~ bcs_offline_2_i_correct + bcs_offline_3_i_correct + bcs_offline_7_i_correct + bcs_offline_8_i_correct
'

original_fit <- cfa(original, BUDS_cleaning04, estimator="ML", missing="FIML")
new_fit <- cfa(new, BUDS_cleaning04, estimator="ML", missing="FIML")

anova(original_fit, new_fit)
```

## Score PROMIS
```{r}
promis_vars <- c("promis_peer_rel_1_i","promis_peer_rel_2_i","promis_peer_rel_3_i","promis_peer_rel_4_i","promis_peer_rel_5_i","promis_peer_rel_6_i","promis_peer_rel_7_i","promis_peer_rel_8_i","promis_family_rel_1_i","promis_family_rel_2_i","promis_family_rel_3_i","promis_family_rel_4_i")
# BUDS_cleaning04[,promis_vars] <- sapply(BUDS_cleaning04[,promis_vars], as.factor) # make variables of numeric class

BUDS_cleaning04_cleaned = BUDS_cleaning04
for (var in promis_vars[1:8]) {
 eval(parse(text=paste0('
  BUDS_cleaning04_cleaned$',var,'_correct <- dplyr::recode_factor(BUDS_cleaning04_cleaned$',var,', "Never"=1, "Almost Never"=2, "Sometimes"=3,"Often"=4,"Almost Always"=5, `1`=1, `2`=2, `3`=3, `4`=4,`5`=5)')))
}

for (var in promis_vars[9:12]) {
 eval(parse(text=paste0('
  BUDS_cleaning04_cleaned$',var,'_correct <- dplyr::recode_factor(BUDS_cleaning04_cleaned$',var,', "Never"=1, "Rarely"=2, "Sometimes"=3,"Often"=4,"Always"=5, `1`=1, `2`=2, `3`=3, `4`=4,`5`=5)')))
}

promis_vars_correct <- paste0(promis_vars,"_correct")
BUDS_cleaning04_cleaned[,promis_vars_correct] <- sapply(BUDS_cleaning04_cleaned[,promis_vars_correct], FUN=function(x) as.integer(as.character(x))) # make variables of numeric class

BUDS_cleaning05 <- BUDS_cleaning04_cleaned %>% 
    full_join(BUDS_cleaning04) %>%
    rowwise() %>%
    mutate(promis_peer_meanraw = mean(c_across(promis_peer_rel_1_i_correct:promis_peer_rel_8_i_correct), na.rm=F),
           promis_fam_meanraw = mean(c_across(promis_family_rel_1_i_correct:promis_family_rel_4_i_correct), na.rm=F),
           promis_peer_sumraw = sum(c_across(promis_peer_rel_1_i_correct:promis_peer_rel_8_i_correct), na.rm=F),
           promis_fam_sumraw = sum(c_across(promis_family_rel_1_i_correct:promis_family_rel_4_i_correct), na.rm=F)) %>%
   mutate(
     promis_peer_tscore = dplyr::recode(promis_peer_sumraw, 
     `40`=64.4,`39`=59.5,`38`=56.8,`37`=54.5,`36`=52.6,`35`=50.9,`34`=49.4,`33`=48,`32`=46.7,`31`=45.5,
     `30`=44.3,`29`=43.1,`28`=42,`27`=40.9,`26`=39.8,`25`=38.8,`24`=37.7,`23`=36.7,`22`=35.6,`21`=34.6,
     `20`=33.6,`19`=32.5,`18`=31.4,`17`=30.3,`16`=29.2,`15`=28.1,`14`=26.9,`13`=25.7,`12`=24.4,`11`=23,
     `10`=21.4,`9`=20,`8`=17.8),
     promis_fam_tscore = dplyr::recode(promis_fam_sumraw,
     `20`=59.5,`19`=52.1,`18`=49.0,`17`=46.7,`16`=44.7,`15`=42.8,`14`=41.0,`13`=39.1,`12`=37.4,`11`=35.7,
     `10`=34.0,`9`=32.4,`8`=30.8,`7`=29.1,`6`=27.3,`5`=25.1,`4`=21.4))

# Check to make sure mean is calculated correctly
head(BUDS_cleaning05[,c(promis_vars_correct[1:8],"promis_peer_meanraw")])
head(BUDS_cleaning05[,c(promis_vars_correct[9:12],"promis_fam_meanraw")])
```
### Alphas
```{r}
psych::alpha(BUDS_cleaning05[,c(promis_vars_correct[c(1:8)])])$total$std.alpha
psych::alpha(BUDS_cleaning05[,c(promis_vars_correct[c(9:12)])])$total$std.alpha
```

# Check variables
## Histograms
```{r}
# Check distributions
hist(BUDS_cleaning05$addi_total)
hist(BUDS_cleaning05$addi_educ)
hist(BUDS_cleaning05$addi_instit)
hist(BUDS_cleaning05$addi_peer)

hist(BUDS_cleaning05$bcs_physical_vic)
hist(BUDS_cleaning05$bcs_physical_vic_01)
hist(BUDS_cleaning05$bcs_verbal_vic)
hist(BUDS_cleaning05$bcs_rel_vic)
hist(BUDS_cleaning05$bcs_cyber_vic)
hist(BUDS_cleaning05$bcs_total_vic)

table(BUDS_cleaning05$promis_peer_sumraw)
hist(BUDS_cleaning05$promis_fam_sumraw)
table(BUDS_cleaning05$promis_peer_tscore)
table(BUDS_cleaning05$promis_fam_tscore)
```

## Correlation between measures
```{r Correlation matrix table function}
# from https://www.r-bloggers.com/2020/07/create-a-publication-ready-correlation-matrix-with-significance-levels-in-r/

correlation_matrix <- function(df, 
                               type = "pearson",
                               digits = 3, 
                               decimal.mark = ".",
                               use = "all", 
                               show_significance = TRUE, 
                               replace_diagonal = FALSE, 
                               replacement = ""){
  
  # check arguments
  stopifnot({
    is.numeric(digits)
    digits >= 0
    use %in% c("all", "upper", "lower")
    is.logical(replace_diagonal)
    is.logical(show_significance)
    is.character(replacement)
  })
  # we need the Hmisc package for this
  require(Hmisc)
  
  # retain only numeric and boolean columns
  isNumericOrBoolean = vapply(df, function(x) is.numeric(x) | is.logical(x), logical(1))
  if (sum(!isNumericOrBoolean) > 0) {
    cat('Dropping non-numeric/-boolean column(s):', paste(names(isNumericOrBoolean)[!isNumericOrBoolean], collapse = ', '), '\n\n')
  }
  df = df[isNumericOrBoolean]
  
  # transform input data frame to matrix
  x <- as.matrix(df)
  
  # run correlation analysis using Hmisc package
  correlation_matrix <- Hmisc::rcorr(x, type = )
  R <- correlation_matrix$r # Matrix of correlation coeficients
  p <- correlation_matrix$P # Matrix of p-value 
  
  # transform correlations to specific character format
  Rformatted = formatC(R, format = 'f', digits = digits, decimal.mark = decimal.mark)
  
  # if there are any negative numbers, we want to put a space before the positives to align all
  if (sum(R < 0) > 0) {
    Rformatted = ifelse(R > 0, paste0(' ', Rformatted), Rformatted)
  }
  
  # add significance levels if desired
  if (show_significance) {
    # define notions for significance levels; spacing is important.
    stars <- ifelse(is.na(p), "   ", ifelse(p < .001, "***", ifelse(p < .01, "** ", ifelse(p < .05, "*  ", "   "))))
    Rformatted = paste0(Rformatted, stars)
  }
  # build a new matrix that includes the formatted correlations and their significance stars
  Rnew <- matrix(Rformatted, ncol = ncol(x))
  rownames(Rnew) <- colnames(x)
  colnames(Rnew) <- paste(colnames(x), "", sep =" ")
  
  # replace undesired values
  if (use == 'upper') {
    Rnew[lower.tri(Rnew, diag = replace_diagonal)] <- replacement
  } else if (use == 'lower') {
    Rnew[upper.tri(Rnew, diag = replace_diagonal)] <- replacement
  } else if (replace_diagonal) {
    diag(Rnew) <- replacement
  }
  
  return(Rnew)
}
```
```{r}
all_measures <- c("addi_total","addi_educ","addi_instit","addi_peer",
                  "bcs_total_vic","bcs_physical_vic_01","bcs_verbal_vic","bcs_rel_vic","bcs_cyber_vic",
                  "promis_peer_tscore","promis_fam_tscore")

# write.csv(correlation_matrix(BUDS_cleaning05[c(all_measures)], use="lower", replace_diagonal = TRUE, show_significance=FALSE), file = here("manuscript/tables/beh_cor_matrix.csv"))

library(corrplot)
corrplot(cor(BUDS_cleaning05[c(all_measures)],use="pairwise.complete.obs"), method="circle")
```

```{r}
save(BUDS_cleaning05, file=here("data/BUDS_cleaning05.RData"))
```