---
title: "Data prep script 7: Grand averages and scalp topographies"
author: "Brent Rappaport"
date: "`r format(Sys.time(),  '%Y-%m-%d')`"
output:
  pdf_document: default
  html_document:
    df_print: paged
subtitle: Template Rmd
editor_options:
  chunk_output_type: console
toc: yes
---

# About
This script generates grand average waveforms and topographical maps for the Social Processing EEG task from the PREDICT project collaboration between Northwestern (PI: Shankman) and Columbia (PI: Auerbach).

# 1. Get Setup
## Clear everything & set width
```{r echo=TRUE, results='hide', message=FALSE}
    options(width=80, Ncpus = 6, mc.cores=6) #Set width
    # rm(list=ls())     #Remove everything from environment
    cat("\014")       #Clear Console
```

## Load Libraries
```{r echo=TRUE, results='hide', message=FALSE}
  # library(knitr)      #allows rmarkdown files
  library(haven)      #helps import stata
  library(questionr)  #allows lookfor function
  library(broom)      #nice statistical output
  library(here)       #nice file paths
  library(expss)      #labeling variables/values
  library(psych)      #used for statistical analyses
  library(ggplot2)    #creates plots
  library(Hmisc)
  library(MASS)
  library(papaja)
  library(eegUtils)
  library(tidyverse)  #plotting/cleaning, etc.
  library(workflowr)  #helps with workflow
here <- here::here
```

## Get the Working Directory
```{r}
  here::i_am("./management/data07_BUDS_GA.Rmd")
# Set import directory
erp_data_dir <- here::here("/projects/p31735/BUDS/eeg_processing/Scripts/")
```

```{r}
# load(file=here("data/BUDS_cleaning04_ga.RData"))
# load(file=here("data/BUDS_cleaning04_gaplots.RData"))
```

## Load ERP data
This section is not functional.
```{r, eval=F, include=F}
subjects <- c(1000,
1001,
1002,
1004,
1006,
1008,
1009,
1010,
1012,
1014,
1017,
1021,
1022,
1023,
1024,
1025,
1026,
1027,
1029,
1030,
1031,
1033,
1035,
1036,
1037,
1039,
1040,
1041,
1043,
1044,
1046,
1047,
1048,
1049,
1050,
1052,
1053,
1054,
1055,
1057,
1058,
1059,
1060,
1061,
1063,
1064,
1065,
1066,
1067,
1068,
1069,
1070,
1071,
1072,
1073,
1074,
1075,
1077,
1078,
1079,
1080,
1081,
1082,
1084,
1085,
1086,
1087,
1088,
1089,
1090,
1091,
1094,
1095,
1096,
1097,
1098,
1099,
1100,
1101,
1102,
1103,
1104,
1105,
1106,
1107,
1108,
1109,
1110,
1111,
1112,
1113,
1114,
1115,
1116,
1117,
1118,
1119,
1120,
1121,
1122,
1123,
1124,
1125,
1126,
9001,
9003,
9004,
9005,
9006,
9007,
9008,
9010,
9013,
9014,
9015,
9017,
9018,
9019,
9020,
9021,
9022,
9024,
9026,
9027,
9028,
9030,
9031,
9033,
9034,
9035,
9037,
9038,
9039,
9040,
9042,
9043,
9044,
9045,
9046,
9048,
9049,
9050,
9051,
9052,
9053,
9055,
9056,
9057,
9059,
9060,
9061,
9062,
9063,
9067,
9068,
9069,
9070,
9072,
9075,
9076,
9077,
9078,
9079,
9080,
9081,
9082,
9083,
9084,
9085,
9087,
9088,
9089,
9091,
9092,
9093,
9094,
9096,
9097,
9098,
9099,
9100
)

segments <- read.csv(paste0(erp_data_dir, "SegmentCount/summary_erp_bin_RewP.csv"))

subjects_150275 <- segments %>%
  dplyr::filter(Acc_Acc < 13 | Acc_Rej < 11) %>%
  select(subject)

subjects_275425 <- segments %>%
  dplyr::filter(Acc_Acc < 12 | Acc_Rej < 11) %>%
  select(subject)

channels <- c("AFz","C3","C4","CP1","CP2","CP5","CP6","CPz","Cz",
              "F3","F4","F7","F8","FC1","FC2","FC5","FC6","FCz","FT10","FT9","Fp1","Fp2","Fz",
              "Oz","P4","P7","P8","PO7","PO8","POz","Pz","TP10","TP9")

subjects <- setdiff(subjects, c(subjects_150275,subjects_275425))

library(eegUtils)
# To run on quest: module load hdf5/1.10.8-openmpi-3.1.3-gcc-8.4.0
# module load R/4.2.0
# R
# install.packages("hdf5r")
EEG <- import_set(paste0(erp_data_dir, "1000_continuous_icaed.set"))
chanlocs <- EEG$chan_info
channels <- EEG$chan_info$electrode

df_ga <- as.data.frame(NA)
for (c in channels[-1]) {
  eval(parse(text=paste0('df_ga_',c,' <- as.data.frame(NA)')))
  for (s in subjects) {
   skip_to_next <- FALSE
   tryCatch({
    eval(parse(text=paste0(
     'df_',s,'_',c,' <- read.csv(paste0(erp_data_dir,"Results/cleaned_data/',s,'_',c,'_raw_erp.csv"), header=FALSE)
     colnames(df_',s,'_',c,') <- c("Acc_Acc","Acc_Rej","Rej_Acc","Rej_Rej","Acc_All","Rej_All")
     df_',s,'_',c,'$ID <- rep(',s,', 1100)
     df_',s,'_',c,'$electrode <- rep("',c,'", 1100)
     df_',s,'_',c,'$Time <- seq(-200,1998,2)
     df_ga_',c,' <- dplyr::bind_rows(df_ga_',c,', df_',s,'_',c,')')))
     cat(paste0("Subject ", s, " finished.\n"))
   }, error = function(e){skip_to_next <<- TRUE})
    if(skip_to_next) { next }
  }
  eval(parse(text=paste0('df_ga <- dplyr::bind_rows(df_ga, df_ga_',c,')')))
  cat(paste0("Component ", c, " finished.\n"))
}



eeg.map_for_plotting <- df_ga %>%
  dplyr::select(-c("NA")) %>%
  filter(complete.cases(Acc_All)) %>%
  pivot_longer(cols=c(Acc_Acc, Acc_Rej, Rej_Acc, Rej_Rej, Acc_All, Rej_All), 
               values_to ="ERP", names_to="Condition") %>%
  arrange(ID,Condition,Time) %>% #sort by Subid, Condition, and then Time
  # dplyr::filter(Time>150 & Time<350) %>%
  group_by(Condition, electrode) %>% #grouping required for summarise in the next step
  dplyr::summarise(amplitude = mean(ERP)) #calculate mean across subjects


# erp_data_dir <- here::here("/projects/p31735/BUDS/eeg_processing/DataICA_cleaned/")
# EEG <- import_set(paste0(erp_data_dir, "1114_continuous_icacleaned.set"))
library(eegUtils)
chanlocs <- electrode_locations(read.csv(here('data/topo_plots/chanlocs32.csv')), montage="biosemi64")
ga_acc <- read.delim(here('data/topo_plots/ga_highvalue_acceptance_AA (Acc-Acc).txt'))%>%
  pivot_longer(cols=c(-time),
               values_to ="amplitude", names_to="electrode")
ga_rej <- read.delim(here('data/topo_plots/ga_highvalue_rejection_AR (Acc-Rej).txt'))%>%
  pivot_longer(cols=c(-time),
               values_to ="amplitude", names_to="electrode")
ga_diff <- read.delim(here('data/topo_plots/ga_highvalue_acc_rej_difference_BIN5=B1-B2.txt'))%>%
  pivot_longer(cols=c(-time),
               values_to ="amplitude", names_to="electrode")
summarise_eeg_ga <- function(data, window) {
data %>%
  dplyr::filter(time>window[1] & time<window[2]) %>%
  group_by(electrode) %>%
  dplyr::summarise(amplitude = mean(amplitude)) #calculate mean across subjects
}

topoplot(summarise_eeg_ga(ga_acc,c(50,150)), chanLocs=chanlocs, contour=FALSE, interp_limit="head", chan_marker="name") 

save(df_ga, eeg.map_for_plotting, file=here("./data/eeg_map_for_plotting_without_locs.RData"))
# save(EEG, df_ga, eeg.map_for_plotting, file=here("./data/eeg_map_for_plotting.RData"))
## ADD FC5
```

# Make grand averages
```{r Make and plot grand averages, warning=FALSE, include=F}
load(here::here("./data/topo_plots/eeg_map_for_plotting_without_locs.RData"))

df_ga_Cz_long <- df_ga %>%
  filter(electrode=="Cz") %>%
  dplyr::select(-c("NA")) %>%
  filter(complete.cases(Acc_All)) %>%
  mutate(AA_AR = Acc_Acc - Acc_Rej, # Create difference scores
         AR_AA = stdres(lm(Acc_Rej ~ Acc_Acc, data=., na.action=na.exclude)),
         RA_RR = stdres(lm(Rej_Acc ~ Rej_Rej, data=., na.action=na.exclude)),
         RR_RA = stdres(lm(Rej_Rej ~ Rej_Acc, data=., na.action=na.exclude)),
         A_R = stdres(lm(Acc_All ~ Rej_All, data=., na.action=na.exclude)),
         R_A = stdres(lm(Rej_All ~ Acc_All, data=., na.action=na.exclude))) %>%
  pivot_longer(cols=c(Acc_Acc, Acc_Rej, Rej_Acc, Rej_Rej, Acc_All, Rej_All, AA_AR), values_to ="ERP", names_to="Condition") %>%
  arrange(ID,Condition,Time) %>% #sort by Subid, Condition, and then Time
  group_by(Condition,Time) %>% #grouping required for summarise in the next step
  dplyr::summarise(grand_average = mean(ERP)) #calculate mean across subjects

df_ga_FCz_long <- df_ga %>%
  filter(electrode=="FCz") %>%
  dplyr::select(-c("NA")) %>%
  filter(complete.cases(Acc_All)) %>%
  mutate(AA_AR = Acc_Acc - Acc_Rej, # Create difference scores
         AR_AA = stdres(lm(Acc_Rej ~ Acc_Acc, data=., na.action=na.exclude)),
         RA_RR = stdres(lm(Rej_Acc ~ Rej_Rej, data=., na.action=na.exclude)),
         RR_RA = stdres(lm(Rej_Rej ~ Rej_Acc, data=., na.action=na.exclude)),
         A_R = stdres(lm(Acc_All ~ Rej_All, data=., na.action=na.exclude)),
         R_A = stdres(lm(Rej_All ~ Acc_All, data=., na.action=na.exclude))) %>%
  pivot_longer(cols=c(Acc_Acc, Acc_Rej, Rej_Acc, Rej_Rej, Acc_All, Rej_All, AA_AR), values_to ="ERP", names_to="Condition") %>%
  arrange(ID,Condition,Time) %>% #sort by Subid, Condition, and then Time
  group_by(Condition,Time) %>% #grouping required for summarise in the next step
  dplyr::summarise(grand_average = mean(ERP)) #calculate mean across subjects

df_ga_Fz_long <- df_ga %>%
  filter(electrode=="Fz") %>%
  dplyr::select(-c("NA")) %>%
  filter(complete.cases(Acc_All)) %>%
  mutate(AA_AR = Acc_Acc - Acc_Rej, # Create difference scores
         AR_AA = stdres(lm(Acc_Rej ~ Acc_Acc, data=., na.action=na.exclude)),
         RA_RR = stdres(lm(Rej_Acc ~ Rej_Rej, data=., na.action=na.exclude)),
         RR_RA = stdres(lm(Rej_Rej ~ Rej_Acc, data=., na.action=na.exclude)),
         A_R = stdres(lm(Acc_All ~ Rej_All, data=., na.action=na.exclude)),
         R_A = stdres(lm(Rej_All ~ Acc_All, data=., na.action=na.exclude))) %>%
  pivot_longer(cols=c(Acc_Acc, Acc_Rej, Rej_Acc, Rej_Rej, Acc_All, Rej_All, AA_AR), values_to ="ERP", names_to="Condition") %>%
  arrange(ID,Condition,Time) %>% #sort by Subid, Condition, and then Time
  group_by(Condition,Time) %>% #grouping required for summarise in the next step
  dplyr::summarise(grand_average = mean(ERP)) #calculate mean across subjects

df_ga_Pz_long <- df_ga %>%
  filter(electrode=="Pz") %>%
  dplyr::select(-c("NA")) %>%
  filter(complete.cases(Acc_All)) %>%
  mutate(AA_AR = Acc_Acc - Acc_Rej, # Create difference scores
         AR_AA = stdres(lm(Acc_Rej ~ Acc_Acc, data=., na.action=na.exclude)),
         RA_RR = stdres(lm(Rej_Acc ~ Rej_Rej, data=., na.action=na.exclude)),
         RR_RA = stdres(lm(Rej_Rej ~ Rej_Acc, data=., na.action=na.exclude)),
         A_R = stdres(lm(Acc_All ~ Rej_All, data=., na.action=na.exclude)),
         R_A = stdres(lm(Rej_All ~ Acc_All, data=., na.action=na.exclude))) %>%
  pivot_longer(cols=c(Acc_Acc, Acc_Rej, Rej_Acc, Rej_Rej, Acc_All, Rej_All, AA_AR), values_to ="ERP", names_to="Condition") %>%
  arrange(ID,Condition,Time) %>% #sort by Subid, Condition, and then Time
  group_by(Condition,Time) %>% #grouping required for summarise in the next step
  dplyr::summarise(grand_average = mean(ERP)) #calculate mean across subjects
```

# Create plots
## AA > AR
```{r}
Cz_ga_aa_ar_plot <- ggplot(data=filter(df_ga_Cz_long, Condition=="Acc_Acc" | Condition=="Acc_Rej" | Condition=="AA_AR"), aes(x=Time, y=grand_average, color=Condition)) +
  geom_line(linewidth=1) +
  xlim(-200,1000) +
  annotate("rect", xmin=50, xmax=150, ymin=-5, ymax=Inf, alpha=0.2, fill="orange") +
  annotate("rect", xmin=150, xmax=275, ymin=-5, ymax=Inf, alpha=0.2, fill="red") +
  annotate("rect", xmin=275, xmax=425, ymin=-5, ymax=Inf, alpha=0.2, fill="blue") +
  geom_rect(aes(xmin=0, xmax=0, ymin=-5, ymax=12), color="black") +
  geom_rect(aes(xmin=-200, xmax=800, ymin=0, ymax=0), color="black") +
  scale_color_manual(breaks=c("Acc_Acc","Acc_Rej","AA_AR"),
                     values=c("Acc_Acc"="green", "AA_AR"="black", "Acc_Rej"="red"), 
                     labels=c("Acceptance","Rejection","Difference"), name=NULL) +
  labs(x="Time (ms)", y="Cz") +
  theme_apa(base_size = 12) + theme(legend.position="top")

FCz_ga_aa_ar_plot <- ggplot(data=filter(df_ga_FCz_long, Condition=="Acc_Acc" | Condition=="Acc_Rej" | Condition=="AA_AR"), aes(x=Time, y=grand_average, color=Condition)) +
  geom_line(linewidth=1) +
  xlim(-200,1000) +
  annotate("rect", xmin=50, xmax=150, ymin=-5, ymax=Inf, alpha=0.2, fill="orange") +
  annotate("rect", xmin=150, xmax=275, ymin=-5, ymax=Inf, alpha=0.2, fill="red") +
  annotate("rect", xmin=275, xmax=425, ymin=-5, ymax=Inf, alpha=0.2, fill="blue") +
  geom_rect(aes(xmin=0, xmax=0, ymin=-5, ymax=12), color="black") +
  geom_rect(aes(xmin=-200, xmax=800, ymin=0, ymax=0), color="black") +
  scale_color_manual(breaks=c("Acc_Acc","Acc_Rej","AA_AR"),
                     values=c("Acc_Acc"="green", "AA_AR"="black", "Acc_Rej"="red"), 
                     labels=c("Acceptance","Rejection","Difference"), name=NULL) +
  labs(x="Time (ms)", y="FCz mean activity (ÂµV)") +
  theme_apa(base_size = 12) + theme(legend.position="top")

# ggsave(filename="figures/FCz_ga_aa_ar_plot.png", plot=FCz_ga_aa_ar_plot,
#        width=9, height = 7)

Fz_ga_aa_ar_plot <- ggplot(data=filter(df_ga_Fz_long, Condition=="Acc_Acc" | Condition=="Acc_Rej" | Condition=="AA_AR"), aes(x=Time, y=grand_average, color=Condition)) +
  geom_line(linewidth=1) +
  xlim(-200,1000) +
  annotate("rect", xmin=50, xmax=150, ymin=-5, ymax=Inf, alpha=0.2, fill="orange") +
  annotate("rect", xmin=150, xmax=275, ymin=-5, ymax=Inf, alpha=0.2, fill="red") +
  annotate("rect", xmin=275, xmax=425, ymin=-5, ymax=Inf, alpha=0.2, fill="blue") +
  geom_rect(aes(xmin=0, xmax=0, ymin=-5, ymax=12), color="black") +
  geom_rect(aes(xmin=-200, xmax=800, ymin=0, ymax=0), color="black") +
  scale_color_manual(breaks=c("Acc_Acc","Acc_Rej","AA_AR"),
                     values=c("Acc_Acc"="green", "AA_AR"="black", "Acc_Rej"="red"), 
                     labels=c("Acceptance","Rejection","Difference"), name=NULL) +
  labs(x="Time (ms)", y="Fz") +
  theme_apa(base_size = 12) + theme(legend.position="top")

Pz_ga_aa_ar_plot <- ggplot(data=filter(df_ga_Pz_long, Condition=="Acc_Acc" | Condition=="Acc_Rej" | Condition=="AA_AR"), aes(x=Time, y=grand_average, color=Condition)) +
  geom_line(linewidth=1) +
  xlim(-200,1000) +
  annotate("rect", xmin=50, xmax=150, ymin=-5, ymax=Inf, alpha=0.2, fill="orange") +
  annotate("rect", xmin=150, xmax=275, ymin=-5, ymax=Inf, alpha=0.2, fill="red") +
  annotate("rect", xmin=275, xmax=425, ymin=-5, ymax=Inf, alpha=0.2, fill="blue") +
  geom_rect(aes(xmin=0, xmax=0, ymin=-5, ymax=12), color="black") +
  geom_rect(aes(xmin=-200, xmax=800, ymin=0, ymax=0), color="black") +
  scale_color_manual(breaks=c("Acc_Acc","Acc_Rej","AA_AR"),
                     values=c("Acc_Acc"="green", "AA_AR"="black", "Acc_Rej"="red"), 
                     labels=c("Acceptance","Rejection","Difference"), name=NULL) +
  labs(x="Time (ms)", y="Pz") +
  theme_apa(base_size = 12) + theme(legend.position="top")

ggsave(here("figures/Cz_ga_aa_ar_plot.png"), Cz_ga_aa_ar_plot,
       height=6, width=10)
ggsave(here("figures/FCz_ga_aa_ar_plot.png"), FCz_ga_aa_ar_plot,
       height=6, width=10)
ggsave(here("figures/Pz_ga_aa_ar_plot.png"), Pz_ga_aa_ar_plot,
       height=6, width=10)
```

```{r}
load(file=here("./data/topo_plots/eeg_map_for_plotting.RData"))
library(eegUtils)
# EEG <- import_set(here('./data/eeg_processing_fully_auto/DataPreprocessed/1000_continuous_icaed.set'))
# chanlocs <- EEG$chan_info
# channels <- EEG$chan_info$electrode

select_topo_time_window <- function(data, start, end) {
  data %>%
  dplyr::select(-c("NA")) %>%
  filter(complete.cases(Acc_All)) %>%
  pivot_longer(cols=c(Acc_Acc, Acc_Rej, Rej_Acc, Rej_Rej, Acc_All, Rej_All), 
               values_to ="ERP", names_to="Condition") %>%
  filter(complete.cases(ERP)) %>%
  arrange(ID,Condition,Time) %>% #sort by Subid, Condition, and then Time
  dplyr::filter(Time>start & Time<end) %>%
  group_by(Condition, electrode) %>% #grouping required for summarise in the next step
  dplyr::summarise(amplitude = mean(ERP)) #calculate mean across subjects
}

eeg.map_for_plotting_50150 <- select_topo_time_window(df_ga, 50, 150)
eeg.map_for_plotting_150275 <- select_topo_time_window(df_ga, 150, 275)
eeg.map_for_plotting_275425 <- select_topo_time_window(df_ga, 275, 425)
```

# Save
```{r}
save(df_ga_Cz_long, df_ga_FCz_long, df_ga_Fz_long, df_ga_Pz_long, file=here("data/BUDS_do03_gaplots.RData"))

# save(df_ga_Cz, df_ga_FCz, df_ga_Pz, file=here("data/BUDS_do03_ga.RData"))
# save(eeg.map_for_plotting_adi_50150, eeg.map_for_plotting_adi_150275, eeg.map_for_plotting_adi_275425,
#      eeg.map_for_plotting_50150, eeg.map_for_plotting_150275, eeg.map_for_plotting_275425, file=here("/data/BUDS_cleaning04_topo_windows.RData"))
```

