---
title: "Data prep script 3: Importing ADI and self-report data"
author: "Brent Rappaport"
date: "`r format(Sys.time(),  '%Y-%m-%d')`"
output:
  pdf_document: default
  html_document:
    df_print: paged
subtitle: Template Rmd
editor_options:
  chunk_output_type: console
toc: yes
---

# About
This script imports and cleans ADI (Area Deprivation Index) and self-report data from PREDICT project collaboration between Northwestern (PI: Shankman) and Columbia (PI: Auerbach).

# Get Setup
```{r}
knitr::opts_chunk$set(set.seed(312), echo=FALSE, results='hide', message=FALSE, warning=FALSE, error=FALSE)
    options(width=80) #Set width
    rm(list=ls())     #Remove everything from environment
    cat("\014")       #Clear Console
```

## Load Libraries
```{r}
  library(knitr)      #allows rmarkdown files
  library(haven)      #helps import stata
  library(questionr)  #allows lookfor function
  library(broom)      #nice statistical output
  library(here)       #nice file paths
  library(expss)      #labeling variables/values
  library(psych)      #used for statistical analyses
  library(ggplot2)    #creates plots
  library(MASS)
  library(papaja)     #generate APA documents
  library(Hmisc)
  library(misty)      #ordinal Cronbach's alpha
  library(lavaan)     #SEM
  library(papaja)
  library(pscl)       # for zero inflated models
  library(confintr)
  library(bestNormalize) # for normalizing data
  library(tidyverse)  #plotting/cleaning, etc.
  library(ggpubr)
  library(workflowr)  #helps with workflow

select <- dplyr::select
here <- here::here

here::i_am("./management/data03_BUDS.Rmd")
```

# Load ERP data
```{r}
load(here::here("./data/ERP_data.RData"))
# load(here::here("./data/November_ERP_data.RData"))
```

# Import ADI
```{r, include=F}
# Import address info and sort by row number, to tie to subject number
geocode_data <- read.csv(here::here("../_rawdata/GeocodeResults.csv"), header=F, colClasses='character') %>%
  mutate(V1=as.integer(as.character(V1))) %>%
  arrange(V1)

# Concatenate to make FIPS
geocode_data$FIPS <- as.numeric(as.character((paste0(geocode_data$V9,geocode_data$V10,geocode_data$V11,substr(geocode_data$V12,1,1)))))

# Import subject ID 
subj_rownumber <- openxlsx::read.xlsx(here::here("../_rawdata/Address/PREDICT_ids.xlsx"))
geocode_data2 <- full_join(subj_rownumber,geocode_data, by="V1")
adi_codes <- read.csv(here::here("./data/ADI/national/US_2021_ADI_Census_Block_Group_v4_0_1.csv"))

geocode_data_with_adi <- left_join(geocode_data2, adi_codes, by="FIPS")
geocode_data_with_adi$ADI_NATRANK <- as.numeric(as.character(geocode_data_with_adi$ADI_NATRANK))
```

### Manually enter ADI values
For those missing it (based on surrounding neighborhoods)
Drawn from https://www.neighborhoodatlas.medicine.wisc.edu/mapping
```{r}
# geocode_data_with_adi[geocode_data_with_adi$ID==1008,"ADI_NATRANK"] <- 1 # but on college campus
geocode_data_with_adi[geocode_data_with_adi$ID==1009,"ADI_NATRANK"] <- 1 # but on college campus, though this address was their family address before college per Lili
geocode_data_with_adi[geocode_data_with_adi$ID==1010,"ADI_NATRANK"] <- 24
geocode_data_with_adi[geocode_data_with_adi$ID==1043,"ADI_NATRANK"] <- 6 # this is a very small side street that only exist in one tract
geocode_data_with_adi[geocode_data_with_adi$ID==1060,"ADI_NATRANK"] <- 4
geocode_data_with_adi[geocode_data_with_adi$ID==1071,"ADI_NATRANK"] <- 31
geocode_data_with_adi[geocode_data_with_adi$ID==1074,"ADI_NATRANK"] <- 49
geocode_data_with_adi[geocode_data_with_adi$ID==1108,"ADI_NATRANK"] <- 11
geocode_data_with_adi[geocode_data_with_adi$ID==1111,"ADI_NATRANK"] <- 7
geocode_data_with_adi[geocode_data_with_adi$ID==1112,"ADI_NATRANK"] <- (9+4)/2
geocode_data_with_adi[geocode_data_with_adi$ID==1114,"ADI_NATRANK"] <- (9+4)/2 # international student who's original home is in Columbia
geocode_data_with_adi[geocode_data_with_adi$ID==1117,"ADI_NATRANK"] <- (5+4+21)/3
geocode_data_with_adi[geocode_data_with_adi$ID==1122,"ADI_NATRANK"] <- 23

geocode_data_with_adi[geocode_data_with_adi$ID==9005,"ADI_NATRANK"] <- 13
geocode_data_with_adi[geocode_data_with_adi$ID==9006,"ADI_NATRANK"] <- 22
geocode_data_with_adi[geocode_data_with_adi$ID==9010,"ADI_NATRANK"] <- 46
geocode_data_with_adi[geocode_data_with_adi$ID==9039,"ADI_NATRANK"] <- 44
geocode_data_with_adi[geocode_data_with_adi$ID==9044,"ADI_NATRANK"] <- (21+29)/2 # but on college campus
geocode_data_with_adi[geocode_data_with_adi$ID==9052,"ADI_NATRANK"] <- 29
geocode_data_with_adi[geocode_data_with_adi$ID==9056,"ADI_NATRANK"] <- 7 # previously NA
geocode_data_with_adi[geocode_data_with_adi$ID==9059,"ADI_NATRANK"] <- (21+29)/2 # but on college campus
geocode_data_with_adi[geocode_data_with_adi$ID==9060,"ADI_NATRANK"] <- 57 # on on college campus but previous address was in Mexico
geocode_data_with_adi[geocode_data_with_adi$ID==9069,"ADI_NATRANK"] <- 3
geocode_data_with_adi[geocode_data_with_adi$ID==9082,"ADI_NATRANK"] <- 54
geocode_data_with_adi[geocode_data_with_adi$ID==9091,"ADI_NATRANK"] <- 21
geocode_data_with_adi[geocode_data_with_adi$ID==9127,"ADI_NATRANK"] <- 63 # current address is on college campus, however this reflects participant family's address before college
geocode_data_with_adi[geocode_data_with_adi$ID==9128,"ADI_NATRANK"] <- 73 # current address is on college campus, however this reflects participant family's address before college

# 9027 and 9026 are siblings, so we are assuming that they live in the same address and thus have the same ADI
geocode_data_with_adi[geocode_data_with_adi$ID==9027,"ADI_NATRANK"] <- geocode_data_with_adi[geocode_data_with_adi$ID==9026,"ADI_NATRANK"]
```

## REVERSE SCORE ADI
```{r}
geocode_data_with_adi$ADI_NATRANK <- 100-geocode_data_with_adi$ADI_NATRANK
```

```{r Number missing ADI, eval=FALSE}
missing <- geocode_data_with_adi[,c("ID","ADI_NATRANK")] %>%
  filter(is.na(ADI_NATRANK) | ADI_NATRANK=="GQ") %>%
  select(ID)
sum(is.na(df_150275_cz$ADI_NATRANK))
sum(!is.na(df_150275_cz$ADI_NATRANK))

address <- left_join(geocode_data2, adi_codes, by="FIPS")
address[address$ID==1062,c("V2","ADI_NATRANK")]
address[address$ID==9009,c("V2","ADI_NATRANK")]

# Subjects over 18
load(file=here::here("./data/over_18_150275.RData"))
load(file=here::here("./data/over_18_275425.RData"))
over_18 <- address %>%
  filter(ID %in% over_18_150275$ID) %>%
  select(ID, V2)
```

# STRAIN
```{r}
load(here("data/BUDS_cleaning02_with_strain.RData")); BUDS_cleaning03_with_strain <- BUDS_cleaning02_with_strain
rm(BUDS_cleaning02_with_strain)
```

# Score self-report data
```{r}
load(here("data/BUDS_cleaning02.RData")); BUDS_cleaning03 <- BUDS_cleaning02
rm(BUDS_cleaning02)
```

## Race
```{r}
demo_vars <- c("id_1_i","demo_child_gender","demo_child_sex","demo_child_race","demo_child_hispanic","demo_child_sex_or")

# Import raw demographic data
nw_demo1 <- read.csv(here::here("../_rawdata/demo/nw/SP Demographics Child+Parent+18 Merged_9001-9042.csv"),
                     colClasses="character", header=TRUE) %>%
    dplyr::select(all_of(demo_vars))
nw_demo2 <- read.csv(here::here("../_rawdata/demo/nw/SP Demographics 11.4.21_May 18, 2023_9042-9110.csv"),
                     colClasses="character", header=TRUE) %>%
    dplyr::select(all_of(demo_vars))
 
# Merge two NW files together 
nw_demo <- nw_demo1 %>%
  full_join(nw_demo2)

# Which subjects have more than 1 row of data?
nw_demo[duplicated(nw_demo$id_1_i),"id_1_i"]

# Fill in missing values for this subject
nw_demo[nw_demo$id_1_i==9020,] <- nw_demo[nw_demo$id_1_i==9020,][2,]
# Remove duplicate row
nw_demo <- nw_demo %>% distinct(id_1_i, .keep_all = TRUE)

cu_demo1 <- read.csv(here::here("../_rawdata/demo/cu/SP_Demographics (4.13.21)_November 1, 2021_12.34.csv"), colClasses="character", header=TRUE)[-c(1:2),] %>%
  dplyr::select(all_of(demo_vars))
cu_demo2 <- read.csv(here::here("../_rawdata/demo/cu/SP_Demographics (9.22.21)_July 18, 2023_08.08.csv"), colClasses="character", header=TRUE)[-c(1:2),] %>%
  dplyr::select(all_of(demo_vars))

cu_demo <- cu_demo1 %>%
  full_join(cu_demo2) # merge two NW files together

# Convert ID variables to integers (as.character assures that values are not changed)
nw_demo <- nw_demo %>%
  mutate(ID = as.integer(as.character(id_1_i))) %>%
  dplyr::select(-id_1_i) %>%
  filter(complete.cases(ID))
cu_demo <- cu_demo %>%
  mutate(ID = as.integer(as.character(id_1_i))) %>%
  dplyr::select(-id_1_i) %>%
  filter(complete.cases(ID))

# Test whether there are any duplicate IDs
nw_demo[duplicated(nw_demo$ID)==TRUE,"ID"]
cu_demo[duplicated(cu_demo$ID)==TRUE,"ID"]

cu_demo <- cu_demo %>%
  distinct(ID, .keep_all=TRUE)

BUDS_cleaning04_demo <- rbind(cu_demo, nw_demo) %>%
  mutate(demo_child_gender = case_match(demo_child_gender,
                                        "1" ~ "Male", "2" ~ "Female", 
                                      "3" ~ "Trans male", "4" ~ "Trans female", 
                                      "5" ~ "Genderqueer/Gender non-conforming", 
                                      "6" ~ "Do not identify as any of these options", 
                                      "99" ~ "Prefer not to answer",
                                      .default=demo_child_gender),
         demo_child_sex = as.factor(case_match(demo_child_sex,
                                     "1" ~ "Male", "2" ~ "Female", "" ~ NA,
                                     .default=demo_child_sex)),
         demo_child_sex_or = case_match(demo_child_sex_or,
                                        "1" ~ "Heterosexual", "2" ~ "Gay or Lesbian",
                                        "3" ~ "Bisexual or pansexual", 
                                        "4" ~ "Asexual", "5" ~ "Not sure", 
                                        "99" ~ "Decline to state", "6" ~ "Other",
                                        .default=demo_child_sex_or),
         demo_child_race = case_match(demo_child_race,
                                      "1" ~ "American Indian/Alaska Native", 
                                      "2" ~ "Asian", 
                                      "3" ~ "Native Hawaiin or Other Pacific Islander", 
                                      "4" ~ "Black or African American", 
                                      "5" ~ "White", 
                                      "6" ~ "More than one race", 
                                      "99" ~ "Unknown or not reported",
                                      .default=demo_child_race),
         demo_child_hispanic = case_match(demo_child_hispanic, "Yes" ~ "Yes", "No" ~ "No",
                                          "0" ~ "No", "1" ~ "Yes")) %>%
  mutate(White_nonwhite = case_match(demo_child_race, c("White") ~ "White",
         c("More than one race", "Asian", "Black or African American", "American Indian/Alaska Native", "Native Hawaiian or Other Pacific Islander") ~ "Non_white")) %>%
  dplyr::select(c(ID, demo_child_gender, demo_child_sex, demo_child_race, demo_child_hispanic, White_nonwhite)) %>%
  filter(complete.cases(demo_child_sex))

contrasts(BUDS_cleaning04_demo$demo_child_sex) = contr.sum(2)
```

## ADDI
```{r}
# ADDI
## Make variable list
addi_vars <- c("addi_1b_i","addi_2b_i","addi_3b_i","addi_4b_i","addi_5b_i","addi_6b_i","addi_7b_i","addi_8b_i","addi_9b_i","addi_10b_i", "addi_11b_i","addi_12b_i","addi_13b_i","addi_14b_i","addi_15b_i")
addi_vars_correct <- paste0(addi_vars,"_correct")

BUDS_cleaning04 <- BUDS_cleaning03  %>%
  mutate(across(all_of(addi_vars), ~ case_when(
    . == "Not at all" ~ 1, . == "Slightly" ~ 2, . == "Moderately" ~ 3, . == "Considerably" ~ 4, . == "Extremely" ~ 5,
    . == "1" ~ 1, . == "2" ~ 2, . == "3" ~ 3, . == "4" ~ 4, . == "5" ~ 5,
    TRUE ~ as.numeric(.)
  ), .names = "{.col}_correct"))

BUDS_cleaning04$addi_total <- rowSums(BUDS_cleaning04[,addi_vars_correct], na.rm=TRUE)
table(BUDS_cleaning04$addi_total>0)

## score
BUDS_cleaning04$addi_total <- rowSums(BUDS_cleaning04[,addi_vars_correct], na.rm=TRUE)
BUDS_cleaning04$addi_total_no6 <- rowSums(BUDS_cleaning04[,addi_vars_correct[addi_vars_correct != "addi_6b_i_correct"]], na.rm=TRUE)

# BUDS_cleaning04$addi_total_c <- scale(BUDS_cleaning04$addi_total, scale=FALSE, center=TRUE)
# BUDS_cleaning04$addi_total_z <- scale(BUDS_cleaning04$addi_total, scale=TRUE, center=TRUE)
BUDS_cleaning04$addi_01 <- ifelse(BUDS_cleaning04$addi_total>0, 1, 0)
BUDS_cleaning04$addi_educ <- rowSums(BUDS_cleaning04[,addi_vars_correct[c(1,2,3,6)]], na.rm=TRUE)
BUDS_cleaning04$addi_instit <- rowSums(BUDS_cleaning04[,addi_vars_correct[c(7,9,10,13,14)]], na.rm=TRUE)
BUDS_cleaning04$addi_peer <- rowSums(BUDS_cleaning04[,addi_vars_correct[c(4,5,8,11,15)]], na.rm=TRUE)
```

## IDAS
```{r}
BUDS_cleaning04_idas <- as.data.frame(BUDS_cleaning04) %>%
  select(ID,contains("idas")) %>%
  mutate_all(as.character())
idas <- colnames(BUDS_cleaning04_idas[,-1])
BUDS_cleaning04_idas_num <- BUDS_cleaning04_idas %>%
  dplyr::mutate(across(all_of(c(idas)), ~ dplyr::case_match(as.character(.), "1" ~ 1, "2" ~ 2, "3" ~ 3, "4" ~ 4, "5" ~ 5,
                                                       "Not at all" ~ 1,
                                                       "A little bit" ~ 2,
                                                       "Moderately" ~ 3,
                                                       "Quite a bit" ~ 4,
                                                       "Extremely" ~ 5)))

idas_dep <- c("idas_1_i","idas_2_i","idas_5_i","idas_6_i","idas_8_i","idas_9_i","idas_11_i","idas_13_i","idas_21_i","idas_26_i","idas_30_i","idas_31_i","idas_40_i","idas_48_i","idas_51_i","idas_52_i","idas_57_i","idas_61_i")
idas_wb <- c("idas_3_i","idas_10_i","idas_23_i","idas_27_i","idas_50_i","idas_53_i","idas_59_i","idas_64_i")
idas_panic <- c("idas_7_i","idas_16_i","idas_32_i","idas_39_i","idas_45_i","idas_49_i","idas_56_i","idas_58_i")
idas_sa <- c("idas_15_i","idas_18_i","idas_20_i","idas_41_i","idas_47_i","idas_99_i")
# idas_claus <- c("idas_74_i","idas_80_i","idas_84_i","idas_90_i","idas_94_i")

BUDS_cleaning04_idas_num$idas_27r = 6 - BUDS_cleaning04_idas_num$idas_27_i
BUDS_cleaning04_idas_num$idas_64r = 6 - BUDS_cleaning04_idas_num$idas_64_i
BUDS_cleaning04_idas_num$IDAS_depression = rowMeans(BUDS_cleaning04_idas_num[,idas_dep], na.rm=T)
BUDS_cleaning04_idas_num$IDAS_wellbeing = rowMeans(BUDS_cleaning04_idas_num[,idas_wb], na.rm=T)
BUDS_cleaning04_idas_num$IDAS_panic = rowMeans(BUDS_cleaning04_idas_num[,idas_panic], na.rm=T)
BUDS_cleaning04_idas_num$IDAS_sa = rowMeans(BUDS_cleaning04_idas_num[,idas_sa], na.rm=T)
BUDS_cleaning04_idas_num$IDAS_anxiety = rowMeans(BUDS_cleaning04_idas_num[,c(idas_panic,idas_sa)], na.rm=T)

cor.test(BUDS_cleaning04_idas_num$IDAS_panic, BUDS_cleaning04_idas_num$IDAS_sa)
shapiro.test(BUDS_cleaning04_idas_num$IDAS_depression)
BUDS_cleaning04_idas_num$IDAS_depression_sqrt <- sqrt(BUDS_cleaning04_idas_num$IDAS_depression)
BUDS_cleaning04_idas_num$IDAS_depression_log <- log(BUDS_cleaning04_idas_num$IDAS_depression)
BUDS_cleaning04_idas_num$IDAS_depression_rec <- 1/(BUDS_cleaning04_idas_num$IDAS_depression)
```

```{r}
BUDS_cleaning03_with_strain  <- BUDS_cleaning03_with_strain %>%
  select(ID,(which(names(.) == "Age")):ncol(.))

BUDS_cleaning04_addi <- BUDS_cleaning04 %>%
  select(ID, starts_with("addi_"))

filter(as.data.frame(table(BUDS_cleaning04_demo$ID)),Freq>1)

BUDS_cleaning05 <- BUDS_cleaning04_demo %>%
  full_join(geocode_data_with_adi, by="ID") %>%
  full_join(BUDS_cleaning04_idas_num, by="ID") %>%
  full_join(BUDS_cleaning04_addi, by="ID") %>%
  full_join(BUDS_cleaning03_with_strain, by="ID")

filter(as.data.frame(table(BUDS_cleaning05$ID)),Freq>1)
BUDS_cleaning05$ID <- as.numeric(as.character(BUDS_cleaning05$ID))
```

```{r}
save(BUDS_cleaning05, file="./data/BUDS_cleaning05.RData")
```
