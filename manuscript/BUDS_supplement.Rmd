---
title     : "Socioeconomic status and adolescent brain responses to peer feedback: Testing impact on negative affect assessed outside of the lab"
shorttitle    : "SES & brain responses to peer feedback"

bibliography      : "BUDS.bib"
floatsintext      : yes
linenumbers       : no
draft             : no
mask              : no
figurelist        : no
tablelist         : no
footnotelist      : no

classoption       : "man, donotrepeattitle"
csl               : 'biological-psychiatry.csl'
documentclass     : "apa7"
output            : papaja::apa6_pdf
    
editor_options: 
  markdown: 
    wrap: sentence
    
header-includes:
  - \AtBeginDocument{\let\maketitle\relax}
  
  - \usepackage{setspace}
  - \AtBeginEnvironment{tabular}{\singlespacing}
  - \AtBeginEnvironment{lltable}{\singlespacing}
  - \addtolength{\tabcolsep}{6pt}
  - \AtBeginEnvironment{tablenotes}{\doublespacing}
  - \captionsetup[table]{font={stretch=1.5}}
  - \captionsetup[figure]{font={stretch=1.5}}
  - \usepackage{caption} # Makes figures and table starts with S as in Figure S1.
  - \DeclareCaptionLabelFormat{Sformat}{#1 S#2}     
  - \captionsetup[table]{labelformat=Sformat}  
  - \captionsetup[figure]{labelformat=Sformat} 
  
  - \raggedbottom
  - \usepackage{helvet}
  - \renewcommand{\rmdefault}{phv} % Use Helvetica for serif
  - \renewcommand{\sfdefault}{phv} % Use Helvetica for sans-serif
  - \usepackage{mathastext}          # Make math text Helvetica
---

```{r analysis-preferences}
knitr::opts_chunk$set(set.seed(312), warning=FALSE, message=FALSE, include=FALSE, papaja.title_page = FALSE) # default chunk options
options(width=80, Ncpus = 6, mc.cores=6, max.print=1000000, scipen = 999) # RStudio console options: set width, multiple cores, and do not use scientific notation
rm(list=ls())     #Remove everything from environment
cat("\014")       #Clear Console

  library(haven)      #helps import stata
  library(here)       #nice file paths
  library(psych)      #used for statistical analyses
  library(Hmisc)
  library(purrr)
  library(haven)      #to import SPSS files
# Models
  library(lmerTest)
  library(glmmTMB)
  library(lsr)        #cohensD
# Plotting
  library(ggplot2)    #creates plots
  library(ggpubr)
  library(ggeffects)
  library(sjPlot)
  library(interactions)
  library(emmeans) # testing simple slopes
    
  library(eegUtils)
  library(gridExtra)
    
  library(Rmisc)
  library(grid)
  library(broom.mixed)

# General tools
  library(tidyverse)  #plotting/cleaning, etc.
  library(papaja)
  library(workflowr)  #helps with workflow

here <- here::here
r_refs("BUDS.bib")
```

```{r Load data}
here::i_am("BUDS_manuscript_working.Rmd")

load(file=here::here("../data/BUDS_do02.RData")) # ERP and self-report data
load(file=here("../data/BUDS_behavior.RData")) # ERP behavioral data
load(file=here("../data/BUDS_do03_gaplots.RData")) # Grand average data
spearman_brown_raw <- read.csv(file=here("../tables/spearman_brown.csv")) # Internal consistency table
```

```{r Functions}
# from https://www.r-bloggers.com/2020/07/create-a-publication-ready-correlation-matrix-with-significance-levels-in-r/

round3 <- function(var) {
  sprintf("%.3f",var)
}

correlation_matrix <- function(df,
                               type = "pearson",
                               digits = 3,
                               decimal.mark = ".",
                               use = "all",
                               show_significance = TRUE,
                               replace_diagonal = FALSE,
                               replacement = ""){
  
  # check arguments
  stopifnot({
    is.numeric(digits)
    digits >= 0
    use %in% c("all", "upper", "lower")
    is.logical(replace_diagonal)
    is.logical(show_significance)
    is.character(replacement)
  })
  # we need the Hmisc package for this
  require(Hmisc)
  
  # retain only numeric and boolean columns
  isNumericOrBoolean = vapply(df, function(x) is.numeric(x) | is.logical(x), logical(1))
  if (sum(!isNumericOrBoolean) > 0) {
    cat('Dropping non-numeric/-boolean column(s):', paste(names(isNumericOrBoolean)[!isNumericOrBoolean], collapse = ', '), '\n\n')
  }
  df = df[isNumericOrBoolean]
  
  # transform input data frame to matrix
  x <- as.matrix(df)
  
  # run correlation analysis using Hmisc package
  correlation_matrix <- Hmisc::rcorr(x, type = )
  R <- correlation_matrix$r # Matrix of correlation coeficients
  p <- correlation_matrix$P # Matrix of p-value
  
  # transform correlations to specific character format
  Rformatted = formatC(R, format = 'f', digits = digits, decimal.mark = decimal.mark)
  
  # if there are any negative numbers, we want to put a space before the positives to align all
  if (sum(R < 0) > 0) {
    Rformatted = ifelse(R > 0, paste0(' ', Rformatted), Rformatted)
  }
  
  # add significance levels if desired
  if (show_significance) {
    # define notions for significance levels; spacing is important.
    stars <- ifelse(is.na(p), "   ", ifelse(p < .001, "***", ifelse(p < .01, "** ", ifelse(p < .05, "*  ", "   "))))
    Rformatted = paste0(Rformatted, stars)
  }
  # build a new matrix that includes the formatted correlations and their significance stars
  Rnew <- matrix(Rformatted, ncol = ncol(x))
  rownames(Rnew) <- colnames(x)
  colnames(Rnew) <- paste(colnames(x), "", sep =" ")
  
  # replace undesired values
  if (use == 'upper') {
    Rnew[lower.tri(Rnew, diag = replace_diagonal)] <- replacement
  } else if (use == 'lower') {
    Rnew[upper.tri(Rnew, diag = replace_diagonal)] <- replacement
  } else if (replace_diagonal) {
    diag(Rnew) <- replacement
  }
  
  return(Rnew)
}

lmer_adi_interaction_table <- function(data) {
  new_model <- data.frame(model = c("Both","Like","Dislike"),
                            beta = NA, 
                            p = NA)
new_model$beta <- c(broom.mixed::tidy(lmer(formula = ERP ~ Feedback*Voting*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = data))[8,4], broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Like")))[4,4],
                        broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Dislike")))[4,4])

new_model$p <- c(broom.mixed::tidy(lmer(formula = ERP ~ Feedback*Voting*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = data))[8,8], broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Like")))[4,8],
                        broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Dislike")))[4,8])
new_model
}

plot_stats <- function(model, var) {
  temp_stats <- tidy(model) %>% 
    dplyr::filter(term==var) %>%
    dplyr::select(estimate,p.value) %>%
    round3(.)
  paste0("b = ", temp_stats[1], ", p = ", temp_stats[2])
}

ses_lm <- function(data, y) {
  y <- enquo(y)

  model_formula <- formula(paste0(quo_name(y), "~ ADI_NATRANK_z + site + Age_c + demo_child_sex + StressCT_z + StressTH_z + IDAS_depression_z + IDAS_anxiety_z"))
  lm(model_formula, data = data)
}

apa_printlm <- function(model) {
  glue_apa_results(broom::tidy(model, conf.int = TRUE)
    , est_glue = "$\\beta=<<estimate>>$, 95% CI [<<conf.low>>,<<conf.high>>]"
    , stat_glue = "*p*<<add_equals2(p.value)>>"
    , term_names = sanitize_terms(make.names(names(coef(model))))
)
}

# Make my own apa_printlm function that does not include t stats
add_equals2 <- function(p_value) {
  for (p in p_value) {
    if (p < 0.001) {
      return("< 0.001")
    } else {
      return(paste0("=", format(p_value, digits = 2, nsmall =2)))
    }
  }
}

lm_results <- function(model, var) {
  tidy(model, conf.int=TRUE) %>%
    filter(term==var) %>%
    mutate(stat = paste0("$\\beta$=",round3(estimate), ", 95% CI= [",round3(conf.low), ", ", round3(conf.high),"], *p*=",round3(p.value))) %>%
    select(stat)
}

apa_printt <- function(model) {
  glue_apa_results(broom::tidy(model, conf.int = TRUE)
    , est_glue = "*t*(<<parameter>>)=<<statistic>>, 95% CI [<<conf.low>>,<<conf.high>>]"
    , stat_glue = "*p*<<add_equals2(p.value)>>"
    , term_names = sanitize_terms(make.names(names(coef(model))))
)
}
```

# Supplement for *Socioeconomic status and adolescent brain responses to peer feedback: Testing the impact on negative affect assessed outside of the lab*

```{r, include=TRUE, dpi=400, fig.cap="Topographic maps of RewP and P300 to high-value peer acceptance, high-value peer rejection, high-value peer acceptance relative to high-value peer rejection."}

chanlocs <- eegUtils::electrode_locations(read.csv(here::here('../data/topo_plots/chanlocs32.csv')), montage="biosemi64")
ga_acc <- read.delim(here('../data/topo_plots/ga_highvalue_acceptance_AA (Acc-Acc).txt'))%>%
  pivot_longer(cols=c(-time),
               values_to ="amplitude", names_to="electrode")
ga_rej <- read.delim(here('../data/topo_plots/ga_highvalue_rejection_AR (Acc-Rej).txt'))%>%
  pivot_longer(cols=c(-time),
               values_to ="amplitude", names_to="electrode")
ga_diff <- read.delim(here('../data/topo_plots/ga_highvalue_acc_rej_difference_BIN5=B1-B2.txt'))%>%
  pivot_longer(cols=c(-time),
               values_to ="amplitude", names_to="electrode")

scaling_factor=0.45
# Create grobs for the column titles

title_rewp <- textGrob("RewP", gp=gpar(fontsize=14, fontface="bold"))
title_p300 <- textGrob("P300", gp=gpar(fontsize=14, fontface="bold"))

title_acc <- textGrob("Acceptance", gp=gpar(fontsize=14, fontface="bold"), rot=90)
title_rej <- textGrob("Rejection", gp=gpar(fontsize=14, fontface="bold"), rot=90)
title_diff <- textGrob("Acceptance > \nRejection", gp=gpar(fontsize=14, fontface="bold"), rot=90)

chanlocs <- chanlocs %>%
  mutate(electrode = case_match(electrode, "Poz" ~ "POz",
                          .default=electrode))

chanlocs2 <- chanlocs %>%
  mutate(electrode = ifelse(chanlocs$electrode %in% c("Pz", "Cz"), 
                             chanlocs$electrode, 
                             NA))


plot1 <- topoplot(ga_acc,time_lim=c(150,275), chanLocs=chanlocs, contour=TRUE, interp_limit="skirt", chan_marker="none", scaling=scaling_factor, fill_title="", verbose=FALSE) +
 annotate("text", x=1, y=45, label = "Fz", color = "black", size=3) +
 annotate("text", x=1, y=0, label = "Cz", color = "black", size=3) +
  annotate("text", x=1, y=-45, label = "Pz", color = "black", size=3)
plot2 <- topoplot(ga_acc,time_lim=c(275,425), chanLocs=chanlocs, contour=TRUE, interp_limit="skirt", chan_marker="none", scaling=scaling_factor, verbose=FALSE) +
 annotate("text", x=1, y=45, label = "Fz", color = "black", size=3) +
 annotate("text", x=1, y=0, label = "Cz", color = "black", size=3) +
  annotate("text", x=1, y=-45, label = "Pz", color = "black", size=3)

plot3 <- topoplot(ga_rej,time_lim=c(150,275), chanLocs=chanlocs, contour=TRUE, interp_limit="skirt", chan_marker="none", scaling=scaling_factor, fill_title="", verbose=FALSE) +
 annotate("text", x=1, y=45, label = "Fz", color = "black", size=3) +
 annotate("text", x=1, y=0, label = "Cz", color = "black", size=3) +
  annotate("text", x=1, y=-45, label = "Pz", color = "black", size=3)
plot4 <- topoplot(ga_rej,time_lim=c(275,425), chanLocs=chanlocs, contour=TRUE, interp_limit="skirt", chan_marker="none", scaling=scaling_factor, verbose=FALSE) +
 annotate("text", x=1, y=45, label = "Fz", color = "black", size=3) +
 annotate("text", x=1, y=0, label = "Cz", color = "black", size=3) +
  annotate("text", x=1, y=-45, label = "Pz", color = "black", size=3)

plot5 <- topoplot(ga_diff,time_lim=c(150,275), chanLocs=chanlocs, contour=TRUE, interp_limit="skirt", chan_marker="none", scaling=scaling_factor, fill_title="", verbose=FALSE) +
 annotate("text", x=1, y=45, label = "Fz", color = "black", size=3) +
 annotate("text", x=1, y=0, label = "Cz", color = "black", size=3) +
  annotate("text", x=1, y=-45, label = "Pz", color = "black", size=3)
plot6 <- topoplot(ga_diff,time_lim=c(275,425), chanLocs=chanlocs, contour=TRUE, interp_limit="skirt", chan_marker="none", scaling=scaling_factor, verbose=FALSE) +
 annotate("text", x=1, y=45, label = "Fz", color = "black", size=3) +
 annotate("text", x=1, y=0, label = "Cz", color = "black", size=3) +
  annotate("text", x=1, y=-45, label = "Pz", color = "black", size=3)

grid.arrange(textGrob(""), title_rewp, title_p300,
             title_acc,plot1,plot2,
             title_rej,plot3,plot4,
             title_diff,plot5,plot6,
             layout_matrix = rbind(seq(1,3), seq(4,6), seq(7,9), seq(10,12)),
             heights = c(0.1, 1, 1, 1),
             widths = c(0.2, 1, 1)
)
```

```{r, results='asis', include=TRUE}
spearman_brown <- spearman_brown_raw %>%
  select(-X,-AR_AA) %>%
  filter(`Time_windows`!="Fz 50-150ms")
spearman_brown[,1] <- c("RewP", "P300")
colnames(spearman_brown) <- c("ERP Component","HV Acceptance","HV Rejection","LV Acceptance","LV Rejection","HV Acceptance > \nHV Rejection")
spearman_brown <- t(spearman_brown)
colnames(spearman_brown) <- spearman_brown[1,]
spearman_brown <- spearman_brown[-1,]

apa_table(spearman_brown,
          note="HV= High-value peer, LV= Low-value peer",
          caption="Spearman Brown coefficients of split-half reliability for each ERP component")
```

```{r, results='asis', include=TRUE}
dependability <- data.frame(Condition = c("HV Acceptance","HV Rejection","LV Acceptance","LV Rejection"),
           RewP = c(13, 11, 11, 13),
           P300 = c(15, 13, 14, 14),
           RewP = c(0.81, 0.82, 0.82, 0.80),
           P300 = c(0.79, 0.80, 0.80, 0.80))

apa_table(dependability,
  col_spanners=list(
    "Trials for 70\\% dependability" = c(2, 3),
    "Overall dependability" = c(4, 5)),
  col.names = c("Condition","RewP","P300","RewP","P300"),
  caption="Number of trials needed to achieve at least 70% dependability, and overall dependability of RewP and P300 up to 25 trials each.",
  note = "HV = high-value peer, LV = low-value peer.",
  align = c("p{3.5cm}", rep("p{2cm}", 4))
)
```

## In-task emotional response ratings

For low-value peers, participants rated being rejected as feeling better than being accepted.
Although seemingly counter-intuitive, previous work suggests that this likely reflects participants feeling good that they were “right”--i.e., that they rejected the person who rejected them—and feeling guilty when they were “wrong”—-i.e., rejected someone who accepted them [@distefanoComparisonElectrocorticalResponse2018; @quarmleyKnewYouWerent2019].

```{r}
df_BUDS_rating_it_pt2 <- df_BUDS_rating_it_pt %>%
    dplyr::group_by(ID, Condition) %>%
    dplyr::summarise(rating=mean(rating)) %>%
    dplyr::ungroup() %>%
    pivot_wider(names_from = Condition, values_from = rating, id_cols = ID) %>%
  filter(complete.cases(Acc_Acc)) %>%
  mutate(beh_AA_AR_z = scale(residuals(lm(Acc_Acc ~ Acc_Rej, .)), center=T, scale=T),
         beh_AR_AA_z = scale(residuals(lm(Acc_Rej ~ Acc_Acc, .)), center=T, scale=T),
         beh_RA_RR_z = scale(residuals(lm(Rej_Acc ~ Rej_Rej, .)), center=T, scale=T),
         beh_AA_RA_z = scale(residuals(lm(Acc_Acc ~ Rej_Acc, .)), center=T, scale=T)) %>%
  select(ID, starts_with("beh_"))

df_BUDS_rating_it_pt_demo <- df_BUDS_rating_it_pt2 %>%
  left_join(df_50150_fz, by="ID")

df_BUDS_rating_it_pt_ema <- df_BUDS_rating_it_pt2 %>%
    full_join(df_50150_fz_ema, by="ID") %>%
    mutate(na_cubert = na^(1/3))

ratings_ses_model_AA_AR <- ses_lm(df_BUDS_rating_it_pt_demo, beh_AA_AR_z)
ratings_ses_model_AR_AA <- ses_lm(df_BUDS_rating_it_pt_demo, beh_AR_AA_z)

model_behavioral_rating_ses_ema_na <- glmmTMB(na_cubert ~ ADI_NATRANK_z*beh_AA_AR_z + Age_c + demo_child_sex  + StressCT_z + StressTH_z + IDAS_depression_z + IDAS_anxiety_z + site + (1 | ID),
                zi = ~ .,
  data = df_BUDS_rating_it_pt_ema,
  family=gaussian, REML=TRUE)
model_behavioral_rating_ses_ema_na_p <- tidy(model_behavioral_rating_ses_ema_na) %>% filter(effect=="fixed",component=="cond",term=="ADI_NATRANK_z:beh_AA_AR_z") %>% select(p.value)

model_behavioral_rating_ses_ema_pa <- glmmTMB(pa ~ ADI_NATRANK_z*beh_AA_AR_z + Age_c + demo_child_sex + site + (1 | ID),
  data = df_BUDS_rating_it_pt_ema,
  family=gaussian, REML=TRUE)
model_behavioral_rating_ses_ema_pa_p <- tidy(model_behavioral_rating_ses_ema_pa) %>% filter(effect=="fixed",component=="cond",term=="ADI_NATRANK_z:beh_AA_AR_z") %>% select(p.value)
```

### SES associations with in-task emotional response ratings

Residualized scores assessing ratings to acceptance relative to ratings to rejection were not significantly associated with SES (`r apa_printlm(ratings_ses_model_AA_AR)$full_result$ADI_NATRANK_z`. SES also did not moderate the association between emotional ratings to feedback and EMA negative affect (Rating to acceptance~resid~: p=`r round(model_behavioral_rating_ses_ema_na_p$p.value,2)`).

## Brain responses to peer feedback

### Task effects: Feedback x Value interaction

```{r}
erp_to_long <- function(data) {
  data %>%
  pivot_longer(cols=c("Acc_Acc","Acc_Rej","Rej_Acc","Rej_Rej"), names_sep = "_", names_to = c("Voting","Feedback"), values_to = "ERP")
}
df_150275_cz_long <- erp_to_long(df_150275_cz)
df_275425_pz_long <- erp_to_long(df_275425_pz)

rewp_fv_mlm <- lmer(formula = ERP ~ Feedback*Voting + site + (1 | ID), REML=TRUE, data = df_150275_cz_long)
p300_fv_mlm <- lmer(formula = ERP ~ Feedback*Voting + site + (1 | ID), REML=TRUE, data = df_275425_pz_long)

ttest_rewp_hv <- t.test(df_150275_cz$Acc_Acc, df_150275_cz$Acc_Rej, paired=TRUE)
ttest_rewp_lv <- t.test(df_150275_cz$Rej_Acc, df_150275_cz$Rej_Rej, paired=TRUE)
ttest_p3_hv <- t.test(df_275425_pz$Acc_Acc, df_275425_pz$Acc_Rej, paired=TRUE)
ttest_p3_lv <- t.test(df_275425_pz$Rej_Acc, df_275425_pz$Rej_Rej, paired=TRUE)

d_rewp_hv <- paste0("Cohen's D=",round(cohensD(df_150275_cz$Acc_Acc, df_150275_cz$Acc_Rej, method="paired"),2))
d_rewp_lv <- paste0("Cohen's D=",round(cohensD(df_150275_cz$Rej_Acc, df_150275_cz$Rej_Rej, method="paired"),2))
d_p3_hv <- paste0("Cohen's D=",round(cohensD(df_275425_pz$Acc_Acc, df_275425_pz$Acc_Rej, method="paired"),2))
d_p3_lv <- paste0("Cohen's D=",round(cohensD(df_275425_pz$Rej_Acc, df_275425_pz$Rej_Rej, method="paired"),2))
```

Omnibus MLMs showed that Peer value interacted with Feedback type to predict ERP mean amplitude for the RewP (`r apa_print(rewp_fv_mlm, est_name="\\beta")$full_result$FeedbackRej_VotingRej`) and P300 (`r apa_print(p300_fv_mlm, est_name="\\beta")$full_result$FeedbackRej_VotingRej`).
Follow-up analyses showed that the RewP (`r paste0(d_rewp_lv, ", ", apa_printt(ttest_rewp_lv)$full_result)`) and P300 (`r paste0(d_p3_lv, ", ", apa_printt(ttest_p3_lv)$full_result)`) were larger to acceptance than rejection for low-value peers.
Only the RewP was larger to acceptance than rejection for high-value peers (`r paste0(d_rewp_hv, ", ", apa_printt(ttest_rewp_hv)$full_result)`), but not the P300 (`r paste0(d_p3_hv, ", ", apa_printt(ttest_p3_hv)$full_r)`).

```{r}
## REWP
mean_ses <- mean(df_150275_cz$ADI_NATRANK_z, na.rm=TRUE)
sd_ses <- sd(df_150275_cz$ADI_NATRANK_z, na.rm=TRUE)
SES_list <- list(ADI_NATRANK_z=round(c(mean_ses + sd_ses,mean_ses - sd_ses),2)) 

m_rewp_idas_acc <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_z + demo_child_sex + StressCT_z + StressTH_z + IDAS_depression + IDAS_anxiety + site + (1 | ID),
        zi = ~ .,
  data = df_150275_cz_ema,
  family=gaussian, REML=TRUE)

m_rewp_acc_idas_ss <- emtrends(m_rewp_idas_acc, pairwise ~ADI_NATRANK_z, var="AA_AR_z",at=SES_list, adjust="none")|> test()

## P300
mean_ses <- mean(df_275425_pz$ADI_NATRANK_z, na.rm=TRUE)
sd_ses <- sd(df_275425_pz$ADI_NATRANK_z, na.rm=TRUE)
SES_list <- list(ADI_NATRANK_z=round(c(mean_ses + sd_ses,mean_ses - sd_ses),2)) 

m_p300_idas_acc <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_c + demo_child_sex + StressCT_z + StressTH_z + IDAS_depression + IDAS_anxiety + site + (1 | ID),
        zi = ~ .,
  data = df_275425_pz_ema,
  family=gaussian, REML=TRUE)

m_p300_acc_idas_ss <- emtrends(m_p300_idas_acc, pairwise ~ADI_NATRANK_z, var="AA_AR_z",at=SES_list, adjust="none")|> test()
```

```{r include=TRUE, results='asis'}
model_150275_ema_na_table <- tidy(m_rewp_idas_acc,component="cond", conf.int=TRUE) %>%
  mutate(ci = paste0("[",sprintf("%.3f",conf.low),", ",sprintf("%.3f",conf.high),"]")) %>% # make 95% CI variable
  select(term,estimate,ci,p.value) %>%
  filter(row_number() <= n()-2) %>% # remove random effects
  mutate(term=c("Intercept","SES","RewP\\textsubscript{resid}",
                "Age","Sex",
                "Stressor count","Stressor severity",
                "Depression symptoms","Anxiety symptoms","Site","SES x RewP\\textsubscript{resid}"),
         p.value = ifelse(p.value < 0.001, "<0.001", as.character(sprintf("%.3f",p.value))))

model_275425_ema_na_table <- tidy(m_p300_idas_acc,component="cond", conf.int=TRUE) %>%
  mutate(ci = paste0("[",sprintf("%.3f",conf.low),", ",sprintf("%.3f",conf.high),"]")) %>% # make 95% CI variable
  select(term,estimate,ci,p.value) %>%
  filter(row_number() <= n()-2) %>% # remove random effects
  mutate(term=c("Intercept","SES","P300\\textsubscript{resid}",
                                "Age","Sex",
                "Stressor count","Stressor severity",
                "Depression symptoms","Anxiety symptoms","Site","SES x P300\\textsubscript{resid}"),
         p.value = ifelse(p.value < 0.001, "<0.001", as.character(sprintf("%.3f",p.value))))

apa_table(list(`RewP\\textsubscript{resid}`=model_150275_ema_na_table,
               `P300\\textsubscript{resid}`=model_275425_ema_na_table),
          col.names=c("Predictor", "$\\beta$","95\\% CI","\\textit{p} value"),
          digits=3, escape=FALSE,
          caption="Fixed effects from MLM models predicting EMA reported negative affect, including stressful life events and depression and anxiety symptoms as covariates.")
```

### Including only those that reported belief in deception

#### SES associations with RewP~resid~ and P300~resid~

```{r, eval=TRUE}
load(file=here("../data/BUDS_behavior.RData"))

df_150275_cz_dec <- df_150275_cz_rating %>%
  select(ID, SP_debriefing_deceived_f) %>%
  full_join(df_150275_cz, by="ID") %>%
  filter(SP_debriefing_deceived_f==1)

df_275425_pz_dec <- df_275425_pz_rating %>%
  select(ID, SP_debriefing_deceived_f) %>%
  full_join(df_275425_pz, by="ID") %>%
  filter(SP_debriefing_deceived_f==1)

ses_lm_dec <- function(data, y) {
  y <- enquo(y)

  model_formula <- formula(paste0(quo_name(y), "~ ADI_NATRANK_z + site + Age_z + demo_child_sex + StressCT_z + StressTH_z + IDAS_depression_z + IDAS_anxiety_z"))
  lm(model_formula, data = data)
}

rewp_aaar_model <- ses_lm_dec(df_150275_cz_dec, AA_AR_z)
p3_aaar_model <- ses_lm_dec(df_275425_pz_dec, AA_AR_z)
```

When excluding those who did not endorse being deceived, SES was still significantly, positively related to RewP~resid~ and P300~resid~ to acceptance (`r lm_results(rewp_aaar_model, "ADI_NATRANK_z")`; `r lm_results(p3_aaar_model, "ADI_NATRANK_z")`, respectively).

```{r}
df_150275_cz_ema_dec <- df_150275_cz_ema %>%
  group_by(ID,daysFrom,slot) %>%
  arrange(tm_start) %>%
  filter(row_number()==1) %>%
  arrange(ID,daysFrom,tm_start) %>%
  full_join(df_150275_cz_rating, by="ID")

df_275425_pz_ema_dec <- df_275425_pz_ema %>%
  group_by(ID,daysFrom,slot) %>%
  arrange(tm_start) %>%
  filter(row_number()==1) %>%
  arrange(ID,daysFrom,tm_start) %>%
  full_join(df_275425_pz_rating, by="ID")
```

#### SES moderation of associations between RewP~resid~/P300~resid~ and negative affect

```{r}
model_150275_ema_na_dec <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_z + demo_child_sex + site + (1 | ID),
                zi = ~ .,
  data = df_150275_cz_ema_dec,
  family=gaussian, REML=TRUE)

model_275425_ema_na_dec <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_z + demo_child_sex + site + (1 | ID),
                                   zi = ~ .,
  data = df_275425_pz_ema_dec,
  family=gaussian, REML=TRUE)
```

```{r}
rewp_na_stat_dec <- c(broom.mixed::tidy(model_150275_ema_na_dec) %>% 
                    filter(effect == "fixed", component == "cond", term == "ADI_NATRANK_z:AA_AR_z"),
                  as.data.frame(confint(model_150275_ema_na_dec)) %>% 
                    rownames_to_column("row_name") %>% 
                    filter(row_name == "cond.ADI_NATRANK_z:AA_AR_z") %>% 
                       mutate(lower = round3(`2.5 %`), upper=round3(`97.5 %`)) %>% 
                       select(lower,upper))

p300_na_stat_dec <- c(broom.mixed::tidy(model_275425_ema_na_dec) %>%
                    filter(effect == "fixed", component == "cond", term == "ADI_NATRANK_z:AA_AR_z"),
                  as.data.frame(confint(model_275425_ema_na_dec)) %>%
                    rownames_to_column("row_name") %>%
                    filter(row_name == "cond.ADI_NATRANK_z:AA_AR_z") %>%
                       mutate(lower = round3(`2.5 %`), upper=round3(`97.5 %`)) %>%
                       select(lower,upper))
```

When excluding those who did not endorse deception, SES continued to significantly moderate the relationship between EMA-assessed negative affect and RewP~resid~ to acceptance ($\beta$=`r rewp_na_stat_dec$estimate`, 95% CI=[`r paste0(rewp_na_stat_dec$lower,", ", rewp_na_stat_dec$upper)`], *p*=`r round3(rewp_na_stat_dec$p.value)`), and the relationship between negative affect and the P300~resid~ to acceptance ($\beta$=`r p300_na_stat_dec$estimate`, 95% CI=[`r paste0(p300_na_stat_dec$lower,", ",p300_na_stat_dec$upper)`], *p*=`r round3(p300_na_stat_dec$p.value)`).

```{r}
## REWP
######## ACC > REJ ######## 
mean_ses <- mean(df_150275_cz_ema_dec$ADI_NATRANK_z, na.rm=TRUE)
sd_ses <- sd(df_150275_cz_ema_dec$ADI_NATRANK_z, na.rm=TRUE)
SES_list <- list(ADI_NATRANK_z=round(c(mean_ses + sd_ses,mean_ses - sd_ses),2)) 

m_rewp_acc_dec <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_z + demo_child_sex + site + (1 | ID),
        zi = ~ .,
  data = df_150275_cz_ema_dec,
  family=gaussian, REML=TRUE)

m_rewp_acc_dec_ss <- emtrends(m_rewp_acc_dec, pairwise ~ADI_NATRANK_z, var="AA_AR_z",at=SES_list, adjust="none")|> test()

## P300
mean_ses <- mean(df_275425_pz_ema_dec$ADI_NATRANK_z, na.rm=TRUE)
sd_ses <- sd(df_275425_pz_ema_dec$ADI_NATRANK_z, na.rm=TRUE)
SES_list <- list(ADI_NATRANK_z=round(c(mean_ses + sd_ses,mean_ses - sd_ses),2)) 
######## ACC > REJ ######## 
m_p300_acc_dec <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_z + demo_child_sex + site + (1 | ID),
        zi = ~ .,
  data = df_275425_pz_ema_dec,
  family=gaussian, REML=TRUE)

m_p300_acc_dec_ss <- emtrends(m_p300_acc_dec, pairwise ~ADI_NATRANK_z, var="AA_AR_z",at=SES_list, adjust="none")|> test()
```

Follow-up simple slope analyses excluding those who did not endorse deception were consistent with results: no simple slopes were significant for the SES x RewP~resid~ interaction (*p*$\ge$ `r round3(min(m_rewp_acc_dec_ss$emtrends[,6]))`), but were significant for the SES x P300~resid~ such that lower SES was associated with a more negative relationship between P300~resid~ to acceptance and subsequent negative affect (*b*=`r round3(m_p300_acc_dec_ss$emtrends[2,2])`, *p*=`r round3(m_p300_acc_dec_ss$emtrends[2,6])`).
<p>&nbsp;</p>
<p>&nbsp;</p>
# References

::: {#refs custom-style="Bibliography"}
:::
