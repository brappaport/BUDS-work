---
title             : "Socioeconomic status and adolescent brain responses to peer feedback: Testing the impact on negative affect"
shorttitle    : "SES & brain responses to peer feedback"

author: 
  - name          : "Brent I. Rappaport"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "680 N. Lakeshore Drive, Suite 1520, Chicago, IL 60611"
    email         : "brent.rappaport@northwestern.edu"
    role:         # Contributorship roles (e.g., CRediT, https://casrai.org/credit/)
      - "Conceptualization"
      - "Formal analysis"
      - "Writing - Original Draft Preparation"
      - "Writing - Review & Editing"
  - name          : "James E. Glazer"
    affiliation   : "1"
    role:
      - "Methodology"
      - "Writing - Review & Editing"
  - name          : "Allison M. Letkiewicz"
    affiliation   : "1"
    role:
      - "Writing - Review & Editing"
  - name          : "Lilian Li"
    affiliation   : "1"
    role:
      - "Methodology"
      - "Writing - Review & Editing"
  - name          : "Madeline M. McGregor"
    affiliation   : "1"
    role:
      - "Writing - Review & Editing"
  - name          : "Lili Massac"
    affiliation   : "2"
    role:
      - "Writing - Review & Editing"
  - name    : "Katherine Durham"
    affiliation : "2"
    role:
    - "Writing - Review & Editing"
  - name          : "Randy Auerbach"
    affiliation   : "2"
    role:
      - "Conceptualization"
      - "Fundind acquisition"
      - "Investigation"
      - "Methodology"
      - "Resources"
      - "Supervision"
      - "Writing - Review & Editing"
  - name          : "Stewart A. Shankman"
    affiliation   : "1"
    role:
      - "Conceptualization"
      - "Fundind acquisition"
      - "Investigation"
      - "Methodology"
      - "Resources"
      - "Supervision"
      - "Writing - Review & Editing"

affiliation:
  - id            : "1"
    institution   : "Department of Psychiatry, Feinberg School of Medicine, Northwestern University"
  - id            : "2"
    institution   : "Columbia University"


bibliography      : "BUDS.bib"
floatsintext      : no
linenumbers       : no
draft             : no
mask              : no
figurelist        : no
tablelist         : no
footnotelist      : no
csl               : "`r system.file('rmd', 'apa7.csl', package = 'papaja')`"
documentclass     : "apa7"
output            : papaja::apa6_pdf
editor_options: 
  markdown: 
    wrap: sentence
    
header-includes:
    - \raggedbottom
---

```{r analysis-preferences}
knitr::opts_chunk$set(set.seed(312), warning=FALSE, message=FALSE, include=FALSE, cache=TRUE)
    options(width=80, Ncpus = 6, mc.cores=6, max.print=1000000, scipen = 999) #Set width, multiple cores, and not to use scientific notation
    rm(list=ls())     #Remove everything from environment
    cat("\014")       #Clear Console

  # library(knitr)      #allows rmarkdown files
  library(haven)      #helps import stata
  library(expss)      #labeling variables/values
  library(broom)      #nice statistical output
  library(here)       #nice file paths
  library(psych)      #used for statistical analyses
  library(Hmisc)
  library(purrr)
  library(haven)      #to import SPSS files
  library(MASS)       #to create residualized scores
# Models
  library(lmerTest)
  library(glmmTMB)
# Plotting
  library(ggplot2)    #creates plots
  library(ggpubr)
  library(ggeffects)
  library(sjPlot)
  library(sjPlot)
  library(marginaleffects)
  library(interactions)
  library(emmeans) # testing simple slopes
    
  library(eegUtils)
  library(gridExtra)
    
  library(datawizard)
  library(performance)
  library(Rmisc)
  library(vtable)
  library(grid)
  library(broom.mixed)
# General tools
  library(tidyverse)  #plotting/cleaning, etc.
  library(papaja)
  library(workflowr)  #helps with workflow

here <- here::here
r_refs("BUDS.bib")
```

```{r Load data}
here::i_am("BUDS_manuscript_working.Rmd")

load(file=here::here("../data/BUDS_do02.RData")) # ERP and self-report data
load(file=here("../data/BUDS_behavior.RData")) # ERP behavioral data
load(file=here("../data/BUDS_do03_gaplots.RData")) # Grand average data
spearman_brown <- read.csv(file=here("../tables/spearman_brown.csv")) # Internal consistency table
```

```{r Functions}
# from https://www.r-bloggers.com/2020/07/create-a-publication-ready-correlation-matrix-with-significance-levels-in-r/

correlation_matrix <- function(df,
                               type = "pearson",
                               digits = 3,
                               decimal.mark = ".",
                               use = "all",
                               show_significance = TRUE,
                               replace_diagonal = FALSE,
                               replacement = ""){
  
  # check arguments
  stopifnot({
    is.numeric(digits)
    digits >= 0
    use %in% c("all", "upper", "lower")
    is.logical(replace_diagonal)
    is.logical(show_significance)
    is.character(replacement)
  })
  # we need the Hmisc package for this
  require(Hmisc)
  
  # retain only numeric and boolean columns
  isNumericOrBoolean = vapply(df, function(x) is.numeric(x) | is.logical(x), logical(1))
  if (sum(!isNumericOrBoolean) > 0) {
    cat('Dropping non-numeric/-boolean column(s):', paste(names(isNumericOrBoolean)[!isNumericOrBoolean], collapse = ', '), '\n\n')
  }
  df = df[isNumericOrBoolean]
  
  # transform input data frame to matrix
  x <- as.matrix(df)
  
  # run correlation analysis using Hmisc package
  correlation_matrix <- Hmisc::rcorr(x, type = )
  R <- correlation_matrix$r # Matrix of correlation coeficients
  p <- correlation_matrix$P # Matrix of p-value
  
  # transform correlations to specific character format
  Rformatted = formatC(R, format = 'f', digits = digits, decimal.mark = decimal.mark)
  
  # if there are any negative numbers, we want to put a space before the positives to align all
  if (sum(R < 0) > 0) {
    Rformatted = ifelse(R > 0, paste0(' ', Rformatted), Rformatted)
  }
  
  # add significance levels if desired
  if (show_significance) {
    # define notions for significance levels; spacing is important.
    stars <- ifelse(is.na(p), "   ", ifelse(p < .001, "***", ifelse(p < .01, "** ", ifelse(p < .05, "*  ", "   "))))
    Rformatted = paste0(Rformatted, stars)
  }
  # build a new matrix that includes the formatted correlations and their significance stars
  Rnew <- matrix(Rformatted, ncol = ncol(x))
  rownames(Rnew) <- colnames(x)
  colnames(Rnew) <- paste(colnames(x), "", sep =" ")
  
  # replace undesired values
  if (use == 'upper') {
    Rnew[lower.tri(Rnew, diag = replace_diagonal)] <- replacement
  } else if (use == 'lower') {
    Rnew[upper.tri(Rnew, diag = replace_diagonal)] <- replacement
  } else if (replace_diagonal) {
    diag(Rnew) <- replacement
  }
  
  return(Rnew)
}

lmer_adi_interaction_table <- function(data) {
  new_model <- data.frame(model = c("Both","Like","Dislike"),
                            beta = NA, 
                            p = NA)
new_model$beta <- c(broom.mixed::tidy(lmer(formula = ERP ~ Feedback*Voting*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = data))[8,4], broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Like")))[4,4],
                        broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Dislike")))[4,4])

new_model$p <- c(broom.mixed::tidy(lmer(formula = ERP ~ Feedback*Voting*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = data))[8,8], broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Like")))[4,8],
                        broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Dislike")))[4,8])
new_model
}

plot_stats <- function(model, var) {
  temp_stats <- tidy(model) %>% 
    dplyr::filter(term==var) %>%
    dplyr::select(estimate,p.value) %>%
    round(., 3)
  paste0("b = ", temp_stats[1], ", p = ", temp_stats[2])
}
```

# Methods and Materials
## Participants
Informed assent and consent were obtained from the adolescent and parent, respectively, and adolescents 18 years or older provided consent. General inclusion criteria included: (a) Tanner Stage $\ge$ 3 (Tanner & Davies, 1985), (b) parental and child fluency in English, (c) Wechsler Abbreviated Scale of Intelligence-II (WASI-II) > 85 (Wechsler, 2011), (d) ownership of a personal smartphone (android or iOS), and (e) right-handedness. General exclusion criteria included: (a) history of head injury or neurological disorders, (b) current moderate or severe substance use disorder, and (c) lifetime history of bipolar or psychotic disorders, oppositional defiant disorder, conduct disorder, organic mental disorder, or developmental disorder. 

## ERP task effects
```{r, include=TRUE, fig.cap="Topographic maps of N1, RewP, and P300 to high-value peer acceptance, high-value peer rejection, high-value peer acceptance relative to high-value peer rejection."}

chanlocs <- electrode_locations(read.csv(here('../data/topo_plots/chanlocs32.csv')), montage="biosemi64")
ga_acc <- read.delim(here('../data/topo_plots/ga_highvalue_acceptance_AA (Acc-Acc).txt'))%>%
  pivot_longer(cols=c(-time),
               values_to ="amplitude", names_to="electrode")
ga_rej <- read.delim(here('../data/topo_plots/ga_highvalue_rejection_AR (Acc-Rej).txt'))%>%
  pivot_longer(cols=c(-time),
               values_to ="amplitude", names_to="electrode")
ga_diff <- read.delim(here('../data/topo_plots/ga_highvalue_acc_rej_difference_BIN5=B1-B2.txt'))%>%
  pivot_longer(cols=c(-time),
               values_to ="amplitude", names_to="electrode")

scaling_factor=0.7
# Create grobs for the column titles
title_n1 <- textGrob("N1", gp=gpar(fontsize=14, fontface="bold"))
title_rewp <- textGrob("RewP", gp=gpar(fontsize=14, fontface="bold"))
title_p300 <- textGrob("P300", gp=gpar(fontsize=14, fontface="bold"))

title_acc <- textGrob("Acceptance", gp=gpar(fontsize=14, fontface="bold"), rot=90)
title_rej <- textGrob("Rejection", gp=gpar(fontsize=14, fontface="bold"), rot=90)
title_diff <- textGrob("Acceptance > \nRejection", gp=gpar(fontsize=14, fontface="bold"), rot=90)

chanlocs <- chanlocs %>%
  mutate(electrode = case_match(electrode, "Poz" ~ "POz",
                          .default=electrode))

plot1 <- topoplot(ga_acc, time_lim=c(50,150), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor)
plot2 <- topoplot(ga_rej,time_lim=c(50,150), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor)
plot3 <- topoplot(ga_diff,time_lim=c(50,150), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor)
plot4 <- topoplot(ga_acc,time_lim=c(150,275), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor)
plot5 <- topoplot(ga_rej,time_lim=c(150,275), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor)
plot6 <- topoplot(ga_diff,time_lim=c(150,275), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor)
plot7 <- topoplot(ga_acc,time_lim=c(275,425), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor)
plot8 <- topoplot(ga_rej,time_lim=c(275,425), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor)
plot9 <- topoplot(ga_diff,time_lim=c(275,425), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor)

blank <- textGrob("")
grid.arrange(blank, title_n1, title_rewp, title_p300,
             title_acc,plot1,plot2,plot3,
             title_rej,plot4,plot5,plot6,
             title_diff,plot7,plot8,plot9,
             layout_matrix = rbind(seq(1,4), seq(5,8), seq(9,12), seq(13,16)),
             heights = c(0.1, 1, 1, 1),
             widths = c(0.2, 1, 1, 1)
)
```


# Results
## Behavioral ratings
### Post-task ratings
```{r}
post_task_table <- st(dplyr::select(df_BUDS_rating_it_pt, SP_debriefing_interested:SP_debriefing_nervous,SP_debriefing_socialmediause),
                      out="return")[,-c(5:8)] %>%
  mutate(Measure=c("Interested","Happy","Upset","Angry","Nervous","Social Media Use")) %>%
  dplyr::select(-Variable, -N) %>%
  dplyr::select(Measure, everything())
```
```{r, results='asis', include=TRUE}
apa_table(post_task_table)
```

Of note, for low-value peers, participants rated being rejected as feeling *better* than being accepted. Although seemingly counter-intuitive, previous work suggests that this is likely reflects participants feeling good that they were "right"---that they rejected the person who rejected them---and feeling guilty when they were "wrong"---rejected someone who accepted them [@distefanoComparisonElectrocorticalResponse2018].

# Internal consistency
```{r, results='asis', include=TRUE}
spearman_brown <- spearman_brown[,-1]
spearman_brown[,1] <- c("N1", "RewP", "P300")
colnames(spearman_brown) <- c("ERP Component","HV Acceptance","HV Rejection","LV Acceptance","LV Rejection","HV Acceptance > \nHV Rejection","HV Rejection > \nHV Acceptance")

apa_table(spearman_brown,
          note="HV= High-value peer, LV= Low-value peer")
```

# Dependability

```{r, results='asis', include=TRUE}
dependability <- data.frame(Condition = c("HV Acceptance","HV Rejection","LV Acceptance","LV Rejection"),
           RewP = c(13, 11, 11, 13),
           P300 = c(15, 13, 14, 14),
           RewP = c(0.81, 0.82, 0.82, 0.80),
           P300 = c(0.79, 0.80, 0.80, 0.80))

apa_table(dependability,
  col_spanners=list(
    "Minimum trials to achieve 70% depedability" = c(2, 3),
    "Overall dependability" = c(4, 5)),
  caption="Dependability of RewP and P300. N1 did not achieve acceptance (70%) dependaility at any number of trials (up to 25). HV = high-value peer, LV = low-value peer."
)
```

# Covaring for belief in deception
## SES associations with RewP~resid~ and P300~resid~
```{r, eval=T}
load(file=here("../data/BUDS_behavior.RData"))

df_150275_cz_dec <- df_150275_cz_rating %>%
  select(ID, SP_debriefing_deceived_f) %>%
  full_join(df_150275_cz, by="ID")

df_275425_pz_dec <- df_275425_pz_rating %>%
  select(ID, SP_debriefing_deceived_f) %>%
  full_join(df_275425_pz, by="ID")

df_275425_pz_dec[is.na(df_275425_pz_dec$SP_debriefing_deceived_f),"ID"]

ses_lm_dec <- function(data, y) {
  y <- enquo(y)

  model_formula <- formula(paste0(quo_name(y), "~ ADI_NATRANK_z + site + Age_c + demo_child_sex + StressCT + StressTH + IDAS_depression + IDAS_anxiety + SP_debriefing_deceived_f"))
  lm(model_formula, data = data)
}

rewp_aaar_model <- ses_lm_dec(df_150275_cz_dec, AA_AR_z)
p3_aaar_model <- ses_lm_dec(df_275425_pz_dec, AA_AR_z)
```
When covarying for self-reported deception, SES was still significantly, positively related to RewP~resid~ and P300~resid~ to acceptance (`r apa_print(rewp_aaar_model)$full_result$ADI_NATRANK_z`, `r apa_print(p3_aaar_model)$full_result$ADI_NATRANK_z`, respectively).

```{r}
df_150275_cz_ema_dec <- df_150275_cz_ema %>%
  group_by(ID,daysFrom,slot) %>%
  arrange(tm_start) %>%
  filter(row_number()==1) %>%
  arrange(ID,daysFrom,tm_start) %>%
  full_join(df_150275_cz_rating, by="ID")

df_275425_pz_ema_dec <- df_275425_pz_ema %>%
  group_by(ID,daysFrom,slot) %>%
  arrange(tm_start) %>%
  filter(row_number()==1) %>%
  arrange(ID,daysFrom,tm_start) %>%
  full_join(df_275425_pz_rating, by="ID")
```

## SES moderates association between RewP~resid~/P300~resid~ and negative affect

```{r}
model_150275_ema_na_dec <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_c + demo_child_sex + SP_debriefing_deceived_f + (1 | site) + (1 | ID),
                zi = ~ .,
  data = df_150275_cz_ema_dec,
  family=gaussian, REML=TRUE)

model_150275_ema_na_ar_dec <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AR_AA_z + Age_c + demo_child_sex + SP_debriefing_deceived_f + (1 | site) + (1 | ID),
                zi = ~ .,
  data = df_150275_cz_ema_dec,
  family=gaussian, REML=TRUE)

model_275425_ema_na_dec <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_c + demo_child_sex + SP_debriefing_deceived_f + (1 | site) + (1 | ID),
                                   zi = ~ .,
  data = df_275425_pz_ema_dec,
  family=gaussian, REML=TRUE)

model_275425_ema_na_ar_dec <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AR_AA_z + Age_c + demo_child_sex + SP_debriefing_deceived_f + (1 | site) + (1 | ID),
                                   zi = ~ .,
  data = df_275425_pz_ema_dec,
  family=gaussian, REML=TRUE)
```

```{r}
rewp_na_stat_dec <- c(broom.mixed::tidy(model_150275_ema_na_dec) %>% 
                    filter(effect == "fixed", component == "cond", term == "ADI_NATRANK_z:AA_AR_z"),
                  as.data.frame(confint(model_150275_ema_na_dec)) %>% 
                    rownames_to_column("row_name") %>% 
                    filter(row_name == "cond.ADI_NATRANK_z:AA_AR_z") %>% 
                       mutate(lower = round(`2.5 %`,2), upper=round(`97.5 %`,2)) %>% 
                       select(lower,upper))

rewp_na_ar_stat_dec <- c(broom.mixed::tidy(model_150275_ema_na_ar_dec) %>% 
                    filter(effect == "fixed", component == "cond", term == "ADI_NATRANK_z:AR_AA_z"),
                  as.data.frame(confint(model_150275_ema_na_ar_dec)) %>% 
                    rownames_to_column("row_name") %>% 
                    filter(row_name == "cond.ADI_NATRANK_z:AR_AA_z") %>% 
                       mutate(lower = round(`2.5 %`,2), upper=round(`97.5 %`,2)) %>% 
                       select(lower,upper))

p300_na_stat_dec <- c(broom.mixed::tidy(model_275425_ema_na_dec) %>%
                    filter(effect == "fixed", component == "cond", term == "ADI_NATRANK_z:AA_AR_z"),
                  as.data.frame(confint(model_275425_ema_na_dec)) %>%
                    rownames_to_column("row_name") %>%
                    filter(row_name == "cond.ADI_NATRANK_z:AA_AR_z") %>%
                       mutate(lower = round(`2.5 %`,2), upper=round(`97.5 %`,2)) %>%
                       select(lower,upper))

p300_na_ar_stat_dec <- c(broom.mixed::tidy(model_275425_ema_na_ar_dec) %>% 
                       filter(effect == "fixed", component == "cond", term == "ADI_NATRANK_z:AR_AA_z"),
                     as.data.frame(confint(model_275425_ema_na_ar_dec)) %>% 
                       rownames_to_column("row_name") %>% 
                       filter(row_name == "cond.ADI_NATRANK_z:AR_AA_z") %>% 
                       mutate(lower = round(`2.5 %`,2), upper=round(`97.5 %`,2)) %>% 
                       select(lower,upper))
```

When covarying for self-reported deception, SES no longer significantly moderated the relationship between EMA-assessed negative affect and RewP~resid~ to acceptance ($\beta$=`r rewp_na_stat_dec$estimate`, 95% CI=[`r paste0(rewp_na_stat_dec$lower,", ", rewp_na_stat_dec$upper)`], *p*=`r round(rewp_na_stat_dec$p.value,3)`), nor RewP~resid~ to rejection ($\beta$=`r round(rewp_na_ar_stat_dec$estimate,3)`, *p*=`r round(rewp_na_ar_stat_dec$p.value,3)`). SES continued to moderate the relationship between negative affect and the P300~resid~ to acceptance ($\beta$=`r p300_na_stat_dec$estimate`, 95% CI=[`r paste0(p300_na_stat_dec$lower,", ",p300_na_stat_dec$upper)`], *p*=`r round(p300_na_stat_dec$p.value,3)`) but not P300~resid~ to rejection ($\beta$=`r p300_na_ar_stat_dec$estimate`, 95% CI=[`r paste0(p300_na_ar_stat_dec$lower,", ",p300_na_ar_stat_dec$upper)`], *p*=`r round(p300_na_ar_stat_dec$p.value,3)`); see Figure 3).

```{r}
## REWP
######## ACC > REJ ######## 
mean_ses <- mean(df_150275_cz_ema_dec$ADI_NATRANK_z, na.rm=TRUE)
sd_ses <- sd(df_150275_cz_ema_dec$ADI_NATRANK_z, na.rm=TRUE)
SES_list <- list(ADI_NATRANK_z=round(c(mean_ses + sd_ses,mean_ses - sd_ses),2)) 

m_rewp_acc_dec <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_c + demo_child_sex + SP_debriefing_deceived_f + (1 | site) + (1 | ID),
        zi = ~ .,
  data = df_150275_cz_ema_dec,
  family=gaussian, REML=TRUE)

m_rewp_acc_dec_ss <- emtrends(m_rewp_acc_dec, pairwise ~ADI_NATRANK_z, var="AA_AR_z",at=SES_list, adjust="none")|> test()

## P300
mean_ses <- mean(df_275425_pz_ema_dec$ADI_NATRANK_z, na.rm=TRUE)
sd_ses <- sd(df_275425_pz_ema_dec$ADI_NATRANK_z, na.rm=TRUE)
SES_list <- list(ADI_NATRANK_z=round(c(mean_ses + sd_ses,mean_ses - sd_ses),2)) 
######## ACC > REJ ######## 
m_p300_acc_dec <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_c + demo_child_sex + SP_debriefing_deceived_f + (1 | site) + (1 | ID),
        zi = ~ .,
  data = df_275425_pz_ema_dec,
  family=gaussian, REML=TRUE)

m_p300_acc_dec_ss <- emtrends(m_p300_acc_dec, pairwise ~ADI_NATRANK_z, var="AA_AR_z",at=SES_list, adjust="none")|> test()
######## REJ > ACC ######## 
m_p300_rej_dec <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AR_AA_z + Age_c + demo_child_sex + SP_debriefing_deceived_f + (1 | site) + (1 | ID),
        zi = ~ .,
  data = df_275425_pz_ema_dec,
  family=gaussian, REML=TRUE)

m_p300_rej_dec_ss <- emtrends(m_p300_rej_dec, pairwise ~ADI_NATRANK_z, var="AR_AA_z",at=SES_list, adjust="none")|> test()
```

Follow-up simple slope analyses controlling for self-reported deception were consistent with results: no simple slopes were significant for the SES x RewP~resid~ interaction ($p\ge$ `r round(min(m_rewp_acc_dec_ss$emtrends[,6]),2)`), but were significant for the SES x P300~resid~ such that lower SES was associated with a more negative relationship between P300~resid~ to *acceptance* and subsequent negative affect (slope = `r round(m_p300_acc_dec_ss$emtrends[2,2],2)`, *p*=`r round(m_p300_acc_dec_ss$emtrends[2,6],2)`), and positive relationship between P300~resid~ to *rejection* and subsequent negative affect (slope = `r round(m_p300_rej_dec_ss$emtrends[2,2],2)`, *p*=`r round(m_p300_rej_dec_ss$emtrends[2,6],2)`).

# Covarying for positive affect
## SES moderates association between RewP~resid~/P300~resid~ and negative affect
```{r}
# DOESN'T CONVERGE
# model_150275_ema_na_pa <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_c + demo_child_sex + pa + (1 | site) + (1 | ID),
#                 zi = ~ .,
#   data = df_150275_cz_ema,
#   family=gaussian, REML=TRUE)

model_150275_ema_na_ar_pa <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AR_AA_z + Age_c + demo_child_sex + pa + (1 | site) + (1 | ID),
                zi = ~ .,
  data = df_150275_cz_ema,
  family=gaussian, REML=TRUE)

# DOESN'T CONVERGE
# model_275425_ema_na_pa <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_c + demo_child_sex + pa + (1 | site) + (1 | ID),
#                                    zi = ~ .,
#   data = df_275425_pz_ema,
#   family=gaussian, REML=TRUE)

model_275425_ema_na_ar_pa <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AR_AA_z + Age_c + demo_child_sex + pa + (1 | site) + (1 | ID),
                                   zi = ~ .,
  data = df_275425_pz_ema,
  family=gaussian, REML=TRUE)

p300_na_ar_pa_stat <- c(broom.mixed::tidy(model_275425_ema_na_ar_pa) %>% 
                       filter(effect == "fixed", component == "cond", term == "ADI_NATRANK_z:AR_AA_z"),
                     as.data.frame(confint(model_275425_ema_na_ar_pa)) %>% 
                       rownames_to_column("row_name") %>% 
                       filter(row_name == "cond.ADI_NATRANK_z:AR_AA_z") %>% 
                       mutate(lower = round(`2.5 %`,2), upper=round(`97.5 %`,2)) %>% 
                       select(lower,upper))
```

Models covarying for EMA reported positive affect do not converge for models testing SES moderating relationship between negative affect and RewP~resid~ or P300~resid~ to acceptance. However, SES continued to moderate the relationship between negative affect and the P300~resid~ to rejection ($\beta$=`r p300_na_ar_pa_stat$estimate`, 95% CI=[`r paste0(p300_na_ar_pa_stat$lower,", ",p300_na_ar_pa_stat$upper)`], *p*=`r round(p300_na_ar_pa_stat$p.value,3)`).

\newpage

# References

::: {#refs custom-style="Bibliography"}
:::
