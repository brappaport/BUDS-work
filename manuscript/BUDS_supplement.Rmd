---
title             : "Area deprivation, discrimination, and brain responses to social acceptance and rejection: Nuanced effects and relationship to negative affect"
shorttitle        : "___"

author: 
  - name          : "Brent I. Rappaport"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "680 N. Lakeshore Drive, Suite 1520, Chicago, IL 60611"
    email         : "brent.rappaport@northwestern.edu"
    role:         # Contributorship roles (e.g., CRediT, https://casrai.org/credit/)
      - "Conceptualization"
      - "Formal analysis"
      - "Writing - Original Draft Preparation"
      - "Writing - Review & Editing"
  - name          : "James E. Glazer"
    affiliation   : "1"
    role:
      - "Methodology"
      - "Writing - Review & Editing"
  - name          : "Lilian Li"
    affiliation   : "1"
    role:
      - "Methodology"
      - "Writing - Review & Editing"
  - name          : "Madeline M. McGregor"
    affiliation   : "1"
    role:
      - "Writing - Review & Editing"
  - name          : "Lili Massac"
    affiliation   : "2"
    role:
      - "Writing - Review & Editing"
  - name          : "Randy Auerbach"
    affiliation   : "2"
    role:
      - "Conceptualization"
      - "Fundind acquisition"
      - "Investigation"
      - "Methodology"
      - "Resources"
      - "Supervision"
      - "Writing - Review & Editing"
  - name          : "Stewart A. Shankman"
    affiliation   : "1"
    role:
      - "Conceptualization"
      - "Fundind acquisition"
      - "Investigation"
      - "Methodology"
      - "Resources"
      - "Supervision"
      - "Writing - Review & Editing"

affiliation:
  - id            : "1"
    institution   : "Department of Psychiatry, Feinberg School of Medicine, Northwestern University"
  - id            : "2"
    institution   : "Columbia University"


bibliography      : "BUDS.bib"
floatsintext      : no
linenumbers       : no
draft             : no
mask              : no
figurelist        : no
tablelist         : no
footnotelist      : no
csl               : "`r system.file('rmd', 'apa7.csl', package = 'papaja')`"
documentclass     : "apa7"
output            : papaja::apa6_pdf
editor_options: 
  markdown: 
    wrap: sentence
    
header-includes:
    - \raggedbottom
---

```{r analysis-preferences}
knitr::opts_chunk$set(set.seed(312), warning=FALSE, message=FALSE, include=FALSE, cache=TRUE)
    options(width=80, Ncpus = 6, mc.cores=6, max.print=1000000, scipen = 999) #Set width, multiple cores, and not to use scientific notation
    # rm(list=ls())     #Remove everything from environment
    cat("\014")       #Clear Console

  # library(knitr)      #allows rmarkdown files
  library(haven)      #helps import stata
  library(expss)      #labeling variables/values
  library(broom)      #nice statistical output
  library(here)       #nice file paths
  library(psych)      #used for statistical analyses
  library(Hmisc)
  library(purrr)
  library(haven)      #to import SPSS files
  library(MASS)       #to create residualized scores
# Models
  library(lmerTest)
  library(glmmTMB)
# Plotting
  library(ggplot2)    #creates plots
  library(ggpubr)
  library(ggeffects)
  library(sjPlot)
  library(sjPlot)
  library(marginaleffects)
  library(interactions)
  library(emmeans) # testing simple slopes

  library(datawizard)
  library(performance)
  library(Rmisc)
  library(vtable)
# General tools
  library(tidyverse)  #plotting/cleaning, etc.
  library(papaja)
  library(workflowr)  #helps with workflow

here <- here::here
r_refs("BUDS.bib")
```

```{r Load data}
here::i_am("BUDS_manuscript_working.Rmd")

for (d in c(50150, 150275, 275425)) {
  print(eval(parse(text=paste0('load(file=here("../data/df_',d,'.RData"))'))))
}

load(file=here("../data/BUDS_behavior.RData"))

load(file=here("../data/BUDS_cleaning04_ga.RData"))
load(file=here("../data/BUDS_cleaning04_gaplots.RData"))

spearman_brown <- read.csv(file=here("../tables/spearman_brown.csv"))
```

```{r, remove subjects with too few trials}
bad_150275 <- c(1025,
1055,
1084,
1090,
1101,
1122,
1124,
9015,
9017,
9019,
9035,
9051,
9057,
9081,
9082)

bad_275425 <- c(1055,
1084,
1090,
1101,
1124,
9015,
9017,
9019,
9035,
9051,
9081,
9082)

for (t in c("150275","275425")) {
  eval(parse(text=paste0('
    df_',t,'_cz <- df_',t,'_cz %>%
      dplyr::filter(!ID %in% bad_',t,')
      
    df_',t,'_cz_long <- df_',t,'_cz_long %>%
      dplyr::filter(!ID %in% bad_',t,')
      
    df_',t,'_cz_ema <- df_',t,'_cz_ema %>%
      dplyr::filter(!ID %in% bad_',t,')
      ')))
}
```

```{r Functions}
# from https://www.r-bloggers.com/2020/07/create-a-publication-ready-correlation-matrix-with-significance-levels-in-r/

correlation_matrix <- function(df,
                               type = "pearson",
                               digits = 3,
                               decimal.mark = ".",
                               use = "all",
                               show_significance = TRUE,
                               replace_diagonal = FALSE,
                               replacement = ""){
  
  # check arguments
  stopifnot({
    is.numeric(digits)
    digits >= 0
    use %in% c("all", "upper", "lower")
    is.logical(replace_diagonal)
    is.logical(show_significance)
    is.character(replacement)
  })
  # we need the Hmisc package for this
  require(Hmisc)
  
  # retain only numeric and boolean columns
  isNumericOrBoolean = vapply(df, function(x) is.numeric(x) | is.logical(x), logical(1))
  if (sum(!isNumericOrBoolean) > 0) {
    cat('Dropping non-numeric/-boolean column(s):', paste(names(isNumericOrBoolean)[!isNumericOrBoolean], collapse = ', '), '\n\n')
  }
  df = df[isNumericOrBoolean]
  
  # transform input data frame to matrix
  x <- as.matrix(df)
  
  # run correlation analysis using Hmisc package
  correlation_matrix <- Hmisc::rcorr(x, type = )
  R <- correlation_matrix$r # Matrix of correlation coeficients
  p <- correlation_matrix$P # Matrix of p-value
  
  # transform correlations to specific character format
  Rformatted = formatC(R, format = 'f', digits = digits, decimal.mark = decimal.mark)
  
  # if there are any negative numbers, we want to put a space before the positives to align all
  if (sum(R < 0) > 0) {
    Rformatted = ifelse(R > 0, paste0(' ', Rformatted), Rformatted)
  }
  
  # add significance levels if desired
  if (show_significance) {
    # define notions for significance levels; spacing is important.
    stars <- ifelse(is.na(p), "   ", ifelse(p < .001, "***", ifelse(p < .01, "** ", ifelse(p < .05, "*  ", "   "))))
    Rformatted = paste0(Rformatted, stars)
  }
  # build a new matrix that includes the formatted correlations and their significance stars
  Rnew <- matrix(Rformatted, ncol = ncol(x))
  rownames(Rnew) <- colnames(x)
  colnames(Rnew) <- paste(colnames(x), "", sep =" ")
  
  # replace undesired values
  if (use == 'upper') {
    Rnew[lower.tri(Rnew, diag = replace_diagonal)] <- replacement
  } else if (use == 'lower') {
    Rnew[upper.tri(Rnew, diag = replace_diagonal)] <- replacement
  } else if (replace_diagonal) {
    diag(Rnew) <- replacement
  }
  
  return(Rnew)
}

lmer_adi_interaction_table <- function(data) {
  new_model <- data.frame(model = c("Both","Like","Dislike"),
                            beta = NA, 
                            p = NA)
new_model$beta <- c(broom.mixed::tidy(lmer(formula = ERP ~ Feedback*Voting*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = data))[8,4], broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Like")))[4,4],
                        broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Dislike")))[4,4])

new_model$p <- c(broom.mixed::tidy(lmer(formula = ERP ~ Feedback*Voting*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = data))[8,8], broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Like")))[4,8],
                        broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Dislike")))[4,8])
new_model
}

plot_stats <- function(model, var) {
  temp_stats <- tidy(model) %>% 
    dplyr::filter(term==var) %>%
    dplyr::select(estimate,p.value) %>%
    round(., 3)
  paste0("b = ", temp_stats[1], ", p = ", temp_stats[2])
}
```

# Methods and Materials
## Participants
Informed assent and consent were obtained from the adolescent and parent, respectively, and adolescents 18 years or older provided consent. General inclusion criteria included: (a) Tanner Stage $\ge$ 3 (Tanner & Davies, 1985), (b) parental and child fluency in English, (c) Wechsler Abbreviated Scale of Intelligence-II (WASI-II) > 85 (Wechsler, 2011), (d) ownership of a personal smartphone (android or iOS), and (e) right-handedness. General exclusion criteria included: (a) history of head injury or neurological disorders, (b) current moderate or severe substance use disorder, and (c) lifetime history of bipolar or psychotic disorders, oppositional defiant disorder, conduct disorder, organic mental disorder, or developmental disorder. 

## ERP task effects
```{r, include=TRUE, fig.cap="Topographic maps of N1, RewP, and P300 to A) high-value peer acceptance, B) high-value peer rejection, C) high-value peer acceptance > high-value peer rejection."}
library(eegUtils)
chanlocs <- electrode_locations(read.csv(here('../data/topo_plots/chanlocs32.csv')), montage="biosemi64")
ga_acc <- read.delim(here('../data/topo_plots/ga_highvalue_acceptance_AA (Acc-Acc).txt'))%>%
  pivot_longer(cols=c(-time),
               values_to ="amplitude", names_to="electrode")
ga_rej <- read.delim(here('../data/topo_plots/ga_highvalue_rejection_AR (Acc-Rej).txt'))%>%
  pivot_longer(cols=c(-time),
               values_to ="amplitude", names_to="electrode")
ga_diff <- read.delim(here('../data/topo_plots/ga_highvalue_acc_rej_difference_BIN5=B1-B2.txt'))%>%
  pivot_longer(cols=c(-time),
               values_to ="amplitude", names_to="electrode")

scaling_factor=0.75
topo_maps <- ggarrange(topoplot(ga_acc, time_lim=c(50,150), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor),
          topoplot(ga_rej,time_lim=c(50,150), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor),
          topoplot(ga_diff,time_lim=c(50,150), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor),
          topoplot(ga_acc,time_lim=c(150,275), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor),
          topoplot(ga_rej,time_lim=c(150,275), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor),
          topoplot(ga_diff,time_lim=c(150,275), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor),
          topoplot(ga_acc,time_lim=c(275,425), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor),
          topoplot(ga_rej,time_lim=c(275,425), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor),
          topoplot(ga_diff,time_lim=c(275,425), chanLocs=chanlocs, contour=FALSE, interp_limit="skirt", chan_marker="name", scaling=scaling_factor),
          nrow=3, ncol=3)

topo_maps
```


# Results
## Behavioral ratings
### Post-task ratings
```{r}
post_task_table <- st(dplyr::select(df_BUDS_rating_it_pt, SP_debriefing_interested:SP_debriefing_nervous,SP_debriefing_socialmediause),
                      out="return")[,-c(5:8)] %>%
  mutate(Measure=c("Interested","Happy","Upset","Angry","Nervous","Social Media Use")) %>%
  dplyr::select(-Variable, -N) %>%
  dplyr::select(Measure, everything())
```
```{r}
apa_table(post_task_table)
```

Of note, for low-value peers, participants rated being rejected as feeling *happier* than being accepted. Although seemingly counter-intuitive, previous work suggests that this is likely reflects participants feeling good that they were "right"---that they rejected the person who rejected them---and feeling guilty when they were "wrong"---rejected someone who accepted them [@distefanoComparisonElectrocorticalResponse2018].

# Internal consistency
```{r}
spearman_brown <- spearman_brown[,-1]
spearman_brown[,1] <- c("N1", "RewP", "P300")
```


## Feedback x Value x ADI interaction
### N1
```{r, eval=T}
# models_50150_cz_table <- lmer_adi_interaction_table(df_50150_cz_long)
# models_50150_cz_table$component <- "50150_cz"

model_50150_cz <- lmer(formula = ERP ~ Feedback*ADI_NATRANK_z*Voting + (1 | ID) + (1 | site), data = df_50150_cz_long)
model_50150_cz_high <- lmer(formula = ERP ~ Feedback*ADI_NATRANK_z + (1 | ID) + (1 | site), data = filter(df_50150_cz_long,Voting=="Like"))
model_50150_cz_low <- lmer(formula = ERP ~ Feedback*ADI_NATRANK_z + (1 | ID) + (1 | site), data = filter(df_50150_cz_long,Voting=="Dislike"))

model_50150_adi <- plot_cap(
    model_50150_cz,
    condition = list(
      "ADI_NATRANK_z" = "threenum",
        "Feedback",
        "Voting"),
    draw=FALSE) %>%
    mutate(Value = case_match(Voting, "Dislike" ~ "Low",
                                    "Like" ~ "High"),
         Feedback = case_match(Feedback, "Acc" ~ "Acceptance",
                                    "Rej" ~ "Rejection"))

plot_50150_adi_t <- data.frame(
  label = c(plot_stats(model_50150_cz_high, "Feedback1:ADI_NATRANK_z"),
            plot_stats(model_50150_cz_low, "Feedback1:ADI_NATRANK_z")), 
  Value  = c("High", "Low"),
  Feedback=c("Acceptance","Rejection"))

plot_50150_adi <- ggplot(filter(model_50150_adi, ADI_NATRANK_z!="Mean"), aes(x=ADI_NATRANK_z, y=estimate, fill=Feedback)) +
  geom_bar(position = "dodge", stat = "identity", colour="black") +
  geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = c("darkgreen", "red"), name = "Feedback") +
  facet_wrap(~Value) +
  geom_text(data = data.frame(
  label = c(plot_stats(model_50150_cz_high, "Feedback1:ADI_NATRANK_z"),
            plot_stats(model_50150_cz_low, "Feedback1:ADI_NATRANK_z")),
  Value  = c("High", "Low"),
  Feedback=c("Acceptance","Rejection")), aes(x = 1.5, y = 10, label = label)) +
  theme_apa() +
  labs(x="Area Deprivation", y="N1") +
  theme(strip.background = element_blank(),axis.title.x=element_blank())

# plot_50150_adi <- ggplot(model_50150_adi, aes(x=ADI_NATRANK_z, y=estimate, fill=Feedback)) +
#   geom_bar(position = "dodge", stat = "identity", colour="black") +
#   geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.2, position=position_dodge(.9)) +
#   scale_fill_manual(values = c("gray", "white"), name = "Feedback") +
#   facet_wrap(~Value) +
#   geom_text(data = data.frame(
#   label = c(plot_stats(model_50150_cz_high, "Feedback1:ADI_NATRANK_z"),
#             plot_stats(model_50150_cz_low, "Feedback1:ADI_NATRANK_z")), 
#   Value  = c("High", "Low"),
#   Feedback=c("Acceptance","Rejection")), aes(x = 2, y = 11, label = label)) +
#   theme_apa() +
#   labs(x="Area Deprivation", y="N1") +
#   theme(strip.background = element_blank(),strip.text.x = element_blank())
```
### Covaring for belief in deception
```{r}
load(file=here("../data/df_BUDS_rating_it_pt_demo.RData"))

df_150275_cz_rating2 <- df_150275_cz_rating %>%
  select(ID, SP_debriefing_deceived) %>%
  full_join(df_BUDS_rating_it_pt_demo, by="ID") %>%
  select(ID, Age, StressCT, StressTH, SP_debriefing_deceived) %>%
  full_join(df_150275_cz, by="ID")

df_275425_cz_rating2 <- df_275425_cz_rating %>%
  select(ID, SP_debriefing_deceived) %>%
  full_join(df_BUDS_rating_it_pt_demo, by="ID") %>%
  select(ID, Age, StressCT, StressTH, SP_debriefing_deceived) %>%
  full_join(df_275425_cz, by="ID")

ses_lm_dec <- function(data, y) {
  y <- enquo(y)

  model_formula <- formula(paste0(quo_name(y), "~ ADI_NATRANK_z + site + Age + demo_child_sex + StressCT + StressTH + IDAS_depression + IDAS_anxiety + SP_debriefing_deceived"))
  lm(model_formula, data = data)
}

rewp_aaar_model <- ses_lm_dec(df_150275_cz_rating2, AA_AR_z)
p3_aaar_model <- ses_lm_dec(df_275425_cz_rating2, AA_AR_z)
```

### Outliers removed
```{r}
# REMOVE OUTLIERS
rewp_aaar_model_no_outliers <- lm(formula = AA_AR_z ~ ADI_NATRANK_z + site + Age + demo_child_sex + IDAS_depression, data = df_150275_cz_no_outliers)
df_150275_cz_model <- df_150275_cz_no_outliers %>%
  filter(complete.cases(ADI_NATRANK_z), complete.cases(site))
df_150275_cz_model$predicted = predict(rewp_aaar_model_no_outliers)

scatterplot_150275_adi_no_outliers <- ggplot(df_150275_cz_model, aes(x=predicted, y=AA_AR_z)) +
  geom_point(colour="black") +
  stat_smooth(method="lm", se=TRUE) +
  theme_apa() +
  labs(x="SES (covarying for site)", y="RewP") +
  theme()

# REMOVING OUTLIERS 
p3_aaar_model_no_outliers <- lm(formula = AA_AR_z ~ ADI_NATRANK_z + site, data = df_275425_cz_no_outliers)
df_275425_cz_model_no_outliers <- df_275425_cz_no_outliers %>%
  filter(complete.cases(ADI_NATRANK_z) & complete.cases(site)) %>%
  mutate(predicted = predict(p3_aaar_model_no_outliers))

scatterplot_275425_adi_no_outliers <- ggplot(df_275425_cz_model_no_outliers, aes(x=predicted, y=AA_AR_z)) +
  geom_point(colour="black") +
  stat_smooth(method="lm", se=TRUE) +
  theme_apa() +
  labs(x="SES (covarying for site)", y="P300") +
  theme()
```
The interactions between ADI and Feedback condition predicting mean RewP and P3 amplitude remain significant after removing outliers ___.



## EMA
```{r}
# Pairwise vs listwise deletion issues
df_275425_missing_na <- df_275425_cz_ema %>%
  group_by(ID, daysFrom) %>%
  reframe(all_na = all(is.na(na)),
          adi_na = all(is.na(ADI_NATRANK_log)),
          erp_na = all(is.na(AA_AR))) %>%
  group_by(ID, daysFrom) %>%
  reframe(all_missing = all(is.na(c(all_na,adi_na,erp_na)))) %>%
  arrange(desc(all_missing))

# Multiple entries per slot issues: select the first entry

# test <- df_150275_cz_ema %>%
#   filter(tm_taken<500) %>%
#   group_by(ID,daysFrom,slot) %>%
#   summarise(nsurveys = length(sad)) %>%
#   filter(nsurveys>1) %>%
#   left_join(df_150275_cz_ema, by=c("ID","daysFrom","slot")) %>%
  # select(c(ID,daysFrom,slot,nsurveys,tm_start:future))

df_150275_cz_ema <- df_150275_cz_ema %>%
  group_by(ID,daysFrom,slot) %>%
  arrange(tm_start) %>%
  filter(row_number()==1) %>%
  arrange(ID,daysFrom,tm_start)

df_275425_cz_ema <- df_275425_cz_ema %>%
  group_by(ID,daysFrom,slot) %>%
  arrange(tm_start) %>%
  filter(row_number()==1) %>%
  arrange(ID,daysFrom,tm_start)
```


### ADI and ADDI predicting NA
```{r, include=FALSE}
df_50150_cz_ema$na_cubert <- df_50150_cz_ema$na^(1/3)
df_150275_cz_ema$na_cubert <- df_150275_cz_ema$na^(1/3)
df_275425_cz_ema$na_cubert <- df_275425_cz_ema$na^(1/3)

summary(glmmTMB(addi_total ~ ADI_NATRANK_c,
                    zi = ~ ADI_NATRANK_c,
    data = df_150275_cz_ema,
    family=gaussian, REML=TRUE))

ggplot(df_150275_cz_ema, aes(x=addi_total_c, y= ADI_NATRANK_c)) +
  geom_point() +
  stat_smooth(method="lm")

model_adi_na <- glmmTMB(na_cubert ~ ADI_NATRANK_c + (1 | ID) + (1 | site),
                    zi = ~ ADI_NATRANK_c + (1 | ID) + (1 | site),
    data = df_150275_cz_ema,
    family=gaussian, REML=TRUE)
summary(model_adi_na)
summary(lmer(na_cubert ~ ADI_NATRANK_c + (1 | ID) + (1 | site), df_150275_cz_ema))

model_addi_na <- glmmTMB(na_cubert ~ addi_total_c + (1 | ID) + (1 | site),
                    zi = ~ addi_total_c + (1 | ID) + (1 | site),
    data = df_150275_cz_ema,
    family=gaussian, REML=TRUE)
summary(model_addi_na)
summary(lmer(na_cubert ~ ADI_NATRANK_z + (1 | ID) + (1 | site), df_150275_cz_ema))

# check_model(glmmTMB(na_cubert ~ addi_total_c + (1 | ID) + (1 | site),
#                     zi = ~ addi_total_c + (1 | ID) + (1 | site),
#     data = df_150275_cz_ema,
#     family=gaussian, REML=TRUE))
# 
# hist(residuals(glmmTMB(na_cubert ~ addi_total_c + (1 | ID) + (1 | site),
#                     zi = ~ addi_total_c + (1 | ID) + (1 | site),
#     data = df_150275_cz_ema,
#     family=gaussian, REML=TRUE)))

ggplot(df_150275_cz_ema, aes(y=na_cubert, x=ADI_NATRANK_c)) +
  geom_point() +
  stat_smooth(method=lm) +
  labs(x="SES", y="Negative affect (cubed root)")

ggplot(df_150275_cz_ema, aes(y=na_cubert, x=addi_total_c)) +
  geom_point() +
  stat_smooth(method=lm) +
  labs(x="ADDI", y="Negative affect (cubed root)")
```

### ADI x ERP predicting NA
#### Outliers removed
```{r}
# REMOVED OUTLIERS
# model_150275_ema_na_no_outliers <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + (1 | ID) + (1 | site),
#         zi = ~ ADI_NATRANK_z*AA_AR_z + (1 | ID) + (1 | site),
#   data = df_150275_cz_ema_no_outliers,
#   family=gaussian, REML=TRUE, na.action=na.exclude)
# # glmmTMB:::Anova.glmmTMB(model_150275_ema_na_no_outliers)
# 
# model_275425_ema_na_no_outliers <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + (1 | ID) + (1 | site),
#         zi = ~ ADI_NATRANK_z*AA_AR_z + (1 | ID) + (1 | site),
#   data = df_275425_cz_ema_no_outliers,
#   family=gaussian, REML=TRUE, na.action=na.exclude)
# # glmmTMB:::Anova.glmmTMB(model_275425_ema_na_no_outliers)
# 
# model_275425_ema_na_AR_no_outliers <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AR_AA_c + (1 | ID) + (1 | site),
#         zi = ~ ADI_NATRANK_z*AR_AA_c + (1 | ID) + (1 | site),
#   data = df_275425_cz_ema_no_outliers,
#   family=gaussian, REML=TRUE, na.action=na.exclude)
# # glmmTMB:::Anova.glmmTMB(model_275425_ema_na_AR_no_outliers)
```


#### Simple slopes
```{r}
mean_ADI <- mean(df_150275_cz_ema$ADI_NATRANK_c, na.rm=TRUE)
sd_ADI <- sd(df_150275_cz_ema$ADI_NATRANK_c, na.rm=TRUE)
mean_rewp <- mean(df_150275_cz_ema$AA_AR_c, na.rm=TRUE)
sd_rewp <- sd(df_150275_cz_ema$AA_AR_c, na.rm=TRUE)
```

### Covary for deception
```{r}
df_275425_cz_ema_rating <- df_BUDS_rating_it_pt %>%
  select(-site) %>%
  full_join(df_275425_cz_ema, by="ID", relationship="many-to-many")
model_275425_ema_na_dec <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + SP_debriefing_deceived + (1 | ID) + (1 | site),
        zi = ~ ADI_NATRANK_z*AA_AR_z + (1 | ID) + (1 | site),
  data = df_275425_cz_ema_rating,
  family=gaussian, REML=TRUE, na.action=na.exclude)

df_275425_cz_ema_rating <- df_275425_cz_ema %>%
    select(-site) %>%
  full_join(df_BUDS_rating_it_pt, by="ID", relationship = "many-to-many")

model_150275_ema_na_dec <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + SP_debriefing_deceived + (1 | ID) + (1 | site),
                    zi = ~ ADI_NATRANK_c*AA_AR_c + (1 | ID) + (1 | site),
    data = df_150275_cz_ema_rating,
    family=gaussian, REML=TRUE)

model_275425_ema_na_dec <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + (1 | ID) + (1 | site),
        zi = ~ ADI_NATRANK_z*AA_AR_z + (1 | ID) + (1 | site),
  data = df_275425_cz_ema_rating,
  family=gaussian, REML=TRUE)
```
Interactions between ADI and P3 predicting mean negative affect over the following week were non-significant when covarying for age, sex, hispanic ethnicity, majority/minority race, stress life event frequency and severity, and self-reported well-being.

### Covaring for age, sex, hispanic ethnicity, stress, IDAS
```{r}
model_275425_ema_na_cov <- glmmTMB(na_cubert ~ ADI_NATRANK_c*AA_AR_c + Age + Sex + demo_child_hispanic + White_nonwhite + StressCT + StressTH + IDAS_wellbeing + (1 | ID) + (1 | site),
                    zi = ~ ADI_NATRANK_c*AA_AR_c + (1 | ID) + (1 | site),
    data = df_275425_cz_ema_rating,
    family=gaussian, REML=TRUE)
```

### ADDI x ERP predicting NA
```{r}
model_150275_addi_na <- glmmTMB(na_cubert ~ addi_total_c*AA_AR_c + (1 | ID) + (1 | site),
                    zi = ~ addi_total_c*AA_AR_c + (1 | ID) + (1 | site),
    data = df_150275_cz_ema,
    family=gaussian, REML=TRUE, na.action=na.exclude)

model_275425_addi_na <- glmmTMB(na_cubert ~ addi_total_c*AA_AR_c + (1 | ID) + (1 | site),
                    zi = ~ addi_total_c*AA_AR_c + (1 | ID) + (1 | site),
    data = df_275425_cz_ema,
    family=gaussian, REML=TRUE, na.action=na.exclude)

plot_150275_addi_na <- ggpredict(model_150275_addi_na, terms = c("addi_total_c","AA_AR_c")) %>% 
  plot(colors = "bw") + 
  theme_apa() +
  labs(x="ADDI", y="Negative affect (cubed root)", linetype="RewP", title="") +
  scale_linetype_discrete(labels=c('-SD', 'Mean', '+SD'))

plot_275425_addi_na <- ggpredict(model_275425_addi_na, terms = c("addi_total_c","AA_AR_c")) %>% 
  plot(colors = "bw") + 
  theme_apa() +
  labs(x="ADDI", y="Negative affect (cubed root)", linetype="P3", title="") +
  scale_linetype_discrete(labels=c('-SD', 'Mean', '+SD'))
```

# Discussion

These findings also begin to answer questions about why area deprivation or socioeconomic status more broadly are risk factors for psychopathology. These findings support one theory: that area deprivation increases stressors, particularly being discriminated against, which in turn may lead to reduced hedonic responses to peer acceptance and heightened responses to peer rejection. Youth in deprived areas are more likely to be subjected to structural discrimination targeting racial and ethnic minorities and those in poverty. Although the STRAIN and other commonly used measures of stress life events account for some stressful life experiences, recent work suggests that they do not capture the effects of racism [@bernardMakingCACECulturallyInformed2021].In fact, research on prejudice highlights that ...(see Amodio, 2014 (NATURE)).

At a group level, we have shown that an fMRI task of neural responses to social feedback--the Chatroom task (Guyer; Pagliaccio)--yields the expected ERP components: primarily a RewP and P300. These components have acceptable internal consistency and reliability. Furthermore, these components have been identified in other studies of social feedback (CITE ME, AUTUMN, ANNA). As we found in our study, these studies have also found that whereas the RewP significantly differs between acceptance and rejection, the P3 does not. However, unlike previous studies, we examined whether these neural signals may differ depending on youths' area deprivation. The finding that these waveforms do in fact differ highlights the importance of studies regularly examining such interactions.

Adolescents living in areas of high deprivation demonstrate patterns of neural activity consistent with those observed in depressed and anxious youth (CITE). That is, depressed youth often exhibit a blunted response to social acceptance, and anxious youth a heightened response to social rejection (though see XX for an example of social anxiety being related to **enhanced** response to social acceptance too). Moreover, this pattern was replicated for self-report discrimination, with those with experiences of discrimination showing ... Together, these findings suggest that heightened ...

This is in line with findings that those in areas of greater deprivation experience more discrimination (CITE). Another possibility that area deprivation is tied to more frequent and/or more severe daily stressors. Such stressor may not be picked up on in the STRAIN unless they are associated with other major life events (e.g., moving homes). However, they may contribute to risk for psychopathology (CITE).

The behavioral main effect, contrasted with the primary ERP effect, suggests that the interaction between ADI and social processing may be more implicit than explicit. While we found an interaction between area deprivation and brain responses to social feedback, we did not find one with behavioral responses to social feedback (i.e., behavioral ratings)--all subjects uniformly rated feeling better after being accepted and worse after being rejected (by high-value peers).

Of note, for low-value peers, participants rated being rejected as feeling better than being accepted. Although seemingly counter-intuitive, previous work suggests that this is the result of participants feeling good that they were "right"--that they rejected the person who rejected them--and felt guilty when they were "wrong"--rejected someone who accepted them [@distefanoComparisonElectrocorticalResponse2018].

The current study must be considered in light of its limitations, as well as its strengths. First,...
			• P3 positively assessing with NA at low levels of ADI
			• We are not capturing other areas where they go (e.g., for school, socializing, after school activities)
			• Possibility that these tasks are biased
			• Version of Chatroom centered on discrimination feedback may be especially useful in measuring this

There are numerous potential theoretical explanations for how ADI and discrimination experiences lead to worsened depression and anxiety symptoms via heightened rejection sensitivity. One is simply that experiences of discrimination leave youth more adaptively sensitive to rejections from others, which in turn leads to heightened threat sensitivity, a precusor of anxiety disorders (CITE). Another is that such sensitivity leads to fewer prosocial and potentially more aggressive behaviors [e.g., rejecting others, @quarmleyTestingEffectsSocial2022; @rappaportPeerVictimizationDysfunctional2019]. Finally, a third possibility is that...

These findings highlight and emphasize other results such as .... 

Clinically, results suggest that discrimination-focused interventions may reduce subsequent psychopathology. For example, interventions focused on reducing instances of discrimination (e.g., implicit bias training [CITE]), as well as helping youth heal from racial trauma (e.g., ___ [CITE]). 

		• "Not people's race but the experiences they have as a consequence of their race"
		• Cultural different perspectives on psychopathology
			• Depression may manifest as anger rather than sadness

In the future, studies developing novel neuroimaging and psychophysiological tasks to be used as an individual difference measure should also collect data related to participants' background, including their socioeconomic status and/or area deprivation. More and more studies are finding that such aspects moderate findings [@correaEthnicDifferencesBehavioral2022]. Given that SES and ADI are established risk factors for psychopathology, accounting for them in analyses will help assure that findings examining neural mechanisms of psychopathology are not influenced by a large potential third-variable.

\newpage

# References

::: {#refs custom-style="Bibliography"}
:::
