---
title     : "Socioeconomic status and adolescent brain responses to peer feedback: Testing impact on negative affect assessed outside of the lab"
shorttitle    : "SES & brain responses to peer feedback"

bibliography  : "BUDS.bib"
floatsintext  : yes
linenumbers   : no
draft         : no
mask          : no
figurelist    : no
tablelist     : no
footnotelist  : no
csl           : 'biological-psychiatry.csl'
documentclass : "apa7"
output        : papaja::apa6_pdf
  
editor_options: 
  markdown: 
  wrap: sentence

params:
  show_headers: false
  
header-includes:
  - \usepackage{setspace}
  - \AtBeginEnvironment{tabular}{\singlespacing}
  - \AtBeginEnvironment{lltable}{\singlespacing}
  - \AtBeginEnvironment{tablenotes}{\doublespacing}
  - \captionsetup[table]{font={stretch=1.5}}
  - \captionsetup[figure]{font={stretch=1.5}}
 # - \usepackage{lscape}
#  - \newcommand{\blandscape}{\begin{landscape}}
  # - \newcommand{\elandscape}{\end{landscape}}
  
  - \AtBeginDocument{\let\maketitle\relax} # no title page
  
  - \raggedbottom
  - \usepackage{helvet}
  - \renewcommand{\rmdefault}{phv} % Use Helvetica for serif
  - \renewcommand{\sfdefault}{phv} % Use Helvetica for sans-serif
---

```{r analysis-preferences}
knitr::opts_chunk$set(set.seed(312), warning=FALSE, message=FALSE, include=FALSE, results='hide', papaja.title_page = FALSE)
  options(width=80, Ncpus = 6, mc.cores=6, max.print=1000000, scipen = 999, papaja.na_string = "") #Set width, multiple cores, and not to use scientific notation
  rm(list=ls())   #Remove everything from environment
  cat("\014")   #Clear Console

  # library(knitr)  #allows rmarkdown files
  library(haven)  #helps import stata
  library(expss)  #labeling variables/values
  library(broom.mixed)  #nice statistical output
  library(here)   #nice file paths
  library(psych)  #used for statistical analyses
  library(Hmisc)
  library(questionr) # odds ratio
  library(purrr)
  library(haven)  #to import SPSS files
  library(MASS)   #to create residualized scores
# Models
  library(lmerTest)
  library(glmmTMB)
# Plotting
  library(ggplot2)  #creates plots
  library(ggpubr)
  library(ggeffects)
  library(cowplot)
  library(ggtext)
  library(sjPlot)
  library(png)
  library(grid)
  library(eegUtils)
  library(gridExtra)
  # library(gtsummary)
# Interactions
  library(marginaleffects)
  library(interactions)
  library(latex2exp)
  library(emmeans) # testing simple slopes
# Misc data formatting
  library(datawizard)
  library(performance)
  library(Rmisc)
  library(vtable)
# General tools
  library(english)
  library(tidyverse)  #plotting/cleaning, etc.
  library(scipub) #demo table
  library(papaja)
  library(workflowr)  #helps with workflow

here <- here::here
r_refs("BUDS.bib")
```

```{r Load data}
here::i_am("BUDS_manuscript_working.Rmd")

load(file=here::here("../data/BUDS_do02.RData"))

load(file=here("../data/BUDS_behavior.RData"))

load(file=here("../data/BUDS_do03_gaplots.RData"))

spearman_brown <- read.csv(file=here("../tables/spearman_brown.csv"))
```

```{r}
# Rename site variables
df_50150_fz_long <- df_50150_fz %>%
  mutate(site = case_when(ID < 9000 ~ "NYC",
                          ID > 8999 ~ "Chicago",
                                   NA ~ NA)) %>%
    pivot_longer(cols=c("Acc_Acc","Rej_Acc","Acc_Rej","Rej_Rej"), names_to=c("Voting","Feedback"), names_sep="_", values_to="ERP")
df_150275_cz_long <- df_150275_cz %>%
  mutate(site = case_when(ID < 9000 ~ "NYC",
                          ID > 8999 ~ "Chicago",
                                   NA ~ NA)) %>%
    pivot_longer(cols=c("Acc_Acc","Rej_Acc","Acc_Rej","Rej_Rej"), names_to=c("Voting","Feedback"), names_sep="_", values_to="ERP")
df_275425_pz_long <- df_275425_pz %>%
  mutate(site = case_when(ID < 9000 ~ "NYC",
                          ID > 8999 ~ "Chicago",
                                   NA ~ NA)) %>%
    pivot_longer(cols=c("Acc_Acc","Rej_Acc","Acc_Rej","Rej_Rej"), names_to=c("Voting","Feedback"), names_sep="_", values_to="ERP")

# Clean ema datasets
df_150275_cz_ema <- df_150275_cz_ema %>%
  group_by(ID,daysFrom,slot) %>%
  arrange(tm_start) %>%
  filter(row_number()==1) %>%
  arrange(ID,daysFrom,tm_start) %>%
  mutate(na_cubert = na^(1/3),
         na_cubert_z = scale(na_cubert, center=T, scale=T))

df_275425_pz_ema <- df_275425_pz_ema %>%
  group_by(ID,daysFrom,slot) %>%
  arrange(tm_start) %>%
  filter(row_number()==1) %>%
  arrange(ID,daysFrom,tm_start) %>%
  mutate(na_cubert = na^(1/3),
         na_cubert_z = scale(na_cubert, center=T, scale=T))

# df_150275_cz_ema$na_cubert <- df_150275_cz_ema$na^(1/3)
# df_275425_pz_ema$na_cubert <- df_275425_pz_ema$na^(1/3)
```

```{r Functions}
# from https://www.r-bloggers.com/2020/07/create-a-publication-ready-correlation-matrix-with-significance-levels-in-r/

round3 <- function(var) {
  sprintf("%.3f",var)
}

correlation_matrix <- function(df,
           type = "pearson",
           digits = 3,
           decimal.mark = ".",
           use = "all",
           show_significance = TRUE,
           replace_diagonal = FALSE,
           replacement = ""){
  
  # check arguments
  stopifnot({
  is.numeric(digits)
  digits >= 0
  use %in% c("all", "upper", "lower")
  is.logical(replace_diagonal)
  is.logical(show_significance)
  is.character(replacement)
  })
  # we need the Hmisc package for this
  require(Hmisc)
  
  # retain only numeric and boolean columns
  isNumericOrBoolean = vapply(df, function(x) is.numeric(x) | is.logical(x), logical(1))
  if (sum(!isNumericOrBoolean) > 0) {
  cat('Dropping non-numeric/-boolean column(s):', paste(names(isNumericOrBoolean)[!isNumericOrBoolean], collapse = ', '), '\n\n')
  }
  df = df[isNumericOrBoolean]
  
  # transform input data frame to matrix
  x <- as.matrix(df)
  
  # run correlation analysis using Hmisc package
  correlation_matrix <- Hmisc::rcorr(x, type = )
  R <- correlation_matrix$r # Matrix of correlation coeficients
  p <- correlation_matrix$P # Matrix of p-value
  
  # transform correlations to specific character format
  Rformatted = formatC(R, format = 'f', digits = digits, decimal.mark = decimal.mark)
  
  # if there are any negative numbers, we want to put a space before the positives to align all
  if (sum(R < 0) > 0) {
  Rformatted = ifelse(R > 0, paste0(' ', Rformatted), Rformatted)
  }
  
  # add significance levels if desired
  if (show_significance) {
  # define notions for significance levels; spacing is important.
  stars <- ifelse(is.na(p), " ", ifelse(p < .001, "***", ifelse(p < .01, "** ", ifelse(p < .05, "*  ", " "))))
  Rformatted = paste0(Rformatted, stars)
  }
  # build a new matrix that includes the formatted correlations and their significance stars
  Rnew <- matrix(Rformatted, ncol = ncol(x))
  rownames(Rnew) <- colnames(x)
  colnames(Rnew) <- paste(colnames(x), "", sep =" ")
  
  # replace undesired values
  if (use == 'upper') {
  Rnew[lower.tri(Rnew, diag = replace_diagonal)] <- replacement
  } else if (use == 'lower') {
  Rnew[upper.tri(Rnew, diag = replace_diagonal)] <- replacement
  } else if (replace_diagonal) {
  diag(Rnew) <- replacement
  }
  
  return(Rnew)
}

lmer_adi_interaction_table <- function(data) {
  new_model <- data.frame(model = c("Both","Acc","Rej"),
          beta = NA, 
          p = NA)
new_model$beta <- c(broom.mixed::tidy(lmer(formula = ERP ~ Feedback*Voting*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = data))[8,4], broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Acc")))[4,4],
        broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Rej")))[4,4])

new_model$p <- c(broom.mixed::tidy(lmer(formula = ERP ~ Feedback*Voting*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = data))[8,8], broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Acc")))[4,8],
        broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Rej")))[4,8])
new_model
}

plot_stats <- function(model, var) {
  temp_stats <- tidy(model) %>% 
  dplyr::filter(term==var) %>%
  dplyr::select(estimate,p.value) %>%
  round3(.)
  paste0("b = ", temp_stats[1], ", p = ", temp_stats[2])
}

make_long_format <- function(data, site_variable) {
  data %>%
    pivot_longer(cols=c("Acc_Acc","Rej_Acc","Acc_Rej","Rej_Rej"), names_to=c("Voting","Feedback"), names_sep="_", values_to="ERP")
}
```


```{r demoTable}
df_50150_fz <- df_50150_fz %>%
  filter(complete.cases(AA_AR)) %>%
  mutate(site = case_match(site, "Columbia" ~ "NYC",
                                 "Northwestern" ~ "Chicago"))

demo_table <- FullTable1(df_50150_fz, strata="site",
           vars=c("demo_child_age","ADI_NATRANK","demo_child_sex","demo_child_hispanic","demo_child_race",
                  "IDAS_depression","IDAS_anxiety","StressCT","StressTH"),
           factor_vars=c("demo_child_sex","demo_child_hispanic","demo_child_race"),
           var_names=c("Age","SES (percentile)","Sex","Hispanic ethnicity","Race",
                       "IDAS depression","IDAS anxiety","Lifetime number of stressors","Lifetime stressor severity"),
           round_n=2)



paste0("Missing STRAIN: ",df_50150_fz[is.na(df_50150_fz$StressCT),"ID"])
paste0("Missing age: ",df_50150_fz[is.na(df_50150_fz$demo_child_age),"ID"])
paste0("Missing sex: ",df_50150_fz[is.na(df_50150_fz$demo_child_sex),"ID"])
paste0("Missing ethnicity: ",df_50150_fz[is.na(df_50150_fz$demo_child_hispanic),"ID"])
paste0("Missing race: ",df_50150_fz[is.na(df_50150_fz$demo_child_race),"ID"])
paste0("Missing IDAS: ",df_50150_fz[is.na(df_50150_fz$IDAS_depression),"ID"])

# Remove race heading variable
demo_table$table[6,4:7] <- demo_table$table[5,4:7]
demo_table$table <- demo_table$table[-5,]

# Concatenate stat and significance stars into one variable
demo_table$table$Stat <- paste0(demo_table$table$Stat,demo_table$table$sig)
demo_table$table <- demo_table$table[,-c(5,6)]

# Compute crosstrabs for sex by site to get number of participants male and female SAAB by site
sex_by_site <- table(df_275425_pz$demo_child_sex, df_275425_pz$site)
# Make a new row
new_row <- data.frame(Variable = "Female", 
          "NYC" = paste0(sex_by_site[1,1], " (",round(sex_by_site[1,1]/sum(sex_by_site[,1]),4)*100,"%)"),
          "Chicago" = paste0(sex_by_site[1,2], " (",round(sex_by_site[1,2]/sum(sex_by_site[,2]),4)*100,"%)"),
          Stat = "",
          es = "")

colnames(new_row) <- colnames(demo_table$table)
# Place new row in correct position
df_top <- demo_table$table[1:3, ]
df_bottom <- demo_table$table[(3 + 1):nrow(demo_table$table), ]
demo_table2 <- rbind(df_top, new_row, df_bottom)
rownames(demo_table2) <- NULL
demo_table2[3,1] <- "Male"
demo_table2[4,4:5] <- c("--","-")

demo_table2$Statistic <- ifelse(demo_table2$Stat=="--", NA, ifelse(demo_table2$Stat=="-", NA, demo_table2$Stat))
demo_table2$`Effect size` <- ifelse(demo_table2$es=="--", NA, ifelse(demo_table2$es=="-", NA, demo_table2$es))
demo_table2[,2] <- ifelse(demo_table2[,2]=="-", "0 (0.00%)", demo_table2[,2])
demo_table2 <- demo_table2[,-c(4,5)]
demo_table2$Statistic <- gsub("χ2", "$\\chi^2$", demo_table2$Statistic)
```

```{r, include=TRUE, results="asis"}
apa_table(demo_table2,
          caption="Demographics of samples and descriptive statistics of measures of interest and covariates.",
          note=paste0(substring(demo_table$caption,7), ", NYC = New York, NY."),
          align = c("p{6.5cm}", "p{2.5cm}", "p{2.5cm}","p{2cm}","p{1.5cm}"),
          stub_indents=list(`Sex-assigned-at-birth`=c(3:4), `Self-identified race`=c(6:12)),
          font_size="small",
          col.names = c(colnames(demo_table2)[1:3],"Statistic","Effect size"),
          landscape=FALSE,
          escape=FALSE)
```

```{r}
rewp_fv_mlm <- lmer(formula = ERP ~ Feedback*Voting + site + (1 | ID), REML=TRUE, data = df_150275_cz_long)
p300_fv_mlm <- lmer(formula = ERP ~ Feedback*Voting + site + (1 | ID), REML=TRUE, data = df_275425_pz_long)
```

```{r set-model-predictors}
ses_lm <- function(data, y) {
  y <- enquo(y)

  model_formula <- formula(paste0(quo_name(y), "~ ADI_NATRANK_z + site + Age_z + demo_child_sex + StressCT + StressTH + IDAS_depression + IDAS_anxiety"))
  lm(model_formula, data = data)
}
```

```{r}
rewp_aaar_model <- ses_lm(df_150275_cz,AA_AR_z)
rewp_araa_model <- ses_lm(df_150275_cz,AR_AA_z)
rewp_rarr_model <- ses_lm(df_150275_cz,RA_RR_z)
rewp_rrra_model <- ses_lm(df_150275_cz,RR_RA_z)

rewp_low_value_ses_pvalues <- c(as.numeric(apa_print(rewp_rarr_model)$table$p.value[2]),as.numeric(apa_print(rewp_rrra_model)$table$p.value[2]),
  as.numeric(apa_print(rewp_rarr_model)$table$p.value[2]),as.numeric(apa_print(rewp_rrra_model)$table$p.value[2]))

# Scatter plot
scatterplot_150275_adi <- ggplot(df_150275_cz, aes(x=ADI_NATRANK, y=AA_AR_z)) +
  geom_point(colour="black") +
  stat_smooth(method="lm", se=TRUE) +
  ylim(-3,5) +
  theme_apa() +
  labs(x="SES (percentile)", y=expression("RewP"[resid])) +
  theme()
```

```{r}
p3_aaar_model <- ses_lm(df_275425_pz, AA_AR_z)
p3_araa_model <- ses_lm(df_275425_pz, AR_AA_z)
p3_rarr_model <- ses_lm(df_275425_pz, RA_RR)
p3_rrra_model <- ses_lm(df_275425_pz, RR_RA)

p3_low_value_ses_pvalues <- c(as.numeric(apa_print(p3_rarr_model)$table$p.value[2]),as.numeric(apa_print(p3_rrra_model)$table$p.value[2]),
  as.numeric(apa_print(p3_rarr_model)$table$p.value[2]),as.numeric(apa_print(p3_rrra_model)$table$p.value[2]))

# Scatter plot
scatterplot_275425_adi <- ggplot(df_275425_pz, aes(x=ADI_NATRANK, y=AA_AR_z)) +
  geom_point(colour="black") +
  stat_smooth(method="lm", se=TRUE) +
  theme_apa() +
  labs(x="SES (national percentile)", y=expression("P300"[resid])) +
  theme()
```

```{r}
model_150275_ema_na <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_z + demo_child_sex + site + (1 | ID),
                zi = ~ .,
  data = df_150275_cz_ema,
  family=gaussian, REML=TRUE)

model_275425_ema_na <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_z + demo_child_sex + site + (1 | ID),
                                   zi = ~ .,
  data = df_275425_pz_ema,
  family=gaussian, REML=TRUE)

# PLOTS
plot_150275_adi_na <- ggpredict(model_150275_ema_na, terms = c("AA_AR_z","ADI_NATRANK_z"))%>% 
  plot() + 
  theme_apa() +
  labs(x=expression("RewP"[resid]), y="Negative affect (cubed root)", color="SES", linetype="SES", title="") +
  scale_color_manual(values=c('orange','white','darkblue'), labels=c('-SD', 'Mean','+SD')) + 
  scale_fill_manual(values=c('orange','white','darkblue')) +
  theme(legend.position = "none", plot.title=element_blank())

plot_275425_adi_na <- ggpredict(model_275425_ema_na, terms = c("AA_AR_z","ADI_NATRANK_z")) %>%
  plot() + 
  theme_apa() +
  labs(x=expression("P300"[resid]), y="Negative affect (cubed root)", color="SES", linetype="SES", title="") +
  scale_color_manual(values=c('orange','white','darkblue'), labels=c('-SD', '+SD')) + 
  scale_fill_manual(values=c('orange','white','darkblue')) +
  theme(legend.position = "none", element_text(), plot.title=element_blank())
```

```{r include=TRUE, results='asis'}
model_150275_ema_na_table <- tidy(model_150275_ema_na,component="cond", conf.int=TRUE) %>%
  mutate(ci = paste0("[",sprintf("%.3f",conf.low),", ",sprintf("%.3f",conf.high),"]")) %>% # make 95% CI variable
  dplyr::select(term,estimate,ci,p.value) %>%
  filter(row_number() <= n()-2) %>% # remove random effects
  mutate(term=c("Intercept","SES","RewP\\textsubscript{resid}",
                "Age","Sex","Site","SES x RewP\\textsubscript{resid}"),
         p.value = ifelse(p.value < 0.001, "<0.001", as.character(sprintf("%.3f",p.value))))

model_275425_ema_na_table <- tidy(model_275425_ema_na,component="cond", conf.int=TRUE) %>%
  mutate(ci = paste0("[",sprintf("%.3f",conf.low),", ",sprintf("%.3f",conf.high),"]")) %>% # make 95% CI variable
  dplyr::select(term,estimate,ci,p.value) %>%
  filter(row_number() <= n()-2) %>% # remove random effects
  mutate(term=c("Intercept","SES","P300\\textsubscript{resid}",
                "Age","Sex","Site","SES x P300\\textsubscript{resid}"),
         p.value = ifelse(p.value < 0.001, "<0.001", as.character(sprintf("%.3f",p.value))))

apa_table(list(`RewP\\textsubscript{resid}`=model_150275_ema_na_table,
               `P300\\textsubscript{resid}`=model_275425_ema_na_table),
          col.names=c("Predictor", "$\\beta$","95\\% CI","\\textit{p} value"),
          digits=3, escape=FALSE,
          caption="Fixed effects from MLM models predicting EMA reported negative affect.")
```

```{r}
Cz_ga_aa_ar_plot <- ggplot(data=filter(df_ga_Cz_long, Condition=="Acc_Acc" | Condition=="Acc_Rej" | Condition=="AA_AR"), aes(x=Time, y=grand_average, color=Condition)) +
  geom_line(linewidth=1) +
  scale_x_continuous(breaks = seq(-200, 1000, by = 200)) +
  scale_y_continuous(breaks = seq(-5, 10, by = 5)) +
  coord_cartesian(xlim=c(-200,1000), ylim=c(-5,10)) +
  annotate("rect", xmin=150, xmax=275, ymin=-5, ymax=Inf, alpha=0.5, fill="gray") +
  geom_rect(aes(xmin=0, xmax=0, ymin=-5, ymax=12), color="black") +
  geom_rect(aes(xmin=-200, xmax=1000, ymin=0, ymax=0), color="black") +
  scale_color_manual(breaks=c("Acc_Acc","Acc_Rej","AA_AR"),
       values=c("Acc_Acc"="green", "AA_AR"="black", "Acc_Rej"="red"), 
       labels=c("Acceptance","Rejection","Difference"), name=NULL) +
  labs(x="Time (ms)", y="Cz (µV)") +
  theme_apa() + 
  theme(text=element_text(size=14))

Pz_ga_aa_ar_plot <- ggplot(data=filter(df_ga_Pz_long, Condition=="Acc_Acc" | Condition=="Acc_Rej" | Condition=="AA_AR"), aes(x=Time, y=grand_average, color=Condition)) +
  geom_line(linewidth=1) +
  scale_x_continuous(breaks = seq(-200, 1000, by = 200)) +
  scale_y_continuous(breaks = seq(-4, 12, by = 4)) +
  coord_cartesian(xlim=c(-200,1000), ylim=c(-4, 12)) +
  annotate("rect", xmin=275, xmax=425, ymin=-5, ymax=Inf, alpha=0.5, fill="gray") +
  geom_rect(aes(xmin=0, xmax=0, ymin=-5, ymax=12), color="black") +
  geom_rect(aes(xmin=-200, xmax=1000, ymin=0, ymax=0), color="black") +
  scale_color_manual(breaks=c("Acc_Acc","Acc_Rej","AA_AR"),
       values=c("Acc_Acc"="green", "AA_AR"="black", "Acc_Rej"="red"), 
       labels=c("Acceptance","Rejection","Difference"), name=NULL) +
  labs(x="Time (ms)", y="Pz (µV)") +
  theme_apa() + 
  theme(text=element_text(size=14))
```

```{r, include=TRUE}
chanlocs <- eegUtils::electrode_locations(read.csv(here::here('../data/topo_plots/chanlocs32.csv')), montage="biosemi64")
ga_acc <- read.delim(here('../data/topo_plots/ga_highvalue_acceptance_AA (Acc-Acc).txt'))%>%
  pivot_longer(cols=c(-time),
               values_to ="amplitude", names_to="electrode")
ga_rej <- read.delim(here('../data/topo_plots/ga_highvalue_rejection_AR (Acc-Rej).txt'))%>%
  pivot_longer(cols=c(-time),
               values_to ="amplitude", names_to="electrode")
ga_diff <- read.delim(here('../data/topo_plots/ga_highvalue_acc_rej_difference_BIN5=B1-B2.txt'))%>%
  pivot_longer(cols=c(-time),
               values_to ="amplitude", names_to="electrode")

scaling_factor=0.45
# Create grobs for the column titles

title_rewp <- textGrob("RewP", gp=gpar(fontsize=14, fontface="bold"))
title_p300 <- textGrob("P300", gp=gpar(fontsize=14, fontface="bold"))

title_acc <- textGrob("Acceptance", gp=gpar(fontsize=14, fontface="bold"), rot=90)
title_rej <- textGrob("Rejection", gp=gpar(fontsize=14, fontface="bold"), rot=90)
title_diff <- textGrob("Acceptance > \nRejection", gp=gpar(fontsize=14, fontface="bold"), rot=90)

chanlocs <- chanlocs %>%
  mutate(electrode = case_match(electrode, "Poz" ~ "POz",
                          .default=electrode))

chanlocs2 <- chanlocs %>%
  mutate(electrode = ifelse(chanlocs$electrode %in% c("Pz", "Cz"), 
                             chanlocs$electrode, 
                             NA))

topo_plot_rewp <- topoplot(ga_diff,time_lim=c(150,275), chanLocs=chanlocs, contour=TRUE, interp_limit="skirt", chan_marker="none", scaling=scaling_factor, verbose=FALSE) +
 annotate("text", x=1, y=45, label = "Fz", color = "black", size=3) +
 annotate("text", x=1, y=0, label = "Cz", color = "black", size=3) +
  annotate("text", x=1, y=-45, label = "Pz", color = "black", size=3)
topo_plot_p3 <- topoplot(ga_diff,time_lim=c(275,425), chanLocs=chanlocs, contour=TRUE, interp_limit="skirt", chan_marker="none", scaling=scaling_factor, verbose=FALSE) +
 annotate("text", x=1, y=45, label = "Fz", color = "black", size=3) +
 annotate("text", x=1, y=0, label = "Cz", color = "black", size=3) +
  annotate("text", x=1, y=-45, label = "Pz", color = "black", size=3)
```

```{r, eval=FALSE}
in_task_rating_summary_stats <- summarySE(df_BUDS_rating_it_pt, measurevar="rating", groupvars=c("Feedback","Voting")) %>%
  filter(complete.cases(rating))
in_task_rating_summary_stats$Voting <- c("Low-value", "High-value", "Low-value", "High-value")
rating_plot <- ggplot(in_task_rating_summary_stats, aes(y=rating, x=Voting, fill=Feedback)) +
  geom_bar(position = "dodge", stat = "identity", colour="black") +
  geom_errorbar(aes(ymin=rating-ci, ymax=rating+ci), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = c("green", "red"), name = "Feedback") +
  theme_apa() +
  theme(legend.position = "none") +
  labs(x="Peer value", y="In-task rating")
```

```{r Load task image}
img_plot <- ggplot() +
  annotation_custom(rasterGrob(png::readPNG(here("figures/chatroom_figure.png")), interpolate = TRUE), 
                    xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf) +
  theme_void() + # Remove axes and background
  theme(plot.margin = margin(t=0, l=0, r=0, b=0, unit = "cm"))
```

```{r, include=FALSE, results="asis", fig.cap = "A) Example of trial from chatroom task. B) Grand average ERP for acceptance and rejection feedback from high-value peers and topographic maps. Gray sections of the graph represent time windows where ERP components were extracted at Cz electrode for the RewP (top) and Pz electrode for the P300 (bottom).", fig.height=8.5, fig.width=7}
# Combine image of task, grand average waveform, and topographic maps

ga_plots <- cowplot::plot_grid(Cz_ga_aa_ar_plot + theme(legend.position="none") + xlab(""), topo_plot_rewp, 
                               Pz_ga_aa_ar_plot + theme(legend.position="none"), topo_plot_p3,
          ncol = 2, nrow = 2,
          rel_heights = c(2, 2),
          rel_widths = c(3, 2))

legend_ga <- cowplot::get_legend(Cz_ga_aa_ar_plot + theme(legend.direction="horizontal"))

figure_1 <- cowplot::plot_grid(img_plot, ga_plots, legend_ga,
          labels = c("A.","B.",""),
          label_x=0,
          label_y=1.02,
          ncol = 1, nrow = 3,
          rel_heights = c(1.5, 2, 0.3),
          rel_widths = c(2))

tiff(here("figures/figure_1.tiff"), width = 7.5, height = 10, units = "in", res = 500)
figure_1
dev.off()
```

```{r}
rewp_na_stat <- c(tidy(model_150275_ema_na) %>% 
                    filter(effect == "fixed", component == "cond", term == "ADI_NATRANK_z:AA_AR_z"),
                  as.data.frame(confint(model_150275_ema_na)) %>% 
                    rownames_to_column("row_name") %>% 
                    filter(row_name == "cond.ADI_NATRANK_z:AA_AR_z") %>% 
                       mutate(lower = round3(`2.5 %`), upper=round3(`97.5 %`)) %>% 
                       dplyr::select(lower,upper))

p300_na_stat <- c(tidy(model_275425_ema_na) %>%
                    filter(effect == "fixed", component == "cond", term == "ADI_NATRANK_z:AA_AR_z"),
                  as.data.frame(confint(model_275425_ema_na)) %>%
                    rownames_to_column("row_name") %>%
                    filter(row_name == "cond.ADI_NATRANK_z:AA_AR_z") %>%
                       mutate(lower = round3(`2.5 %`), upper=round3(`97.5 %`)) %>%
                       dplyr::select(lower,upper))
```

```{r}
## REWP
mean_ses <- mean(df_150275_cz_ema$ADI_NATRANK_z, na.rm=TRUE)
sd_ses <- sd(df_150275_cz_ema$ADI_NATRANK_z, na.rm=TRUE)
SESa <- mean_ses + sd_ses
SESb <- mean_ses - sd_ses
SES_list <- list(ADI_NATRANK_z=round(c(SESa,SESb),2)) 
######## ACC > REJ ######## 
m_rewp_acc <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_z + demo_child_sex + site + (1 | ID),
        zi = ~ .,
  data = df_150275_cz_ema,
  family=gaussian, REML=TRUE)

m_rewp_acc_ss <- emtrends(m_rewp_acc, pairwise ~ADI_NATRANK_z, var="AA_AR_z",at=SES_list, adjust="none")|> test()

# With covariates
m_rewp_acc_cov <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_z + demo_child_sex + StressCT_z + StressTH_z + IDAS_depression_z + IDAS_anxiety_z + site + (1 | ID),
        zi = ~ .,
  data = df_150275_cz_ema,
  family=gaussian, REML=TRUE)
m_rewp_acc_cov_ss <- emtrends(m_rewp_acc_cov, pairwise ~ADI_NATRANK_z, var="AA_AR_z",at=SES_list, adjust="none")|> test()

## P300
mean_ses <- mean(df_275425_pz_ema$ADI_NATRANK_z, na.rm=TRUE)
sd_ses <- sd(df_275425_pz_ema$ADI_NATRANK_z, na.rm=TRUE)
SESa <- mean_ses + sd_ses
SESb <- mean_ses - sd_ses
SES_list <- list(ADI_NATRANK_z=round(c(SESa,SESb),2)) 
######## ACC > REJ ######## 
m_p300_acc <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_z + demo_child_sex + site + (1 | ID),
        zi = ~ .,
  data = df_275425_pz_ema,
  family=gaussian, REML=TRUE)
# glmmTMB:::Anova.glmmTMB(m_p300_rej)

m_p300_acc_ss <- emtrends(m_p300_acc, pairwise ~ADI_NATRANK_z, var="AA_AR_z",at=SES_list, adjust="none")|> test()

# With covariates
m_p300_acc_cov <- glmmTMB(na_cubert ~ ADI_NATRANK_z*AA_AR_z + Age_z + demo_child_sex + StressCT_z + StressTH_z + IDAS_depression_z + IDAS_anxiety_z + site + (1 | ID),
        zi = ~ .,
  data = df_275425_pz_ema,
  family=gaussian, REML=TRUE)
m_p300_acc_cov_ss <- emtrends(m_p300_acc_cov, pairwise ~ADI_NATRANK_z, var="AA_AR_z",at=SES_list, adjust="none")|> test()
```

```{r, include=FALSE, results='asis', fig.cap = 'Relationship between SES and brain responses to acceptance (relative to rejection) for RewP~resid~ and P300~resid~ ERP components.', fig.height=7, fig.width=5}

adi_plots_scatter <- ggarrange(scatterplot_150275_adi + 
                                       rremove("xlab") + rremove("x.text") + 
                                       coord_cartesian(xlim=c(0,100), ylim=c(-3,4)) +
                                       theme(text = element_text(size=14)) + 
                                       annotate("text", x=50, y=3.75, 
    label = TeX(paste0(str_sub(apa_print(rewp_aaar_model)$full_result$ADI_NATRANK_z, 1, 36),str_sub(apa_print(rewp_aaar_model, est_name="\\beta")$full_result$ADI_NATRANK_z, 58, 67))), 
                                                color = "black", rot = 0, size=4),
                                     scatterplot_275425_adi + 
                                       coord_cartesian(xlim=c(0,100), ylim=c(-3,4)) +
                                       theme(text = element_text(size=14)) + 
                                       annotate("text", x=50, y=3.75, 
     label = TeX(paste0(str_sub(apa_print(p3_aaar_model)$full_result$ADI_NATRANK_z, 1, 36),str_sub(apa_print(p3_aaar_model, est_name="\\beta")$full_result$ADI_NATRANK_z, 58, 67))), 
                                                color = "black", rot = 0, size=4),
    common.legend = TRUE, legend = "bottom",
    ncol = 1, nrow = 2,
    align="v")
adi_plots_scatter <- annotate_figure(adi_plots_scatter, 
                                   left=text_grob("Mean amplitude (µV) to acceptance", color = "black", rot = 90, size=12))

tiff(here("figures/figure_2.tiff"), width = 6, height = 7.5, units = "in", res = 500)
adi_plots_scatter; dev.off()
```

```{r, include=FALSE, results='asis', fig.height=7, fig.width=5, fig.cap=paste("Interactions for which SES significantly moderated association between brain responses to acceptance and negative affect. Orange lines = -1 standard deviation below the mean SES; Blue lines = +1 standard deviation above the mean. SES x RewP~resid~ interaction: ",paste0('beta= ',round3(rewp_na_stat$estimate),', p= ',round3(rewp_na_stat$p.value)),"; no simple slopes significant. SES x P300~resid~ interaction: ",paste0('beta= ',round3(p300_na_stat$estimate),', p= ',round3(p300_na_stat$p.value)),"; simple slope significant for SES -1 SD.")}
model_150275_ema_na_stats <- filter(tidy(model_150275_ema_na),term=="ADI_NATRANK_z:AA_AR_z" & component=="cond")
model_275425_ema_na_stats <- filter(tidy(model_275425_ema_na),term=="ADI_NATRANK_z:AA_AR_z" & component=="cond")

adi_plots_na <- ggarrange(plot_150275_adi_na + 
                            # coord_cartesian(xlim=c(-4,3), ylim=c(1.5,3.5)) + 
                            rremove("ylab")
                                  + annotate("text", x=-2, y=2.2, 
                                                label = paste0("b = ",round3(m_rewp_acc_ss$emtrends[1,2]), 
                                                               " p = ",round3(m_rewp_acc_ss$emtrends[1,6])),
                                                color = "darkblue", rot = 0, size=4)
                                  + annotate("text", x=-2, y=3.25, 
                                                label = paste0("b = ",round3(m_rewp_acc_ss$emtrends[2,2]), 
                                                               " p = ",round3(m_rewp_acc_ss$emtrends[2,6])),
                                                color = "orange", rot = 0, size=4),
                          plot_275425_adi_na + 
                            # coord_cartesian(xlim=c(-4,3), ylim=c(1.5,3.5)) + 
                            rremove("ylab")
                                  + annotate("text", x=-1.25, y=2.25, 
                                                label = paste0("b = ",round3(m_p300_acc_ss$emtrends[1,2]), 
                                                               " p = ",round3(m_p300_acc_ss$emtrends[1,6])),
                                                color = "darkblue", rot = 0, size=4)
                                  + annotate("text", x=-1.25, y=3.45, 
                                                label = paste0("b = ",round3(m_p300_acc_ss$emtrends[2,2]), 
                                                               " p = ",round3(m_p300_acc_ss$emtrends[2,6]),"**"),
                                                color = "orange", rot = 0, size=4),
    # labels = c("A","B"),
    # label.x = c(rep(.04,4)),
    # label.y = c(rep(1,4)),
    heights = c(4, 4),
    common.legend = FALSE, legend = "none",
    ncol = 1, nrow = 2,
    align="v")
adi_plots_na <- annotate_figure(adi_plots_na, left=text_grob("Mean negative affect (cubed root)", rot=90, color = "black", size=14))

tiff(here("figures/figure_3.tiff"), width = 6, height = 7.5, units = "in", res = 500)
adi_plots_na; dev.off()
```