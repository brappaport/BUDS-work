---
title             : "Socioeconomic status and adolescent brain responses to peer feedback: Testing the impact on negative affect over time"
shorttitle        : "___"

author: 
  - name          : "Brent I. Rappaport"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "680 N. Lakeshore Drive, Suite 1520, Chicago, IL 60611"
    email         : "brent.rappaport@northwestern.edu"
    role:         # Contributorship roles (e.g., CRediT, https://casrai.org/credit/)
      - "Conceptualization"
      - "Formal analysis"
      - "Writing - Original Draft Preparation"
      - "Writing - Review & Editing"
  - name          : "James E. Glazer"
    affiliation   : "1"
    role:
      - "Methodology"
      - "Writing - Review & Editing"
  - name          : "Lilian Li"
    affiliation   : "1"
    role:
      - "Methodology"
      - "Writing - Review & Editing"
  - name          : "Madeline M. McGregor"
    affiliation   : "1"
    role:
      - "Writing - Review & Editing"
  - name          : "Lili Massac"
    affiliation   : "2"
    role:
      - "Writing - Review & Editing"
  - name          : "Randy Auerbach"
    affiliation   : "2"
    role:
      - "Conceptualization"
      - "Fundind acquisition"
      - "Investigation"
      - "Methodology"
      - "Resources"
      - "Supervision"
      - "Writing - Review & Editing"
  - name          : "Stewart A. Shankman"
    affiliation   : "1"
    role:
      - "Conceptualization"
      - "Fundind acquisition"
      - "Investigation"
      - "Methodology"
      - "Resources"
      - "Supervision"
      - "Writing - Review & Editing"

affiliation:
  - id            : "1"
    institution   : "Department of Psychiatry, Feinberg School of Medicine, Northwestern University"
  - id            : "2"
    institution   : "Columbia University"

abstract: |
  Greater neighborhood deprivation is a potent risk factor for psychopathology in youth, however the mechanisms linking them are yet unknown. One potential neural mechanism is aberrant  brain responding to peer acceptance and rejection. Objective: Test whether area deprivation interacts with brain responses to peer feedback, and whether this interaction predicts affect prospectively. Methods: 161 adolescent participants (ages 13-19) from the Chicago, IL and New York, NY metro areas completed an event-related potential (ERP) version of the Chatroom task, followed by a week of ecological momentary assessment (EMA) reporting on their positive and negative affect. Results: Area deprivation (Area Deprivation Index [ADI]) and self-reported discrimination distress (Adolescent Discrimination Distress Index [ADDI]) both independently interacted with brain responses to peer acceptance and rejection: greater deprivation was associated with a blunted response to acceptance relative to rejection for a reward-related ERP component (RewP), but with an enhanced response to rejection relative to acceptance (i.e., rejection sensitivity) for a salience-relavent ERP component (P300). Moreover, P300 response interacted with area deprivation to predict prospective, EMA reported negative, but not positive, affect during the following week. Conclusion: Area deprivation, and discrimination, may be linked to depression and anxiety disorder via an adaptively skeptical perspective of acceptance and enhanced sensitivity to rejection. Though adaptive in hostile contexts, these patterns of brain responding may be detrimental in supportive contexts.
  
keywords          : "social feedback, socioeconomic status, area deprivation, negative affect, discrimination"

bibliography      : "BUDS.bib"
floatsintext      : no
linenumbers       : no
draft             : no
mask              : no
figurelist        : no
tablelist         : no
footnotelist      : no
csl               : "`r system.file('rmd', 'apa7.csl', package = 'papaja')`"
documentclass     : "apa7"
output            : papaja::apa6_doc
editor_options: 
  markdown: 
    wrap: sentence
    
header-includes:
    - \raggedbottom
---

```{r analysis-preferences}
knitr::opts_chunk$set(set.seed(312), warning=FALSE, message=FALSE, include=FALSE, results='hide')
    options(width=80, Ncpus = 6, mc.cores=6, max.print=1000000, scipen = 999) #Set width, multiple cores, and not to use scientific notation
    rm(list=ls())     #Remove everything from environment
    cat("\014")       #Clear Console

  # library(knitr)      #allows rmarkdown files
  library(haven)      #helps import stata
  library(expss)      #labeling variables/values
  library(broom)      #nice statistical output
  library(here)       #nice file paths
  library(psych)      #used for statistical analyses
  library(Hmisc)
  library(purrr)
  library(haven)      #to import SPSS files
  library(MASS)       #to create residualized scores
# Models
  library(lmerTest)
  library(glmmTMB)
# Plotting
  library(ggplot2)    #creates plots
  library(ggpubr)
  library(ggeffects)
  library(sjPlot)
  library(sjPlot)
  library(marginaleffects)
  library(interactions)
  library(emmeans) # testing simple slopes

  library(datawizard)
  library(performance)
  library(Rmisc)
  library(vtable)
# General tools
  library(tidyverse)  #plotting/cleaning, etc.
  library(papaja)
  library(workflowr)  #helps with workflow

here <- here::here
r_refs("BUDS.bib")
```

```{r Load data}
here::i_am("BUDS_manuscript_working.Rmd")

for (d in c(50150, 150275, 275425)) {
  print(eval(parse(text=paste0('load(file=here("../data/df_',d,'.RData"))'))))
}

load(file=here("../data/BUDS_behavior.RData"))

load(file=here("../data/BUDS_cleaning04_ga.RData"))
load(file=here("../data/BUDS_cleaning04_gaplots.RData"))

spearman_brown <- read.csv(file=here("../tables/spearman_brown.csv"))
```

```{r, remove subjects with too few trials}
bad_150275 <- c(1025,
1055,
1084,
1090,
1101,
1122,
1124,
9015,
9017,
9019,
9035,
9051,
9057,
9081,
9082)

bad_275425 <- c(1055,
1084,
1090,
1101,
1124,
9015,
9017,
9019,
9035,
9051,
9081,
9082)

for (t in c("150275","275425")) {
  eval(parse(text=paste0('
    df_',t,'_cz <- df_',t,'_cz %>%
      dplyr::filter(!ID %in% bad_',t,')
      
    df_',t,'_cz_long <- df_',t,'_cz_long %>%
      dplyr::filter(!ID %in% bad_',t,')
      
      df_',t,'_cz_long_strain <- df_',t,'_cz_long_strain %>%
      dplyr::filter(!ID %in% bad_',t,')
      
    df_',t,'_cz_ema <- df_',t,'_cz_ema %>%
      dplyr::filter(!ID %in% bad_',t,')
      ')))
}
```

```{r Functions}
# from https://www.r-bloggers.com/2020/07/create-a-publication-ready-correlation-matrix-with-significance-levels-in-r/

correlation_matrix <- function(df,
                               type = "pearson",
                               digits = 3,
                               decimal.mark = ".",
                               use = "all",
                               show_significance = TRUE,
                               replace_diagonal = FALSE,
                               replacement = ""){
  
  # check arguments
  stopifnot({
    is.numeric(digits)
    digits >= 0
    use %in% c("all", "upper", "lower")
    is.logical(replace_diagonal)
    is.logical(show_significance)
    is.character(replacement)
  })
  # we need the Hmisc package for this
  require(Hmisc)
  
  # retain only numeric and boolean columns
  isNumericOrBoolean = vapply(df, function(x) is.numeric(x) | is.logical(x), logical(1))
  if (sum(!isNumericOrBoolean) > 0) {
    cat('Dropping non-numeric/-boolean column(s):', paste(names(isNumericOrBoolean)[!isNumericOrBoolean], collapse = ', '), '\n\n')
  }
  df = df[isNumericOrBoolean]
  
  # transform input data frame to matrix
  x <- as.matrix(df)
  
  # run correlation analysis using Hmisc package
  correlation_matrix <- Hmisc::rcorr(x, type = )
  R <- correlation_matrix$r # Matrix of correlation coeficients
  p <- correlation_matrix$P # Matrix of p-value
  
  # transform correlations to specific character format
  Rformatted = formatC(R, format = 'f', digits = digits, decimal.mark = decimal.mark)
  
  # if there are any negative numbers, we want to put a space before the positives to align all
  if (sum(R < 0) > 0) {
    Rformatted = ifelse(R > 0, paste0(' ', Rformatted), Rformatted)
  }
  
  # add significance levels if desired
  if (show_significance) {
    # define notions for significance levels; spacing is important.
    stars <- ifelse(is.na(p), "   ", ifelse(p < .001, "***", ifelse(p < .01, "** ", ifelse(p < .05, "*  ", "   "))))
    Rformatted = paste0(Rformatted, stars)
  }
  # build a new matrix that includes the formatted correlations and their significance stars
  Rnew <- matrix(Rformatted, ncol = ncol(x))
  rownames(Rnew) <- colnames(x)
  colnames(Rnew) <- paste(colnames(x), "", sep =" ")
  
  # replace undesired values
  if (use == 'upper') {
    Rnew[lower.tri(Rnew, diag = replace_diagonal)] <- replacement
  } else if (use == 'lower') {
    Rnew[upper.tri(Rnew, diag = replace_diagonal)] <- replacement
  } else if (replace_diagonal) {
    diag(Rnew) <- replacement
  }
  
  return(Rnew)
}

lmer_adi_interaction_table <- function(data) {
  new_model <- data.frame(model = c("Both","Like","Dislike"),
                            beta = NA, 
                            p = NA)
new_model$beta <- c(broom.mixed::tidy(lmer(formula = ERP ~ Feedback*Voting*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = data))[8,4], broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Like")))[4,4],
                        broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Dislike")))[4,4])

new_model$p <- c(broom.mixed::tidy(lmer(formula = ERP ~ Feedback*Voting*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = data))[8,8], broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Like")))[4,8],
                        broom.mixed::tidy(lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + (1 | ID), REML=TRUE, data = filter(data, Voting=="Dislike")))[4,8])
new_model
}

plot_stats <- function(model, var) {
  temp_stats <- tidy(model) %>% 
    dplyr::filter(term==var) %>%
    dplyr::select(estimate,p.value) %>%
    round(., 3)
  paste0("b = ", temp_stats[1], ", p = ", temp_stats[2])
}
```

Two potent risk factors for adolescent mental illness are a disadvantaged environment and poor social relationships...Difficulty forming and maintaining social relationships is a key complaint of adolescents suffering from multiple forms of mental illness, and has been at least partially attributed to aberrant responding to peer acceptance and rejection (CITE).
At the same time, socioeconomic status and related measures (e.g., neighborhood disadvantage) are known risk factors for mental illness among youth.
However, it remains unclear whether area deprivation is tied to differences in responded to peer feedback.

Numerous studies support area deprivation has a risk factor for worsened mental health outcomes (BARCH & LUBY).
There are a number of potential pathways through via deprivation confers risk, including affecting brain volume and structure (BARCH & TAYLOR).
Sociological research shows that deprivation is associated with greater social rejection and discrimination (CITE), and altered perceptions of others (CITE).
Therefore, one possible pathway is via altered neural responsivitiy to social feedback (i.e., being accepted and rejected by others).
Furthermore, it remains unclear which aspect of area deprivation confers the greatest risk.
One such aspect of area deprivation particularly relevant to social feedback is discrimination: the unjust or prejudicial treatment of different categories of people [@oxfordenglishdictionaryDiscrimination2023].
Given that youth living in more economically deprived areas are more likely to experience discrimination,

Aberrant responding to social feedback has recently been proposed as a key transdiagnostic mechanisms of internalizing disorders, (CITE), developing particularly in adolescence.
As a time when peer relationships and interactions are the most salient, difficulties in properly responding to peer feedback can have consequences for youth's mental health.
For example, over-sensitivity to peer rejection has been tied to risk for depression and anxiety (CITE), while anhedonic responses to peer acceptance with depression (CITE).

Prior tasks have examined relationships between social feedback brain responsivity and symptoms or stressors, however very few have tested whether area deprivation moderates such brain responses and links to symptoms.
For example, studies find that depression is linked to hyperactivity of the insula [@rappaportBrainResponsesSocial2020] to negative social feedback, such as rejection, and that brain activity in such regions may moderate the link between peer interpersonal stress and depression [@pagliaccioNeuralSensitivityPeer2022].
One recent studied using event-related potentials (ERPs)--time-locked electroencephalography (EEG) waveforms--found that lower socioeconomic status was related to a more blunted reward response to social acceptance [@rappaportBehavioralPsychiatricCorrelates].

Psychophysiological tasks, with their high temporal resolution, can clarify whether area deprivation is associated with heightened sensitivity to rejection, blunted responses to acceptance, or decreased attention to social feedback.
These questions can be tested using distinct ERP components: P3 for rejection sensitivity, RewP for acceptance sensitivity, and N1 for attention to social feedback.
These components have been identified in similar social feedback tasks (CITE).

Finally, in prior studies, measuring symptoms has relied on self-report on questionnaires at single time points.
Numerous issues have been raised with this, including bias in reporting and lack of ecological validity (CITE).
Ecological momentary assessment addresses many of these concerns, as participants respond to questionnaires many times throughout their day-to-day lives [@moskowitzEcologicalMomentaryAssessment2006].
For this reason, it is thought to provide a more sensitive and accurate measure of participants' symptoms.

The current study, then, aims to robustly test the following primary hypotheses: 1) area deprivation will moderate brain responses to different kinds of peer feedback (acceptance and rejection), 2) this moderation will predict EMA reports of psychopathology.
Follow up analyses will also explore: 1) whether self-report discrimination distress moderates brain responses to different kinds of peer feedback, 2) whether self-report discrimination distress will also moderate the association between brain responses to peer feedback to and EMA reports of psychopathology.
In doing so, this study becomes the first to examine whether area deprivation/SES moderate associations between brain responses to social feedback and symptoms of psychopathology.
An additional exploratory aim of the current study is to test whether discrimination-related distress represents a particularly active aspect of area deprivation that alters brain responses to peer feedback.
Methodological strengths of the current study include: 1) novel identification and validation of ERPs in a task previously used exclusively with fMRI, 2) a diverse sample of youth from two major metropolitan areas, 3) objective and validated measures of area deprivation, 4) inclusion of clinically and demographically relevant covariates, and 5) ecological momentary assessment of participants' affect during the week following the ERP task.

# Methods

## Participants (Maddie)

Participant data was acquired from a larger, ongoing project examining social processing deficits in adolescent depression.
Adolescents, ages 13-18-years-old, were recruited from the community (via ads on public transportation, Facebook, and craigslist) and mental health clinics in New York City, NY and Chicago, IL. Informed assent and consent were obtained from the adolescent and parent, respectively, and adolescents 18 years or older provided consent.
All study procedures were carried out in accordance with the Declaration of Helsinki and approved by the New York State Psychiatric (NYSPI) (primary) Institutional Review Board (IRB) and the Northwestern University IRB. General inclusion criteria included: (a) Tanner Stage ≥ 3 (Tanner & Davies, 1985), (b) parental and child fluency in English, (c) Wechsler Abbreviated Scale of Intelligence-II (WASI-II) \> 85 (Wechsler, 2011), (d) ownership of a personal smartphone (android or iOS), and (e) right-handedness.
General exclusion criteria included: (a) history of head injury or neurological disorders, (b) current moderate or severe substance use disorder, and (c) lifetime history of bipolar or psychotic disorders, oppositional defiant disorder, conduct disorder, organic mental disorder, or developmental disorder.
## number of participants were available to analyze for the present study.
Table [\#] summarizes the participant demographic and clinical characteristics.

```{r}
library(scipub)
# df_50150_cz_strain %>%
#   filter(complete.cases(AA_AR)) %>%
#   select(Age)

demo <- df_50150_cz_ema %>%
  group_by(ID) %>%
  reframe(Age = mean(Age, na.rm=T),
          demo_child_gender = mean(ADI_NATRANK, na.rm=T),
          AA_AR = mean(AA_AR, na.rm=T)) %>%
  filter(Age >=18 & complete.cases(AA_AR))

# FullTable1(demo)
```

## Procedure

### Chatroom task (Maddie)

The Chatroom Task [@guyerAmygdalaVentrolateralPrefrontal2008; @guyerProbingNeuralCorrelates2009] was completed over two visits.
At baseline, participants were told that they were participating in a multisite study on adolescent interactions in online chatrooms.
Participants created profiles including their likes/dislikes and a photograph taken in the lab; they were told that other participants would review their profile and indicate interest (peer acceptance) or not (peer rejection) in chatting.
Next, participants viewed photographs of \## same-sex peers and selected 50 that they were 'interested' (high value) and 50 that they were 'not interested' (low value) in chatting with online following MRI.
On each of 100 trials during EEG recording (\~*1--2??* weeks later; Figure 1), a peer photograph was displayed with a reminder of participants' prior choice: 'You were [not] interested' (cue), followed by a fixation cross for a jittered inter-stimulus interval (ISI; anticipation).
Next, peer acceptance or rejection feedback was displayed: 'Interested' or 'Not Interested' (feedback), followed by a second jittered ISI.
Finally, participants rated their emotional response (rating).
Participants received 30 acceptance and 30 rejection trials (split by participant interest, e.g., n = 15 when participants were interested and accepted), pseudorandomized with no more than three sequential acceptances/rejections.
After EEG recording was completed, participants were debriefed on the deception and completed a brief questionnaire about their experience.
This questionnaire (with each item rated on a scale from 1-10) was used to assess retrospective task engagement, happiness ("How happy were you when someone expressed interest in chatting with you?"), upset ("How upset were you when someone rejected you?"), anger ("How angry did you feel when rejected?"), and nervousness ("How nervous did you feel while waiting for the other person to make their choice?").
We also assessed how much experience they have with social media ("How much experience do you have using social media instant messaging (chatrooms, instant messenger, etc)?"
). We also assessed whether participants believed that they would be able to chat with the peers after the task ("While you were doing the chatroom, did you believe that you would really be chatting with one of these people on the computer after your EEG?"
), as well as "why not" if they endorsed not believing that they would be able to chat with them.

Importantly, the structure of the task results in four within-subject conditions: 1) acceptance from high-value peers (i.e., peers that participants were interested in talking to), 2) rejection from high-value peers, 3) acceptance from low-value peers (i.e., peers that participants were not interested in talking to), and 4) rejection from low-value peers.

### EEG recording and processing

INFO ABOUT EEG SETUP, RECORDING, and PROCESSING

How many subjects excluded for too few trials, etc.

Figures 1.
Task 2.
Grand average waveforms, and scalp topographies for N100, RewP, P300 3.
Feedback x Voting x ADI interaction, Feedback x Voting x ADDI interaction, 3.
ERP x ADI predicting Negative Affect interaction S1.
Association between ADI and ADDI S2.
Feedback x Voting x ADDI interaction

N1 RewP P300

### Ecological momentary assessment (EMA) (Maddie)

Ecological momentary assessment data was collected using the Effortless Assessment of Risk States (EARS) app.
For seven days after completing the Chatroom task, participants received four notifications each day prompting them to complete a set of 11-items regarding their current mood and social interactions.
These notifications were sent between: 6:30am-10:30am, 3:00pm-5:00pm, 5:00pm- 7:00pm, and 7:00-9:00pm.
Surveys were available for 90 minutes after the initial notification and participants were able to decline answering any question.
Participants were compensated 1 dollar for every completed set of questions for a maximum of 4 dollars per day and 28 dollars total.
Participants rated 11 items of a scale from #-#.
They rated how happy, excited, supported, angry, anxious, sad, and rejected they felt.
The first three were averaged into a positive affect composite, and the latter four in a negative affect composite.
Participants also rated two items related to the social effort they exerted in the past 2 hours ("In the past 2 hours, I shared my emotions with others.", "In the past 2 hours, I made a lot of effort to connect with others."), which were averaged into a social effort composite.
Participants also rated two items related to how much they were looking forward to future social contact ("Over the next 2 hours, I am looking forward to receiving messages from friends.", "Over the next 2 hours, I am looking forward to having meaningful conversations with friends."), which were averaged into a social future composite.
For all composites, listwise deletion was used (i.e., if subjects were missing a value for "sad" their negative affect composite score was missing for that time point).

## Measures

### SES: Area Deprivation Index (ADI) (Lili)

The area deprivation index [@kindMakingNeighborhoodDisadvantageMetrics2018a; @universityofwisconsinschoolofmedicineandpublichealthAreaDeprivationIndex2023] is a composite measure based on 17 dimensions of socioeconomic disadvantage including education, employment, housing quality, and poverty-related factors, all measured via the American Community Survey.
Neighborhoods are determined based on census tracts and are ranked from 1 to 100, where a higher ranking indicates greater levels of neighborhood disadvantage.
In cases when ADI values were missing for subjects (e.g., suppression due to a high group quarter population), ADI was estimated using the ADI of the nearest census tract with available data.
This was often tracts \<1 mile from the original address.
Of note, we reverse scored the ADI to make it interpretable as SES (i.e., higher scores represent greater SES/lower ADI).

### Discrimination distress: Adolescent Discrimination Distress Index (ADDI) (Lili)

Discrimination-related distress was measured using the Adolescent Discrimination Distress Index [ADDI, @fisherDiscriminationDistressAdolescence2000].
The ADDI is a 15-item self-report measure that assesses the distress experienced in response to perceived racial-ethnic discrimination across institutional, educational, and peer contexts.
Each item includes a statement outlining a common example of discrimination (i.e. "You were called racially insulting names"; "You were wrongly disciplined or given after-school detention").
If a participant endorses that they experienced a given sample of discrimination on account of their race or ethnicity, they are then asked to rate how much the experience upset them on a five-point Likert scale from "not at all" to "extremely".
In the current study, full-scale summary scores were used, where higher scores indicate greater discrimination-related distress.

### Covariates

#### Depression and anxiety symptoms: Inventory of depression and anxiety symptoms (IDAS-II) (Maddie)

The expanded Inventory of Depression and Anxiety Symptoms (IDAS-II; Watson, et al., 2012) is a 99-item, self-report instrument that measures the severity of depression, anxiety, and bipolar disorder symptoms over the past two weeks.
Items are scored on a 5-point scale (1 = not at all; 5 = extremely).
For the present study, 52-items were selected to assess current depression and anxiety symptoms.

#### Stressful life events and severity of stressful life events: Stress and adversity inventory (STRAIN) (Lili)

The Stress and Adversity Inventory for Adolescents (STRAIN, @slavichStressAdversityInventory2019) was administered to measure participants' exposure to acute and lifetime stressors.
This interview assesses exposures to 75 different stressors across 12 primary life domains (i.e. Housing, Education, Work, Treatment/Health, Marital/Partner, Reproduction, Financial, Legal/Crime, Other Relationships, Parent/Guardian, Death, Life-Threatening Situations) and five social-psychological characteristics (i.e. Interpersonal Loss, Physical Danger, Humiliation, Entrapment, Role Change/Disruption).
If a participant endorses a stressor, they are then asked additional questions about its severity, frequency, timing, and duration.
Based on these answers, the STRAIN produces a summary score that notes participants' total lifetime stressor count and severity for all the acute life events and chronic difficulties experienced.
Here, higher scores indicate greater stress exposure.
In prior studies, the STRAIN has shown excellent test-retest reliability for total lifetime stressor count and severity over 2-4 weeks [$r$ = 0.90---0.95, @cazassaStressAdversityInventory2020; @slavichAssessingLifetimeStress2018]

## Data analysis

### ERP task effects and behavioral ratings

Paired samples t-tests were used to compare ERP responses to acceptance and rejection from a) high-valued peers, and b) low-value peers and behavioral ratings.

### Multilevel multiple regression models

#### SES x Feedback type

Multilevel multiple regression models (MLMs) were used to test whether SES interacted with Feedback type to predict ERP mean amplitude moderated associations.
This models random intercept effects of study site.
In some models, the random effect of site accounted for so little variance (likely due to the fact that there were only two sites) that the model was singular (i.e., that the variance of the random effect was essentially zero); in these cases site was included instead as a fixed effect (i.e., covariate).

#### SES x ERP component predicting EMA measures

Multilevel multiple regression models (MLMs) were used to test whether ERP mean amplitude moderated associations ADI and mean negative affect over the following week.
These models included random intercept effects of subject and study site.
In some models, the random effect of site accounted for so little variance (likely due to the fact that there were only two sites) that the model was singular (i.e., that the variance of the random effect was essentially zero); in these cases site was included instead as a fixed effect (i.e., covariate).
Given a positive skew and large number of 0's in the measure of negative affect, negative affect was cube-root transformed and zero-inflated Gaussian MLM models were used.
Visual diagnostic checks for model assumptions were conducted to assure that models were accurately specified (e.g., posterior predictive checks, homogeneity of variance, normality of residuals, colinearity, and normality of random effects).
Only predictors of interest were included in the zero-inflation portion of the model.
The zero-inflation portion of the model also included random intercept effects of subject and study site (or in the case of singular model fit, study site as a fixed effect).

# Results

## Task-derived ERPs

```{r}
Cz_ga_aa_ar_plot <- ggplot(data=filter(df_ga_Cz_long, Condition=="Acc_Acc" | Condition=="Acc_Rej" | Condition=="AA_AR"), aes(x=Time, y=grand_average, color=Condition)) +
  geom_line(linewidth=1) +
  xlim(-200,1000) +
  annotate("rect", xmin=50, xmax=150, ymin=-5, ymax=Inf, alpha=0.2, fill="orange") +
  annotate("rect", xmin=150, xmax=275, ymin=-5, ymax=Inf, alpha=0.2, fill="yellow") +
  annotate("rect", xmin=275, xmax=425, ymin=-5, ymax=Inf, alpha=0.2, fill="blue") +
  geom_rect(aes(xmin=0, xmax=0, ymin=-5, ymax=12), color="black") +
  geom_rect(aes(xmin=-200, xmax=1000, ymin=0, ymax=0), color="black") +
  scale_color_manual(breaks=c("Acc_Acc","Acc_Rej","AA_AR"),
                     values=c("Acc_Acc"="green", "AA_AR"="black", "Acc_Rej"="red"), 
                     labels=c("Acceptance","Rejection","Difference"), name=NULL) +
  labs(x="Time (ms)", y="Cz") +
  theme_apa() + theme(legend.position="top")

# load(file=here("/data/BUDS_cleaning04_topo_windows.RData"))
```

```{r grand average, fig.cap = "Colored sections of the graph represent time windows where ERP components were extracted at Cz electrode: N1 = orange, RewP = yellow, P300 = blue"}
plot(Cz_ga_aa_ar_plot)
```

### Derived ERP components and differences between feedback conditions

We found two primary ERP components differentiate response to acceptance and rejection from high value (i.e., liked) and low value (i.e., disliked) peers.
These had time courses and scalp topographies (Cz) consistent with a reward positivity (RewP; 150-275ms, N=) and P300 (275-425ms).
The RewP significantly differed between conditions (acceptance and rejection from high-value peers; `r apa_print(t.test(df_150275_cz$Acc_Acc, df_150275_cz$Acc_Rej, paired=TRUE))$full_result`, acceptance and rejection from low-value peers: `r apa_print(t.test(df_150275_cz$Rej_Acc, df_150275_cz$Rej_Rej, paired=TRUE))$full_result`.
The P300 did not differ between acceptance and rejection from high-value peers (`r apa_print(t.test(df_275425_cz$Acc_Acc, df_275425_cz$Acc_Rej, paired=TRUE))$full_result`), but did for acceptance and rejection from low-value peers (``` r``apa_print(t.test(df_275425_cz$Rej_Acc, df_275425_cz$Rej_Rej, paired=TRUE))$full_result) ```.

Furthermore, based on grand average waveforms, and for the sake of testing the specificity of our findings to a priori ERP components of interest, we also extracted an N100 component from 50-150ms (acceptance and rejection from high-value peers: `r apa_print(t.test(df_50150_cz$Acc_Acc, df_50150_cz$Acc_Rej, paired=TRUE))$full_result`, low-value peers: `r apa_print(t.test(df_50150_cz$Rej_Acc, df_50150_cz$Rej_Rej, paired=TRUE))$full_result`) .
All components were extracted from electrode Cz.

## Feedback x Value interaction

```{r}
lmer_interaction_table <- function(data) {
  new_model <- data.frame(component = deparse(substitute(data)),
               beta = broom.mixed::tidy(anova(lmer(formula = ERP ~ Feedback*Voting + site + (1 | ID), REML=TRUE, data = data)))[4,6], 
               p = broom.mixed::tidy(anova(lmer(formula = ERP ~ Feedback*Voting + site + (1 | ID), REML=TRUE, data = data)))[4,7])
  return(new_model)
}

fxv_int_table <- rbind(lmer_interaction_table(df_50150_cz_long),
                       lmer_interaction_table(df_150275_cz_long),
                       lmer_interaction_table(df_275425_cz_long))


model_50150_no_adi <- plot_cap(
    lmer(formula = ERP ~ Feedback*Voting + (1 | ID) + (1 | site), REML=TRUE, data = df_50150_cz_long),
    condition = list(
        "Voting",
        "Feedback"),
    draw = FALSE) %>%
  mutate(Value = case_match(Voting, "Dislike" ~ "Low value",
                                    "Like" ~ "High value"),
         Feedback = case_match(Feedback, "Acc" ~ "Acceptance",
                                    "Rej" ~ "Rejection"))

model_150275_no_adi <- plot_cap(
    lmer(formula = ERP ~ Feedback*Voting + (1 | ID), REML=TRUE, data = df_150275_cz_long),
    condition = list(
        "Voting",
        "Feedback"),
    draw = FALSE) %>%
  mutate(Value = case_match(Voting, "Dislike" ~ "Low value",
                                    "Like" ~ "High value"),
         Feedback = case_match(Feedback, "Acc" ~ "Acceptance",
                                    "Rej" ~ "Rejection"))

model_275425_no_adi <- plot_cap(
    lmer(formula = ERP ~ Feedback*Voting + (1 | ID) + (1 | site), REML=TRUE, data = df_275425_cz_long),
    condition = list(
        "Voting",
        "Feedback"),
    draw = FALSE) %>%
  mutate(Value = case_match(Voting, "Dislike" ~ "Low value",
                                    "Like" ~ "High value"),
         Feedback = case_match(Feedback, "Acc" ~ "Acceptance",
                                    "Rej" ~ "Rejection"))

plot_50150 <- ggplot(model_50150_no_adi, aes(x=Value, y=estimate, fill=Feedback)) +
  geom_bar(position = "dodge", stat = "identity", colour="black") +
  geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = c("gray", "white"), name = "Feedback") +
  theme_apa() +
  labs(x="", y="N1") +
  theme(axis.text.x=element_blank())

plot_150275 <- ggplot(model_150275_no_adi, aes(x=Value, y=estimate, fill=Feedback)) +
  geom_bar(position = "dodge", stat = "identity", colour="black") +
  geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = c("gray", "white"), name = "Feedback") +
  theme_apa() +
  labs(x="", y="RewP") +
  theme(strip.background = element_blank(),strip.text.x = element_blank(), axis.text.x=element_blank())

plot_275425 <- ggplot(model_275425_no_adi, aes(x=Value, y=estimate, fill=Feedback)) +
  geom_bar(position = "dodge", stat = "identity", colour="black") +
  geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = c("gray", "white"), name = "Feedback") +
  theme_apa() +
  labs(x="Peer value", y="P3") +
  theme(strip.background = element_blank(),strip.text.x = element_blank())
```

```{r, eval=FALSE}
task_plots <- ggarrange(plot_50150, plot_150275, plot_275425,
          labels = c("A","B","C"),
          label.x = c(rep(.04,3)),
          label.y = c(rep(1,3)),
          common.legend = TRUE, legend = "bottom",
          ncol = 1, nrow = 3,
          align="v")
task_plots <- annotate_figure(task_plots, left=text_grob("Mean amplitude (µV)", color = "black", rot = 90, size=14))
task_plots

n1_fv_aov <- anova(lmer(formula = ERP ~ Feedback*Voting + site + (1 | ID), REML=TRUE, data = df_50150_cz_long))
rewp_fv_aov <- anova(lmer(formula = ERP ~ Feedback*Voting + site + (1 | ID), REML=TRUE, data = df_150275_cz_long))
p300_fv_aov <- anova(lmer(formula = ERP ~ Feedback*Voting + site + (1 | ID), REML=TRUE, data = df_275425_cz_long))
```

Peer-value significantly moderated brain differences between Feedback condition for the RewP (`r apa_print(rewp_fv_aov)$full_result$Feedback_Voting`), P300 (`r apa_print(p300_fv_aov)$full_result$Feedback_Voting`), but not N1 (`r apa_print(n1_fv_aov)$full_result$Feedback_Voting`).

### Internal consistency

```{r internal_consistency}
# apa_table(spearman_brown[,-1])
# N=159?
```

The RewP and P300 demonstrated acceptable levels of internal consistency across peer-value (high, low) and feedback conditions (acceptance, rejection), with split-half reliability \> 0.70 (see Supplement).
The N1 did not achieve acceptable internal consistency.

### Dependability

In dependability analyses, the RewP achieved acceptable dependability (≥0.70) with as few as 12-13 trials and the P300 with as few as 11-13 trials, depending on the peer-value and feedback condition.
The RewP and P300 both achieved good dependability (≥0.81; see Supplement).

## Behavioral ratings

### In-task ratings

```{r}
# summary(lm(rating ~ Feedback*Voting, df_BUDS_rating_it_pt))

in_task_rating_summary_stats <- summarySE(df_BUDS_rating_it_pt, measurevar="rating", groupvars=c("Feedback","Voting")) %>%
  filter(complete.cases(rating))
in_task_rating_summary_stats$Voting <- c("Low-value", "High-value", "Low-value", "High-value")
rating_plot <- ggplot(in_task_rating_summary_stats, aes(y=rating, x=Voting, fill=Feedback)) +
  geom_bar(position = "dodge", stat = "identity", colour="black") +
  geom_errorbar(aes(ymin=rating-ci, ymax=rating+ci), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = c("gray", "white"), name = "Feedback") +
  theme_apa() +
  labs(x="Peer value", y="In task, post-trial feedback rating")

# ggpaired(filter(df_BUDS_rating_it_pt,complete.cases(rating)), y="rating", x="Voting", color="Feedback", line.color = "Feedback", line.size = 0) +
#   scale_color_manual(values = c("black", "darkgray"), name = "Feedback") +
#   theme_apa() +
#   labs(x="Peer value", y="In task, post-trial feedback rating")
```

```{r rating_plot, fig.cap = "Mean ratings across all participants by Feedback and Value."}
plot(rating_plot)
```

Participants rated how they were feeling immediately after recieving feedback on a scale from 0 ("Very angry") to 100 ("Very good").
Participants rated acceptance from high-value peers (i.e., peers that they were interested in) as feeling significantly better than rejection from high-value peers (`r apa_print(t.test(rating ~ Feedback, filter(df_BUDS_rating_it_pt, Voting=="Like"), paired=TRUE))$full_result`).
However, participants rated feeling more angry in response to acceptance than rejection from low-value peers (`r apa_print(t.test(rating ~ Feedback, filter(df_BUDS_rating_it_pt, Voting=="Dislike"), paired=TRUE))$full_result`).

### Post-task ratings

```{r}
post_task_table <- st(dplyr::select(df_BUDS_rating_it_pt, SP_debriefing_interested:SP_debriefing_nervous,SP_debriefing_socialmediause),
                      out="return")[,-c(5:8)] %>%
  mutate(Measure=c("Interested","Happy","Upset","Angry","Nervous","Social Media Use")) %>%
  dplyr::select(-Variable, -N) %>%
  dplyr::select(Measure, everything())
```

```{r}
# apa_table(post_task_table)
```

During post-task debriefing, ``` r``table(df_BUDS_rating_it_pt$SP_debriefing_deceived)[1] ``` participants responsed 'yes' and `r table(df_BUDS_rating_it_pt$SP_debriefing_deceived)[2]` participants responded 'no' to the question "While you were doing the chatroom, did you believe that you would really be chatting with one of these people on the computer after your EEG?" Given the potential for deception to affect results, we present additional analyses covarying for this in the Supplement.

## Feedback type x peer value x SES interaction

Because the N1 did demonstrate acceptable internal consistency or dependability, we did not include it in further analyses.

```{r}
# models_150275_cz_table <- lmer_adi_interaction_table(df_150275_cz_long)
# models_150275_cz_table$component <- "150275_cz"

df_150275_cz_long$Feedback <- as.factor(df_150275_cz_long$Feedback)
contrasts(df_150275_cz_long$Feedback) <- contr.sum

model_150275_cz <- lmer(formula = ERP ~ Feedback*ADI_NATRANK_z*Voting + site + (1 | ID), data = df_150275_cz_long)
model_150275_cz_high <- lmer(formula = ERP ~ Feedback*ADI_NATRANK_z + site + (1 | ID), data = filter(df_150275_cz_long,Voting=="Like"))
model_150275_cz_low <- lmer(formula = ERP ~ Feedback*ADI_NATRANK_z + site + (1 | ID), data = filter(df_150275_cz_long,Voting=="Dislike"))

model_150275_adi <- plot_cap(
    model_150275_cz,
    condition = list(
      "ADI_NATRANK_z" = "threenum",
        "Feedback",
        "Voting"),
    draw=FALSE) %>%
    mutate(Value = case_match(Voting, "Dislike" ~ "Low",
                                    "Like" ~ "High"),
         Feedback = case_match(Feedback, "Acc" ~ "Acceptance",
                                    "Rej" ~ "Rejection"))

plot_150275_adi_t <- data.frame(
  label = c(plot_stats(model_150275_cz_high, "Feedback1:ADI_NATRANK_z"),
            plot_stats(model_150275_cz_low, "Feedback1:ADI_NATRANK_z")), 
  Value  = c("High", "Low"),
  Feedback=c("Acc","Rej"))

plot_150275_adi <- ggplot(filter(model_150275_adi, ADI_NATRANK_z!="Mean"), aes(x=ADI_NATRANK_z, y=estimate, fill=Feedback)) +
  geom_bar(position = "dodge", stat = "identity", colour="black") +
  geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = c("darkgreen", "red"), name = "Feedback") +
  facet_wrap(~Value) +
  geom_text(data = data.frame(
  label = c(plot_stats(model_150275_cz_high, "Feedback1:ADI_NATRANK_z"),
            plot_stats(model_150275_cz_low, "Feedback1:ADI_NATRANK_z")),
  Value  = c("High", "Low"),
  Feedback=c("Acceptance","Rejection")), aes(x = 1.5, y = 10, label = label)) +
  theme_apa() +
  labs(x="Area Deprivation", y="RewP") +
  theme(strip.background = element_blank(),axis.title.x=element_blank())

# Bar plot black and white
# plot_150275_adi <- ggplot(model_150275_adi, aes(x=ADI_NATRANK_z, y=estimate, fill=Feedback)) +
#   geom_bar(position = "dodge", stat = "identity", colour="black") +
#   geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.2, position=position_dodge(.9)) +
#   scale_fill_manual(values = c("gray", "white"), name = "Feedback") +
#   facet_wrap(~Value) +
#   geom_text(data = data.frame(
#   label = c(plot_stats(model_150275_cz_high, "Feedback1:ADI_NATRANK_z"),
#             plot_stats(model_150275_cz_low, "Feedback1:ADI_NATRANK_z")), 
#   Value  = c("High", "Low"),
#   Feedback=c("Acceptance","Rejection")), aes(x = 2, y = 11, label = label)) +
#   theme_apa() +
#   labs(x="Area Deprivation", y="RewP") +
#   theme(strip.background = element_blank(),strip.text.x = element_blank())

df_150275_cz_long$Value <- case_match(df_150275_cz_long$Voting, "Like" ~ "High",
                                                                "Dislike" ~ "Low")
# Line plot
# plot_150275_adi <- ggplot(df_150275_cz_long, aes(x=ADI_NATRANK_z, y=ERP, color=Feedback)) +
#   facet_wrap(~Value) +
#   geom_point(alpha = .3) +
#   geom_smooth(aes(group=Feedback), method = "lm") +
#   scale_color_manual(values = c("darkgreen", "red"), name = "Feedback") +
#   theme(strip.background = element_blank(), strip.text.x = element_blank()) +
#   geom_text(data = data.frame(
#   label = c(plot_stats(model_150275_cz_high, "Feedback1:ADI_NATRANK_z"),
#             plot_stats(model_150275_cz_low, "Feedback1:ADI_NATRANK_z")), 
#   Value  = c("High", "Low"),
#   Feedback=c("Acc","Rej"))
#   , size=4, aes(x = 0, y = 24, label = label)) +
#   theme_apa() +
#   labs(x="", y="RewP") +
#   theme(axis.text.x=element_blank(),
#         legend.position = "none")
```

```{r}
# models_275425_cz_table <- lmer_adi_interaction_table(df_275425_cz_long)
# models_275425_cz_table$component <- "275425_cz"

df_275425_cz_long$Feedback <- as.factor(df_275425_cz_long$Feedback)
contrasts(df_275425_cz_long$Feedback) <- contr.sum

model_275425_cz <- lmer(formula = ERP ~ Feedback*ADI_NATRANK_z*Voting + (1 | ID) + (1 | site), data = df_275425_cz_long)
model_275425_cz_high <- lmer(formula = ERP ~ Feedback*ADI_NATRANK_z + (1 | ID) + (1 | site), data = filter(df_275425_cz_long,Voting=="Like"))

summary(lmer(formula = ERP ~ Feedback*ADI_NATRANK_z + (1 | ID) + (1 | site), data = filter(df_275425_cz_long,Voting=="Like")))
summary(lmer(formula = ERP ~ Feedback*ADI_NATRANK_z + (1 | ID) + (1 | site), data = filter(df_275425_cz_long_strain, Voting=="Like")))

model_275425_cz_low <- lmer(formula = ERP ~ Feedback*ADI_NATRANK_z + (1 | ID) + (1 | site), data = filter(df_275425_cz_long,Voting=="Dislike"))

model_275425_adi <- plot_cap(
    model_275425_cz,
    condition = list(
      "ADI_NATRANK_z" = "threenum",
        "Feedback",
        "Voting"),
    draw=FALSE) %>%
    mutate(Value = case_match(Voting, "Dislike" ~ "Low",
                                    "Like" ~ "High"),
         Feedback = case_match(Feedback, "Acc" ~ "Acceptance",
                                    "Rej" ~ "Rejection"))

plot_275425_adi_beta <- data.frame(
  label = c(paste0("beta=",round(tidy(model_275425_cz_high)[4,c(4)],3),", p=",round(tidy(model_275425_cz_high)[4,c(8)],3)), paste0(" beta=",round(tidy(model_275425_cz_low)[4,c(4)],3),", p=",round(tidy(model_275425_cz_low)[4,c(8)],3))),
  Value  = c("High", "Low"),
  Feedback=c("Acceptance","Rejection")
)

plot_275425_adi_f <- data.frame(
  label = c(paste0("$F$ = ",round(tidy(anova(model_275425_cz_high))$statistic[3],2),", p=",round(tidy(anova(model_275425_cz_high))$p.value[3],2)), 
            paste0("$F$ =",round(tidy(anova(model_275425_cz_low))$statistic[3],2),", p=",round(tidy(anova(model_275425_cz_low))$p.value[3],2))), 
  Value  = c("High", "Low"),
  Feedback=c("Acceptance","Rejection")
)

plot_275425_adi_t <- data.frame(
  label = c(plot_stats(model_275425_cz_high, "Feedback1:ADI_NATRANK_z"),
            plot_stats(model_275425_cz_low, "Feedback1:ADI_NATRANK_z")), 
  Value  = c("High", "Low"),
  Feedback=c("Acc","Rej"))

ggplot(filter(model_275425_adi, ADI_NATRANK_z!="Mean"), aes(x=Feedback, y=estimate, fill=ADI_NATRANK_z)) +
  geom_bar(position = "dodge2", stat = "identity", colour="black") +
  geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.2, position=position_dodge(.9)) +
  # scale_fill_manual(values = c("gray", "white"), name = "Feedback") +
  facet_wrap(~Value)


plot_275425_adi <- ggplot(filter(model_275425_adi, ADI_NATRANK_z!="Mean"), aes(x=ADI_NATRANK_z, y=estimate, fill=Feedback)) +
  geom_bar(position = "dodge", stat = "identity", colour="black") +
  geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = c("darkgreen", "red"), name = "Feedback") +
  facet_wrap(~Value) +
  geom_text(data = data.frame(
  label = c(plot_stats(model_275425_cz_high, "Feedback1:ADI_NATRANK_z"),
            plot_stats(model_275425_cz_low, "Feedback1:ADI_NATRANK_z")),
  Value  = c("High", "Low"),
  Feedback=c("Acceptance","Rejection")), aes(x = 1.5, y = 11, label = label)) +
  theme_apa() +
  labs(x="Area Deprivation", y="P3") +
  theme(strip.background = element_blank(),strip.text.x = element_blank())

# Black and while bar plot
# plot_275425_adi <- ggplot(model_275425_adi, aes(x=ADI_NATRANK_z, y=estimate, fill=Feedback)) +
#   geom_bar(position = "dodge", stat = "identity", colour="black") +
#   geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.2, position=position_dodge(.9)) +
#   scale_fill_manual(values = c("gray", "white"), name = "Feedback") +
#   facet_wrap(~Value) +
#   geom_text(data = data.frame(
#   label = c(plot_stats(model_275425_cz_high, "Feedback1:ADI_NATRANK_z"),
#             plot_stats(model_275425_cz_low, "Feedback1:ADI_NATRANK_z")), 
#   Value  = c("High", "Low"),
#   Feedback=c("Acceptance","Rejection")), aes(x = 2, y = 11, label = label)) +
#   theme_apa() +
#   labs(x="Area Deprivation", y="P3") +
#   theme(strip.background = element_blank(),strip.text.x = element_blank())

df_275425_cz_long$Value <- case_match(df_275425_cz_long$Voting, "Like" ~ "High",
                                                                "Dislike" ~ "Low")
# Line plot
# plot_275425_adi <- ggplot(df_275425_cz_long, aes(x=ADI_NATRANK_z, y=ERP, color=Feedback)) +
#   facet_wrap(~Value) +
#   geom_point(alpha = .3) +
#   geom_smooth(aes(group=Feedback), method = "lm") +
#   scale_color_manual(values = c("darkgreen", "red"), name = "Feedback") +
#   theme(strip.background = element_blank(), strip.text.x = element_blank()) +
#   geom_text(data = plot_275425_adi_t, size=4, aes(x = 0, y = 34, label = label)) +
#   theme_apa() +
#   labs(x="", y="P3") +
#   theme(axis.text.x=element_blank(),
#         legend.position = "none")
```

```{r, results='hide'}
adi_plots_nocov <- ggarrange(plot_150275_adi, plot_275425_adi,
          labels = c("A","B"),
          label.x = c(rep(.04,4)),
          label.y = c(rep(1,4)),
          common.legend = TRUE, legend = "bottom",
          ncol = 1, nrow = 2,
          align="v")
adi_plots_nocov <- annotate_figure(adi_plots_nocov, left=text_grob("Mean amplitude (µV)", color = "black", rot = 90, size=14))
adi_plots_nocov
```

```{r adi_covary, results='hide'}
# Demographic and symptom covariates
model_150275_adi_cov <- lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + Age + Sex + StressCT + StressTH + IDAS_depression + IDAS_anxiety + (1 | ID), data = filter(df_150275_cz_long_strain, Voting=="Like"))

model_275425_adi_cov <- lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + Age + Sex + StressCT + StressTH + IDAS_depression + IDAS_anxiety + (1 | ID) + (1 | site), data = filter(df_275425_cz_long_strain, Voting=="Like"))

# Deception covariate
df_150275_cz_long_rating <- full_join(df_150275_cz_long, df_150275_cz_rating, by="ID")
df_275425_cz_long_rating <- full_join(df_275425_cz_long, df_275425_cz_rating, by="ID")

model_150275_adi_dec <- lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + SP_debriefing_deceived + (1 | ID) + site.x, data = filter(df_150275_cz_long_rating, Voting=="Like"))

model_275425_adi_dec <- lmer(formula = ERP ~ Feedback*ADI_NATRANK_c + SP_debriefing_deceived + (1 | ID) + site.x, data = filter(df_275425_cz_long_rating, Voting=="Like"))
```

```{r over 18 to identify those with college addresses, eval=FALSE}
over_18_150275 <- df_150275_cz_long_strain %>%
  group_by(ID) %>%
  reframe(Age = mean(Age, na.rm=T),
          ADI = mean(ADI_NATRANK, na.rm=T),
          AA_AR = mean(AA_AR, na.rm=T)) %>%
  filter(Age >=18 & complete.cases(AA_AR))

over_18_275425 <- df_275425_cz_long_strain %>%
  group_by(ID) %>%
  reframe(Age = mean(Age, na.rm=T),
          ADI = mean(ADI_NATRANK, na.rm=T),
          AA_AR = mean(AA_AR, na.rm=T)) %>%
  filter(Age >=18 & complete.cases(AA_AR))

save(over_18_150275, file=here("../data/over_18_150275.RData"))
save(over_18_275425, file=here("../data/over_18_275425.RData"))
```

We found support for aim 1; SES (operationalized as national US area deprivation index percentile) was significantly related to brain responses to different kinds of peer feedback (see Figure .\\ref{adi_addi_plots_nocov}).
Specifically, the SES x Feedback type interaction was significant for the RewP (`r plot_stats(model_150275_cz_high, "Feedback1:ADI_NATRANK_z")`), indicating that higher SES adolescents showed greater differentiation between acceptance and rejection compared to lower SES adolescents (who at -1 standard deviation showed very little difference between acceptance and rejection).
On the other hand, this interaction was trending for the P300 (`r plot_stats(model_275425_cz_high, "Feedback1:ADI_NATRANK_z")`), showing the opposite direction: higher SES adolescents showed less differentiation between acceptance and rejection compared to lower SES adolescents (who at -1 standard deviation showed greater responses to rejection than acceptance).
Of note, no SES x Feedback type interactions were significant for feedback from low value peers.
Results were consistent when covarying for demographic factors (e.g., age, sex assigned at birth) and stressors/symptoms (total stressful life events, severity of stressful life events, self-reported depression, self-reported anxiety), and whether or not adolescents reported being deceived.

<!--# Technically the P300xADI interaction is significant when controlling for deception, but it's at p=0.048 so I didnt think it made sense to refer to it as an inconsistency. -->

## Feedback x SES predicting negative affect

```{r}
# Pairwise vs listwise deletion issues
df_275425_missing_na <- df_275425_cz_ema %>%
  group_by(ID, daysFrom) %>%
  reframe(all_na = all(is.na(na)),
          adi_na = all(is.na(ADI_NATRANK_log)),
          erp_na = all(is.na(AA_AR))) %>%
  group_by(ID, daysFrom) %>%
  reframe(all_missing = all(is.na(c(all_na,adi_na,erp_na)))) %>%
  arrange(desc(all_missing))

# Multiple entries per slot issues: select the first entry

# test <- df_150275_cz_ema %>%
#   filter(tm_taken<500) %>%
#   group_by(ID,daysFrom,slot) %>%
#   summarise(nsurveys = length(sad)) %>%
#   filter(nsurveys>1) %>%
#   left_join(df_150275_cz_ema, by=c("ID","daysFrom","slot")) %>%
  # select(c(ID,daysFrom,slot,nsurveys,tm_start:future))

df_150275_cz_ema <- df_150275_cz_ema %>%
  group_by(ID,daysFrom,slot) %>%
  arrange(tm_start) %>%
  filter(row_number()==1) %>%
  arrange(ID,daysFrom,tm_start)

df_275425_cz_ema <- df_275425_cz_ema %>%
  group_by(ID,daysFrom,slot) %>%
  arrange(tm_start) %>%
  filter(row_number()==1) %>%
  arrange(ID,daysFrom,tm_start)

df_50150_cz_ema$na_cubert <- df_50150_cz_ema$na^(1/3)
df_150275_cz_ema$na_cubert <- df_150275_cz_ema$na^(1/3)
df_275425_cz_ema$na_cubert <- df_275425_cz_ema$na^(1/3)
```

### SES and discrimination distress predicting negative affect

```{r, include=FALSE}
summary(glmmTMB(addi_total ~ ADI_NATRANK_c,
                    zi = ~ ADI_NATRANK_c,
    data = df_150275_cz_ema,
    family=gaussian, REML=TRUE))

ggplot(df_150275_cz_ema, aes(x=addi_total_z, y= ADI_NATRANK_c)) +
  geom_point() +
  stat_smooth(method="lm")

model_adi_na <- glmmTMB(na_cubert ~ ADI_NATRANK_c + (1 | ID) + (1 | site),
                    zi = ~ ADI_NATRANK_c + (1 | ID) + (1 | site),
    data = df_150275_cz_ema,
    family=gaussian, REML=TRUE)

model_addi_na <- glmmTMB(na_cubert ~ addi_total_z + (1 | ID) + (1 | site),
                    zi = ~ addi_total_z + (1 | ID) + (1 | site),
    data = df_150275_cz_ema,
    family=gaussian, REML=TRUE)

# check_model(glmmTMB(na_cubert ~ addi_total_z + (1 | ID) + (1 | site),
#                     zi = ~ addi_total_z + (1 | ID) + (1 | site),
#     data = df_150275_cz_ema,
#     family=gaussian, REML=TRUE))
# 
# hist(residuals(glmmTMB(na_cubert ~ addi_total_z + (1 | ID) + (1 | site),
#                     zi = ~ addi_total_z + (1 | ID) + (1 | site),
#     data = df_150275_cz_ema,
#     family=gaussian, REML=TRUE)))

ggplot(df_150275_cz_ema, aes(y=na_cubert, x=addi_total_z)) +
  geom_point() +
  stat_smooth(method=lm) +
  labs(x="ADDI", y="Negative affect (cubed root)")
```

### SES x RewP and P300 predicting negative affect

```{r}
model_150275_ema_na <- glmmTMB(na_cubert ~ ADI_NATRANK_c*AA_AR_c + (1 | ID) + (1 | site),
                    zi = ~ ADI_NATRANK_c*AA_AR_c + (1 | ID) + (1 | site),
    data = df_150275_cz_ema,
    family=gaussian, REML=TRUE, na.action=na.exclude)

model_275425_ema_na <- glmmTMB(na_cubert ~ ADI_NATRANK_c*AA_AR_c + (1 | ID) + (1 | site),
                    zi = ~ ADI_NATRANK_c*AA_AR_c + (1 | ID) + (1 | site),
    data = df_275425_cz_ema,
    family=gaussian, REML=TRUE, na.action=na.exclude)
# glmmTMB:::Anova.glmmTMB(model_275425_ema_na)

model_275425_ema_na_AR <- glmmTMB(na_cubert ~ ADI_NATRANK_c*AR_AA_c + (1 | ID) + (1 | site),
                    zi = ~ ADI_NATRANK_c*AR_AA_c + (1 | ID) + (1 | site),
    data = df_275425_cz_ema,
    family=gaussian, REML=TRUE, na.action=na.exclude)
# glmmTMB:::Anova.glmmTMB(model_275425_ema_na_AR)

plot_150275_adi_na <- ggpredict(model_150275_ema_na, terms = c("AA_AR_c","ADI_NATRANK_c")) %>% 
  plot(colors = "bw") + 
  theme_apa() +
  labs(x="Mean activity (µV)", y="Negative affect (cubed root)", linetype="ADI", title="") +
  scale_linetype_discrete(labels=c('-SD', 'Mean', '+SD'))

plot_275425_i_na <- ggpredict(model_275425_ema_na, terms = c("AA_AR_c","ADI_NATRANK_c")) %>% 
  plot(colors = "bw") + 
  theme_apa() +
  labs(x="Mean activity (µV)", y="Negative affect (cubed root)", linetype="ADI", title="") +
  scale_linetype_discrete(labels=c('-SD', 'Mean', '+SD'))

# ggpredict(model_275425_ema_na_AR, terms = c("AR_AA_c","ADI_NATRANK_c")) %>% 
#  plot(colors = "bw") + 
#  theme_apa() +
#  labs(x="Mean activity (µV)", y="Negative affect (cubed root)", linetype="ADI", title="") +
#  scale_linetype_discrete(labels=c('-SD', 'Mean', '+SD'))
```

```{r}
# check_model(model_150275_ema_na)
# check_model(model_275425_ema_na)

adi_plots_na <- ggarrange(plot_150275_adi_na, plot_275425_adi_na,
          labels = c("A","B"),
          label.x = c(rep(.04,4)),
          label.y = c(rep(1,4)),
          common.legend = FALSE, legend = "top",
          ncol = 2, nrow = 1,
          align="v")
adi_plots_na <- annotate_figure(adi_plots_na, bottom=text_grob("Mean activity (µV)", color = "black", size=14))
adi_plots_na
```

```{r}
model_275425_ema_na_cov <- glmmTMB(na_cubert ~ ADI_NATRANK_c*AA_AR_c + 
                                     Age + Sex + StressCT + StressTH + IDAS_depression +IDAS_anxiety +
                                     (1 | ID) + (1 | site),
                    zi = ~ ADI_NATRANK_c*AA_AR_c + site + (1 | ID),
    data = df_275425_cz_ema,
    family=gaussian, REML=TRUE)

df_275425_cz_ema_rating <- df_275425_cz_ema %>%
    select(-site) %>%
  full_join(df_BUDS_rating_it_pt, by="ID", relationship = "many-to-many")

model_275425_ema_na_dec <- glmmTMB(na_cubert ~ ADI_NATRANK_c*AA_AR_c + SP_debriefing_deceived + (1 | ID) + (1 | site),
                    zi = ~ ADI_NATRANK_c*AA_AR_c + site + (1 | ID),
    data = df_275425_cz_ema_rating,
    family=gaussian, REML=TRUE)
```

Findings support hypotheses in aim 2 for the P300 but not for the RewP ERP component.
SES did not moderate the relationship between RewP brain activity and mean negative affect over the following week; however SES did significantly moderate the association between P300 brain activity and mean negative affect over the following week (see Figure \##).
Moreover, these effects remained significant when covarying for age, sex assigned at birth, stress life event frequency and severity, and self-reported anxiety and depression; they also remained significant when covarying for deception (see Supplement).

```{r}
mean_ses <- mean(df_275425_cz_ema$ADI_NATRANK_c, na.rm=TRUE)
sd_ses <- sd(df_275425_cz_ema$ADI_NATRANK_c, na.rm=TRUE)
SESa <- mean_ses + sd_ses
SESb <- mean_ses - sd_ses
SES_list <- list(ADI_NATRANK_c=round(c(SESa,SESb),2)) 

######## REJ > ACC ######## 
m_rej <- glmmTMB(na_cubert ~ ADI_NATRANK_c*AR_AA_c + (1 | ID) + (1 | site),
                    zi = ~ ADI_NATRANK_c*AR_AA_c + (1 | ID) + (1 | site),
    data = df_275425_cz_ema,
    family=gaussian, REML=TRUE, na.action=na.exclude)

adi_ss_rej <- emtrends(m_rej, pairwise ~ADI_NATRANK_c, var="AR_AA_c",at=SES_list, adjust="none")|> test()

interact_plot(m_rej,
    data = df_275425_cz_ema,
    pred = AR_AA_c, modx = ADI_NATRANK_c, plot.points = TRUE,
              modx.values = c(round(mean_ses-sd_ses,0),round(mean_ses+sd_ses,0)),
    point.alpha = 0.2, colors="CUD Bright")

# plot(ggeffects::johnson_neyman(ggpredict(glmmTMB(na_cubert ~ ADI_NATRANK_c*AR_AA_c + (1 | ID) + (1 | site),
#                     zi = ~ ADI_NATRANK_c*AR_AA_c + (1 | ID) + (1 | site),
#                     data = df_275425_cz_ema,
#                     family=gaussian, REML=FALSE, na.action=na.exclude),
#     terms = c("AR_AA_c","ADI_NATRANK_c")),
#     vcov = sandwich::vcovHC))



######## ACC > REJ ######## 
m_acc <- glmmTMB(na_cubert ~ ADI_NATRANK_c*AA_AR_c + (1 | ID) + (1 | site),
                    zi = ~ ADI_NATRANK_c*AA_AR_c + (1 | ID) + (1 | site),
    data = df_275425_cz_ema,
    family=gaussian, REML=TRUE, na.action=na.exclude)

adi_ss_acc <- emtrends(m_acc, pairwise ~ADI_NATRANK_c, var="AA_AR_c",at=SES_list, adjust="none")|> test()
```

Follow-up simple slope analyses show additionally that lower SES adolescents show a negative relationship between P300 responses to acceptance and negative affect.
However, because prior analyses suggest that lower SES youth demonstrate an enhanced P300 to rejection relative to acceptance, we further interrogated this finding.
When a residualized score was calculated for ERP brain responses to rejection (relative to acceptance), we found, consistent with the prior finding, that lower SES adolescents show a positive relationship between P300 responses to rejection and subsequent negative affect.
That is, youth with lower SES show a potential, specific vulnerability to heightened rejection sensitivity leading to greater negative affect.ADDI x ERP predicting NA

```{r}
model_150275_addi_na <- glmmTMB(na_cubert ~ addi_total_z*AA_AR_c + (1 | ID) + (1 | site),
                    zi = ~ addi_total_z*AA_AR_c + (1 | ID) + (1 | site),
    data = df_150275_cz_ema,
    family=gaussian, REML=TRUE, na.action=na.exclude)

model_275425_addi_na <- glmmTMB(na_cubert ~ addi_total_z*AA_AR_c + (1 | ID) + (1 | site),
                    zi = ~ addi_total_z*AA_AR_c + (1 | ID) + (1 | site),
    data = df_275425_cz_ema,
    family=gaussian, REML=TRUE, na.action=na.exclude)

plot_150275_addi_na <- ggpredict(model_150275_addi_na, terms = c("addi_total_z","AA_AR_c")) %>% 
  plot(colors = "bw") + 
  theme_apa() +
  labs(x="ADDI", y="Negative affect (cubed root)", linetype="RewP", title="") +
  scale_linetype_discrete(labels=c('-SD', 'Mean', '+SD'))

plot_275425_addi_na <- ggpredict(model_275425_addi_na, terms = c("addi_total_z","AA_AR_c")) %>% 
  plot(colors = "bw") + 
  theme_apa() +
  labs(x="ADDI", y="Negative affect (cubed root)", linetype="P3", title="") +
  scale_linetype_discrete(labels=c('-SD', 'Mean', '+SD'))
```

## Discrimination distress

```{r}
paste0("N = ",sum(complete.cases(df_150275_cz$AA_AR) & complete.cases(df_150275_cz$addi_total_z)))

# summary(lm(ADI_NATRANK_c ~ addi_total_z,df_150275_cz))
# summary(lm(ADI_NATRANK_c ~ addi_total_z,df_150275_cz))
```

```{r}
model_150275_cz_addi <- lmer(formula = ERP ~ Feedback*Voting*addi_total_z + site + (1 | ID), data = df_150275_cz_long)
model_150275_cz_addi_high <- lmer(formula = ERP ~ Feedback*addi_total_z + site + (1 | ID), data = filter(df_150275_cz_long,Voting=="Like"))
model_150275_cz_addi_low <- lmer(formula = ERP ~ Feedback*addi_total_z + site + (1 | ID), data = filter(df_150275_cz_long,Voting=="Dislike"))

model_150275_cz_addi_high_cov <- lmer(formula = ERP ~ Feedback*addi_total_z + Age + Sex + StressCT + StressTH + IDAS_depression + IDAS_anxiety + (1 | ID) + site, 
                                      data = filter(df_150275_cz_long_strain,Voting=="Like"))

# summary(lmer(formula = ERP ~ Feedback*addi_total_z + site + (1 | ID), data = filter(df_150275_cz_long,Voting=="Like")))
# summary(lmer(formula = ERP ~ Feedback*addi_educ + site + (1 | ID), data = filter(df_150275_cz_long,Voting=="Like"))) #*
# summary(lmer(formula = ERP ~ Feedback*addi_instit + site + (1 | ID), data = filter(df_150275_cz_long,Voting=="Like")))
# summary(lmer(formula = ERP ~ Feedback*addi_peer + site + (1 | ID), data = filter(df_150275_cz_long,Voting=="Like")))
# summary(lmer(formula = ERP ~ Feedback*addi_total_no6 + site + (1 | ID), data = filter(df_150275_cz_long,Voting=="Like")))

model_150275_addi <- plot_cap(
    model_150275_cz_addi,
    condition = list(
      "addi_total_z" = "threenum",
        "Feedback",
        "Voting"),
    draw=FALSE) %>%
    mutate(Value = case_match(Voting, "Dislike" ~ "Low",
                                    "Like" ~ "High"),
         Feedback = case_match(Feedback, "Acc" ~ "Acceptance",
                                    "Rej" ~ "Rejection"))

plot_150275_addi_t <- data.frame(
  label = c(plot_stats(model_150275_cz_addi_high, "Feedback1:addi_total_z"),
            plot_stats(model_150275_cz_addi_low, "Feedback1:addi_total_z")), 
  Value  = c("High", "Low"),
  Feedback=c("Acc","Rej"))

plot_150275_addi <- ggplot(filter(model_150275_addi, addi_total_z!="Mean"), aes(x=addi_total_z, y=estimate, fill=Feedback)) +
  geom_bar(position = "dodge", stat = "identity", colour="black") +
  geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = c("darkgreen", "red"), name = "Feedback") +
  facet_wrap(~Value) +
  geom_text(data = data.frame(
  label = c(plot_stats(model_150275_cz_addi_high, "Feedback1:addi_total_z"),
            plot_stats(model_150275_cz_addi_low, "Feedback1:addi_total_z")),
  Value  = c("High", "Low"),
  Feedback=c("Acceptance","Rejection")), aes(x = 1.5, y = 10, label = label)) +
  theme_apa() +
  labs(x="Discrimination", y="RewP") +
  theme(strip.background = element_blank(),axis.title.x=element_blank())

# Bar plot black and white
# plot_150275_addi <- ggplot(model_150275_addi, aes(x=addi_total_z, y=estimate, fill=Feedback)) +
#   geom_bar(position = "dodge", stat = "identity", colour="black") +
#   geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.2, position=position_dodge(.9)) +
#   scale_fill_manual(values = c("gray", "white"), name = "Feedback") +
#   facet_wrap(~Value) +
#   geom_text(data = data.frame(
#   label = c(plot_stats(model_150275_cz_addi_high, "Feedback1:addi_total_z"),
#             plot_stats(model_150275_cz_addi_low, "Feedback1:addi_total_z")),
#   Value  = c("High", "Low"),
#   Feedback=c("Acceptance","Rejection")),
#             aes(x = 2, y = 10, label = label)) +
#   theme_apa() +
#   labs(x="", y="RewP") +
#   theme(axis.text.x=element_blank())


# plot_150275_addi <- ggplot(df_150275_cz_long, aes(x=addi_total_z, y=ERP, color=Feedback)) +
#   facet_wrap(~Value) +
#   geom_point(alpha = .3) +
#   geom_smooth(aes(group=Feedback), method = "lm") +
#   scale_color_manual(values = c("darkgreen", "red"), name = "Feedback") +
#   theme(strip.background = element_blank(), strip.text.x = element_blank()) +
#   # geom_text(data = plot_150275_addi_t, size=4, aes(x = 2, y = 34, label = label)) +
#   theme_apa() +
#   labs(x="", y="RewP") +
#   theme(axis.text.x=element_blank(),
#         legend.position = "none")
```

```{r}
model_275425_cz_addi_cov <- lmer(formula = ERP ~ Feedback*Voting*addi_total_z + (1 | ID) + (1 | site), data = df_275425_cz_long)
model_275425_cz_addi_high <- lmer(formula = ERP ~ Feedback*addi_total_z + (1 | ID) + (1 | site), data = filter(df_275425_cz_long,Voting=="Like"))
model_275425_cz_addi_low <- lmer(formula = ERP ~ Feedback*addi_total_z + (1 | ID) + (1 | site), data = filter(df_275425_cz_long,Voting=="Dislike"))

model_275425_cz_addi_high_cov <- lmer(formula = ERP ~ Feedback*addi_total_z + Age + Sex + StressCT + StressTH + IDAS_depression + IDAS_anxiety + (1 | ID) + (1 | site), 
                                      data = filter(df_275425_cz_long_strain,Voting=="Like"))

model_275425_cz_addi_high_dec <- lmer(formula = ERP ~ Feedback*addi_total_z + SP_debriefing_deceived + (1 | site.x) + (1 | ID), data = filter(df_275425_cz_long_rating,Voting=="Like"))

# df_275425_cz_ema_rating

# summary(lmer(formula = ERP ~ Feedback*addi_total_z + site + (1 | ID), data = filter(df_275425_cz_long,Voting=="Like"))) #*
# summary(lmer(formula = ERP ~ Feedback*addi_educ + site + (1 | ID), data = filter(df_275425_cz_long,Voting=="Like"))) #*
# summary(lmer(formula = ERP ~ Feedback*addi_instit + site + (1 | ID), data = filter(df_275425_cz_long,Voting=="Like")))
# summary(lmer(formula = ERP ~ Feedback*addi_peer + site + (1 | ID), data = filter(df_275425_cz_long,Voting=="Like"))) #~
# summary(lmer(formula = ERP ~ Feedback*addi_total_no6 + site + (1 | ID), data = filter(df_275425_cz_long,Voting=="Like")))

model_275425_addi <- plot_cap(
    model_275425_cz_addi,
    condition = list(
      "addi_total_z" = "threenum",
        "Feedback",
        "Voting"),
    draw=FALSE) %>%
    mutate(Value = case_match(Voting, "Dislike" ~ "Low",
                                    "Like" ~ "High"),
         Feedback = case_match(Feedback, "Acc" ~ "Acceptance",
                                    "Rej" ~ "Rejection"))

plot_275425_addi_cov <- plot_cap(
    model_275425_cz_addi_high,
    condition = list(
      "addi_total_z" = "threenum",
        "Feedback"),
    draw=FALSE) %>%
    mutate(Feedback = case_match(Feedback, "Acc" ~ "Acceptance",
                                    "Rej" ~ "Rejection"))

plot_275425_addi_t <- data.frame(
  label = c(plot_stats(model_275425_cz_addi_high, "Feedback1:addi_total_z"),
            plot_stats(model_275425_cz_addi_low, "Feedback1:addi_total_z")), 
  Value  = c("High", "Low"),
  Feedback=c("Acc","Rej"))

plot_275425_addi <- ggplot(filter(model_275425_addi, addi_total_z!="Mean"), aes(x=addi_total_z, y=estimate, fill=Feedback)) +
  geom_bar(position = "dodge", stat = "identity", colour="black") +
  geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = c("darkgreen", "red"), name = "Feedback") +
  facet_wrap(~Value) +
  geom_text(data = data.frame(
  label = c(plot_stats(model_275425_cz_addi_high, "Feedback1:addi_total_z"),
            plot_stats(model_275425_cz_addi_low, "Feedback1:addi_total_z")),
  Value  = c("High", "Low"),
  Feedback=c("Acceptance","Rejection")), aes(x = 1.5, y = 12, label = label)) +
  theme_apa() +
  labs(x="Self-reported \ndiscrimination distress", y="RewP") +
  theme(strip.background = element_blank())

ggplot(filter(plot_275425_addi_cov, addi_total_z!="Mean"), aes(x=addi_total_z, y=estimate, fill=Feedback)) +
  geom_bar(position = "dodge", stat = "identity", colour="black") +
  geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.2, position=position_dodge(.9)) +
  scale_fill_manual(values = c("darkgreen", "red"), name = "Feedback") +
  theme_apa() +
  labs(x="Self-reported \ndiscrimination distress", y="P300") +
  theme(strip.background = element_blank())

# Black and white bar plots
# plot_275425_addi <- ggplot(model_275425_addi, aes(x=addi_total_z, y=estimate, fill=Feedback)) +
#   geom_bar(position = "dodge", stat = "identity", colour="black") +
#   geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.2, position=position_dodge(.9)) +
#   scale_fill_manual(values = c("gray", "white"), name = "Feedback") +
#   facet_wrap(~Value) +
#   geom_text(data = data.frame(
#   label = c(plot_stats(model_275425_cz_addi_high, "Feedback1:addi_total_z"),
#             plot_stats(model_275425_cz_addi_low, "Feedback1:addi_total_z")), 
#   Value  = c("High", "Low"),
#   Feedback=c("Acceptance","Rejection")), 
#             aes(x = 2, y = 11, label = label)) +
#   theme_apa() +
#   labs(x="Self-reported discrimination", y="P3") +
#   theme(strip.background = element_blank(), strip.text.x = element_blank())

# plot_275425_addi <- ggplot(df_275425_cz_long, aes(x=addi_total_z, y=ERP, color=Feedback)) +
#   facet_wrap(~Value) +
#   geom_point(alpha = .3) +
#   geom_smooth(aes(group=Feedback), method = "lm") +
#   scale_color_manual(values = c("darkgreen", "red"), name = "Feedback") +
#   theme(strip.background = element_blank(), strip.text.x = element_blank()) +
#   geom_text(data = plot_275425_addi_t, size=4, aes(x = 2, y = 34, label = label)) +
#   theme_apa() +
#   labs(x="", y="P3") +
#   theme(axis.text.x=element_blank(),
#         legend.position = "none")
```

```{r}
addi_plots_nocov <- ggarrange(plot_150275_addi, plot_275425_addi,
          labels = c("A","B"),
          label.x = c(rep(.04,4)),
          label.y = c(rep(1,4)),
          common.legend = TRUE, legend = "bottom",
          ncol = 1, nrow = 2,
          align="v")
addi_plots_nocov <- annotate_figure(addi_plots_nocov, left=text_grob("Mean amplitude (µV)", color = "black", rot = 90, size=14))
addi_plots_nocov
```

```{r adi_addi_plots_nocov}
adi_addi_plots_nocov <- ggarrange(plot_150275_adi, 
                                  plot_150275_addi+labs(x="", y=""),
                                  plot_275425_adi+labs(x="ADI", y="P3"), 
                                  plot_275425_addi+labs(x="Self-reported discrimination", y=""),
          labels = c("A1","A2","B1","B2"),
          label.x = c(rep(.04,4)),
          label.y = c(rep(1,4)),
          common.legend = TRUE, legend = "bottom",
          ncol = 2, nrow = 2,
          align="v")
adi_addi_plots_nocov <- annotate_figure(adi_addi_plots_nocov, left=text_grob("Mean amplitude (µV)", color = "black", rot = 90, size=14))
adi_addi_plots_nocov
```

We found partial support for hypotheses of aim 3.
For this aim we examined the same effects using discrimination in lieu of SES.
Self-report discrimination distress was significantly related to to brain responses to different kinds of peer feedback (see Figure .\\ref{adi_addi_plots_nocov}).
Specifically, the Discrimination distress x Feedback type interaction was not significant for the RewP (`r plot_stats(model_150275_cz_addi_high, "Feedback1:addi_total_z")`), but was significant for the P300 (`r plot_stats(model_275425_cz_addi_high, "Feedback1:addi_total_z")`): adolescents who had experienced less discrimination distress showed less differentiation between acceptance and rejection compared to adolescents who had experienced greater discrimination distress (who at -1 standard deviation showed greater responses to rejection than acceptance).

This finding is identical to the finding for SES (albeit this effect is significant at p\<0.05, while the interaction between SES and P300 was at trend levels [0.05\<p\<0.10]).
Moreover, as we found with SES, no SES x Feedback type interactions were significant for feedback from low value peers.
Results were consistent when covarying for demographic factors (e.g., age, sex assigned at birth) and stressors/symptoms (total stressful life events, severity of stressful life events, self-reported depression, self-reported anxiety), and when covarying for deception except in one case: when demographic and stressor/symptoms covariates were included, the model for the RewP indicated a significant relationship, whereby adolescents with less discrimination distress showed greater differentiation between acceptance and rejection compared to adolescents with greater discrimination distress.

# Discussion

These findings also begin to answer questions about why area deprivation or socioeconomic status more broadly are risk factors for psychopathology.
These findings support one theory: that area deprivation increases stressors, particularly being discriminated against, which in turn may lead to reduced hedonic responses to peer acceptance and heightened responses to peer rejection.
Youth in deprived areas are more likely to be subjected to structural discrimination targeting racial and ethnic minorities and those in poverty.
Although the STRAIN and other commonly used measures of stress life events account for some stressful life experiences, recent work suggests that they do not capture the effects of racism [@bernardMakingCACECulturallyInformed2021].In fact, research on prejudice highlights that ...(see Amodio, 2014 (NATURE)).

At a group level, we have shown that an fMRI task of neural responses to social feedback--the Chatroom task (Guyer; Pagliaccio)--yields the expected ERP components: primarily a RewP and P300.
These components have acceptable internal consistency and reliability.
Furthermore, these components have been identified in other studies of social feedback (CITE ME, AUTUMN, ANNA).
As we found in our study, these studies have also found that whereas the RewP significantly differs between acceptance and rejection, the P3 does not.
However, unlike previous studies, we examined whether these neural signals may differ depending on youths' area deprivation.
The finding that these waveforms do in fact differ highlights the importance of studies regularly examining such interactions.

Adolescents living in areas of high deprivation demonstrate patterns of neural activity consistent with those observed in depressed and anxious youth (CITE).
That is, depressed youth often exhibit a blunted response to social acceptance, and anxious youth a heightened response to social rejection (though see XX for an example of social anxiety being related to **enhanced** response to social acceptance too).
Moreover, this pattern was replicated for self-report discrimination, with those with experiences of discrimination showing ... Together, these findings suggest that heightened ...

This is in line with findings that those in areas of greater deprivation experience more discrimination (CITE).
Another possibility that area deprivation is tied to more frequent and/or more severe daily stressors.
Such stressor may not be picked up on in the STRAIN unless they are associated with other major life events (e.g., moving homes).
However, they may contribute to risk for psychopathology (CITE).

Although it remains unclear what specific aspects of SES contribute to abberant brain responses to peer feedback, and the resulting psychopathology, there is reason to believe that harmful discriminatory experiences are specifically driving risk for psychopathology.
Lower perceived social status and traumatic stressful events are related to psychiatric disorders over-and-above objective measures of SES [@mclaughlinSocioeconomicStatusAdolescent2012; @gurBurdenEnvironmentalAdversity2019].
Moreover, other experiences with rejection, such as peer victimization (i.e., bullying) has been tied to blunted responses to peer acceptance [@rappaportPeerVictimizationDysfunctional2019].
Therefore, hostile and/or rejecting experiences early in life may lead to children becoming, understandably, sensitive to perceived rejection and skeptical of acceptance.

The behavioral main effect, contrasted with the primary ERP effect, suggests that the interaction between ADI and social processing may be more implicit than explicit.
While we found an interaction between area deprivation and brain responses to social feedback, we did not find one with behavioral responses to social feedback (i.e., behavioral ratings)--all subjects uniformly rated feeling better after being accepted and worse after being rejected (by high-value peers).

Of note, for low-value peers, participants rated being rejected as feeling better than being accepted.
Although seemingly counter-intuitive, previous work suggests that this is the result of participants feeling good that they were "right"--that they rejected the person who rejected them--and felt guilty when they were "wrong"--rejected someone who accepted them [@distefanoComparisonElectrocorticalResponse2018].

The current study must be considered in light of its limitations, as well as its strengths.
First,... • P3 positively assessing with NA at low levels of ADI • We are not capturing other areas where they go (e.g., for school, socializing, after school activities) • Possibility that these tasks are biased • Version of Chatroom centered on discrimination feedback may be especially useful in measuring this

There are numerous potential theoretical explanations for how ADI and discrimination experiences lead to worsened depression and anxiety symptoms via heightened rejection sensitivity.
One is simply that experiences of discrimination leave youth more adaptively sensitive to rejections from others, which in turn leads to heightened threat sensitivity, a precusor of anxiety disorders (CITE).
Another is that such sensitivity leads to fewer prosocial and potentially more aggressive behaviors [e.g., rejecting others, @quarmleyTestingEffectsSocial2022; @rappaportPeerVictimizationDysfunctional2019].
Finally, a third possibility is that...

These findings highlight and emphasize other results such as ....

Clinically, results suggest that discrimination-focused interventions may reduce subsequent psychopathology.
For example, interventions focused on reducing instances of discrimination (e.g., implicit bias training [CITE]), as well as helping youth heal from racial trauma (e.g., \_\_\_ [CITE]).

```         
    • "Not people's race but the experiences they have as a consequence of their race"
    • Cultural different perspectives on psychopathology
        • Depression may manifest as anger rather than sadness
```

In the future, studies developing novel neuroimaging and psychophysiological tasks to be used as an individual difference measure should also collect data related to participants' background, including their socioeconomic status and/or area deprivation.
More and more studies are finding that such aspects moderate findings [@correaEthnicDifferencesBehavioral2022].
Given that SES and ADI are established risk factors for psychopathology, accounting for them in analyses will help assure that findings examining neural mechanisms of psychopathology are not influenced by a large potential third-variable.

\newpage

# References

::: {#refs custom-style="Bibliography"}
:::
